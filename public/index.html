<!DOCTYPE html>
<html lang="th" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>PPE Stock – Dashboard 2025</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // คงไว้ใน <head> เพื่อให้ Tailwind รับ config ก่อนใช้งาน
      tailwind.config = {
        darkMode: 'class',
      }
    </script>

    <!-- Font & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Styles (ย้าย CSS ทั้งหมดมาไว้ที่ไฟล์นี้) -->
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body class="min-h-screen bg-slate-100 text-slate-900 dark:bg-slate-900 dark:text-slate-50">
    <!-- Loading Overlay -->
    <div
      id="loadingOverlay"
      class="fixed inset-0 z-[999] hidden bg-slate-950/60 backdrop flex items-center justify-center"
    >
      <div class="flex flex-col items-center gap-3">
        <div class="h-12 w-12 rounded-full border-4 border-teal-400 border-t-transparent animate-spin"></div>
        <p class="text-sm text-slate-100">กำลังประมวลผล...</p>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="fixed top-5 right-5 z-[998] space-y-3"></div>

    <div class="flex min-h-screen">
      <!-- LEFT SIDEBAR -->
      <aside class="hidden lg:flex lg:flex-col w-64 bg-slate-950/40 border-r border-slate-800 backdrop-blur-md">
        <div class="flex items-center gap-3 px-5 h-16 border-b border-slate-800">
          <img
            src="/logo.png"
            alt="Logo"
            class="h-10 w-10 rounded-full object-cover bg-slate-900"
            onerror="this.style.display='none'"
          />
          <div>
            <p class="text-sm text-slate-200 font-semibold">PPE Stock</p>
            <p class="text-xs text-slate-400">Safety & Warehouse</p>
          </div>
        </div>

        <nav class="flex-1 px-3 py-5 space-y-1">
          <button
            onclick="showPage('dashboard')"
            class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
          >
            <i class="fa-solid fa-grip"></i>
            แดชบอร์ด
          </button>
          <button
            onclick="showPage('stock')"
            class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
          >
            <i class="fa-solid fa-boxes-stacked w-5 text-center"></i>
            สต็อกทั้งหมด
          </button>
          <button
            onclick="showPage('issue')"
            class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
          >
            <i class="fa-solid fa-file-circle-plus w-5 text-center"></i>
            สร้างใบเบิก
          </button>
          <button
            onclick="showPage('loan')"
            class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
          >
            <i class="fa-solid fa-hand-holding-hand w-5 text-center"></i>
            ยืม-คืน
          </button>
          <button
            onclick="showPage('allHistory')"
            class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
          >
            <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i>
            ประวัติทั้งหมด
          </button>

          <!-- admin -->
          <div id="adminMenu" class="hidden pt-4 mt-4 border-t border-slate-800">
            <p class="px-3 text-xs uppercase text-slate-500 mb-2 tracking-wide">Admin</p>
            <button
              onclick="showPage('pending')"
              class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
            >
              <i class="fa-solid fa-hourglass-half w-5 text-center"></i>
              รออนุมัติ
            </button>
            <button
              onclick="showPage('manage')"
              class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
            >
              <i class="fa-solid fa-screwdriver-wrench w-5 text-center"></i>
              จัดการอุปกรณ์
            </button>
            <button
              onclick="showPage('receive')"
              class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-slate-200 hover:bg-teal-500/10 hover:text-white transition"
            >
              <i class="fa-solid fa-truck-ramp-box w-5 text-center"></i>
              รับของเข้าสต็อก
            </button>
          </div>
        </nav>

        <div class="p-3 border-t border-slate-800">
          <div id="loginSection">
            <button
              onclick="showLoginModal()"
              class="w-full bg-teal-500 hover:bg-teal-400 text-white rounded-xl py-2 text-sm font-medium flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-right-to-bracket text-sm"></i>
              เข้าสู่ระบบ Admin
            </button>
          </div>
          <div id="logoutSection" class="hidden space-y-2">
            <p class="text-xs text-slate-400">
              เข้าระบบในชื่อ <span class="font-semibold text-slate-100">Admin</span>
            </p>
            <button
              onclick="logout()"
              class="w-full bg-slate-800 hover:bg-slate-700 text-slate-100 rounded-xl py-2 text-sm font-medium flex items-center justify-center gap-2"
            >
              <i class="fa-solid fa-right-from-bracket text-sm"></i>
              ออกจากระบบ
            </button>
          </div>
        </div>
      </aside>

      <!-- RIGHT SIDE: TOPBAR + PAGES -->
      <div class="flex-1 flex flex-col min-h-screen bg-slate-100 dark:bg-slate-900">
        <!-- TOP BAR -->
        <header class="h-16 flex items-center justify-between px-4 md:px-6 border-b border-slate-800 bg-slate-900/60 backdrop-blur">
          <div class="flex items-center gap-3 lg:hidden">
            <button
              class="p-2 rounded-lg bg-slate-800 text-slate-100"
              onclick="document.querySelector('aside').classList.toggle('hidden')"
            >
              <i class="fa-solid fa-bars"></i>
            </button>
            <p class="text-slate-100 font-semibold">PPE Stock</p>
          </div>

          <div class="hidden md:flex items-center gap-3 flex-1 max-w-md">
            <div class="relative w-full">
              <i class="fa-solid fa-magnifying-glass text-slate-500 absolute left-3 top-1/2 -translate-y-1/2 text-sm"></i>
              <input
                id="stockSearch"
                type="text"
                placeholder="ค้นหาอุปกรณ์ / หมวดหมู่ / ผู้เบิก ..."
                class="w-full bg-slate-800 border border-slate-700 rounded-xl pl-10 pr-3 py-2 text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-teal-500"
              />
            </div>
            <select
              id="categoryFilter"
              class="bg-slate-800 border border-slate-700 text-sm rounded-xl px-3 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-teal-500"
            >
              <option value="">ทุกหมวดหมู่</option>
            </select>
          </div>

          <div class="flex items-center gap-3">
            <button
              id="themeToggleBtn"
              class="h-9 w-9 rounded-full bg-slate-200 text-slate-800 dark:bg-slate-800 dark:text-slate-100 flex items-center justify-center"
              title="สลับธีม"
            >
              <i class="fa-solid fa-sun dark:hidden"></i>
              <i class="fa-solid fa-moon hidden dark:inline"></i>
            </button>

            <button
              onclick="initializeApp()"
              class="h-9 w-9 rounded-full bg-slate-800 flex items-center justify-center text-slate-200 hover:text-white"
              title="รีโหลดข้อมูล"
            >
              <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button
              onclick="showLoginModal()"
              id="loginSectionMobile"
              class="h-9 px-3 rounded-full bg-teal-500 text-white text-sm font-medium flex items-center gap-2 lg:hidden"
            >
              <i class="fa-solid fa-user-shield"></i>
              Admin
            </button>
            <button
              onclick="logout()"
              id="logoutSectionMobile"
              class="hidden h-9 px-3 rounded-full bg-slate-800 text-slate-200 text-sm font-medium lg:hidden"
            >
              <i class="fa-solid fa-right-from-bracket"></i>
            </button>
          </div>
        </header>

        <!-- CONTENT -->
        <main class="page-container flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
          <!-- DASHBOARD PAGE -->
          <section id="dashboardPage" class="page space-y-6">
            <!-- อันที่แสดงตอนโหลดข้อมูลเสร็จ -->
            <div id="dashboardContent" class="space-y-6">
              <!-- KPI BAR -->
              <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 auto-rows-fr">
                <div class="relative overflow-hidden bg-gradient-to-br from-teal-500 to-emerald-400 rounded-2xl p-4 shadow-md">
                  <p class="text-xs text-white/80">อุปกรณ์ทั้งหมด</p>
                  <p id="totalItems" class="text-3xl font-bold text-white mt-2">0</p>
                  <i class="fa-solid fa-boxes-stacked absolute -right-4 -bottom-2 text-7xl text-white/25"></i>
                </div>
                <div class="relative overflow-hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
                  <p class="text-xs text-slate-400">ใกล้หมดสต็อก</p>
                  <p id="lowStockItems" class="text-3xl font-bold text-amber-400 mt-2">0</p>
                  <p class="text-xs text-slate-500 mt-1">ควรเติมสต็อกเพื่อไม่ให้ขาด</p>
                  <i class="fa-solid fa-triangle-exclamation absolute -right-3 -bottom-2 text-6xl text-amber-500/10"></i>
                </div>
                <div class="relative overflow-hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
                  <p class="text-xs text-slate-400">ของหมด</p>
                  <p id="outOfStockItems" class="text-3xl font-bold text-red-400 mt-2">0</p>
                  <p class="text-xs text-slate-500 mt-1">ต้องจัดหาด่วน</p>
                  <i class="fa-solid fa-xmark-circle absolute -right-3 -bottom-2 text-6xl text-red-500/10"></i>
                </div>
                <div class="relative overflow-hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
                  <p class="text-xs text-slate-400">มูลค่าสต็อกรวม</p>
                  <p id="totalStockValue" class="text-2xl font-bold text-slate-100 mt-2">฿0.00</p>
                  <p class="text-xs text-slate-500 mt-1">ประมาณการตามราคาต่อหน่วย</p>
                  <i class="fa-solid fa-sack-dollar absolute -right-3 -bottom-2 text-6xl text-emerald-500/10"></i>
                </div>
              </div>

              <!-- 2 Column Layout -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- left -->
                <div class="lg:col-span-2 space-y-4">
                  <!-- action center -->
                  <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                      <h2 class="text-sm font-semibold text-slate-100">การดำเนินการด่วน</h2>
                      <p class="text-xs text-slate-500">เลือกเมนูที่ต้องการดำเนินการ</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                      <button onclick="showPage('issue')" class="flex flex-col gap-2 items-start bg-slate-800/50 border border-slate-700 hover:border-teal-500/80 rounded-xl p-3 transition">
                        <span class="h-8 w-8 rounded-lg bg-teal-500/10 text-teal-400 flex items-center justify-center"><i class="fa-solid fa-file-circle-plus"></i></span>
                        <p class="text-sm text-slate-100">สร้างใบเบิก</p>
                        <p class="text-[10px] text-slate-400">Issue voucher</p>
                      </button>
                      <button onclick="showPage('receive')" class="flex flex-col gap-2 items-start bg-slate-800/50 border border-slate-700 hover:border-teal-500/80 rounded-xl p-3 transition">
                        <span class="h-8 w-8 rounded-lg bg-emerald-500/10 text-emerald-400 flex items-center justify-center"><i class="fa-solid fa-truck-ramp-box"></i></span>
                        <p class="text-sm text-slate-100">รับของเข้า</p>
                        <p class="text-[10px] text-slate-400">Receive stock</p>
                      </button>
                      <button onclick="showPage('loan')" class="flex flex-col gap-2 items-start bg-slate-800/50 border border-slate-700 hover:border-teal-500/80 rounded-xl p-3 transition">
                        <span class="h-8 w-8 rounded-lg bg-sky-500/10 text-sky-400 flex items-center justify-center"><i class="fa-solid fa-arrows-left-right-to-line"></i></span>
                        <p class="text-sm text-slate-100">ยืม-คืน</p>
                        <p class="text-[10px] text-slate-400">Loan Management</p>
                      </button>
                      <button onclick="showPage('pending')" class="flex flex-col gap-2 items-start bg-slate-800/50 border border-slate-700 hover:border-teal-500/80 rounded-xl p-3 transition">
                        <span class="h-8 w-8 rounded-lg bg-amber-500/10 text-amber-300 flex items-center justify-center"><i class="fa-solid fa-hourglass-half"></i></span>
                        <p class="text-sm text-slate-100">รออนุมัติ</p>
                        <p class="text-[10px] text-slate-400">Admin only</p>
                      </button>
                    </div>
                  </div>

                  <!-- charts row -->
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
                      <h2 class="text-sm font-semibold text-slate-100 mb-3">สต็อกตามหมวดหมู่</h2>
                      <div class="h-52"><canvas id="categoryChart"></canvas></div>
                    </div>
                    <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
                      <h2 class="text-sm font-semibold text-slate-100 mb-3">อุปกรณ์ที่ถูกเบิกบ่อย</h2>
                      <div class="h-52"><canvas id="topIssuedItemsChart"></canvas></div>
                    </div>
                  </div>

                  <!-- history -->
                  <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
                    <h2 class="text-sm font-semibold text-slate-100 mb-3">กิจกรรมล่าสุด</h2>
                    <div id="recentActivityFeed" class="space-y-2 max-h-72 overflow-y-auto"></div>
                  </div>
                </div>

                <!-- right column -->
                <div class="space-y-4">
                  <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
                    <h2 class="text-sm font-semibold text-slate-100 mb-3">รายการใกล้หมด / ควรสั่งซื้อ</h2>
                    <div id="lowStockList" class="space-y-2"></div>
                  </div>
                  <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
                    <h2 class="text-sm font-semibold text-slate-100 mb-3">ยืมเกินกำหนด</h2>
                    <div id="overdueLoansList" class="space-y-2"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- อันที่แสดงตอนกำลังโหลด -->
            <div id="dashboardSkeleton" class="hidden">
              <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                <div class="h-24 bg-slate-800/60 rounded-2xl animate-pulse"></div>
                <div class="h-24 bg-slate-800/60 rounded-2xl animate-pulse"></div>
                <div class="h-24 bg-slate-800/60 rounded-2xl animate-pulse"></div>
                <div class="h-24 bg-slate-800/60 rounded-2xl animate-pulse"></div>
              </div>
            </div>
          </section>

          <section id="stockPage" class="page hidden">
            <div class="bg-slate-900/40 border border-slate-800 rounded-2xl overflow-hidden">
              <div class="p-4 border-b border-slate-800 flex items-center justify-between">
                <h3 class="text-sm font-semibold text-slate-100">รายการอุปกรณ์ PPE</h3>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-slate-900/60 text-left text-slate-300">
                    <tr>
                      <th class="px-6 py-3">รหัส</th>
                      <th class="px-6 py-3">ชื่ออุปกรณ์</th>
                      <th class="px-6 py-3">หมวดหมู่</th>
                      <th class="px-6 py-3">คงเหลือ</th>
                      <th class="px-6 py-3">กำลังยืม</th>
                      <th class="px-6 py-3">สถานะ</th>
                    </tr>
                  </thead>
                  <tbody id="stockTableBody" class="divide-y divide-slate-800"></tbody>
                </table>
                <div id="stockEmptyState" class="hidden"></div>
              </div>
            </div>
          </section>

          <!-- 1. สร้างใบเบิก -->
          <section id="issuePage" class="page hidden">
            <div class="p-4 md:p-6 space-y-4">
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-100">สร้างใบเบิก PPE</h2>
                <button type="button" onclick="addIssueItem()" class="px-3 py-1.5 rounded-lg bg-teal-500 text-white text-sm hover:bg-teal-600">
                  + เพิ่มรายการ
                </button>
              </div>

              <form id="issueForm" onsubmit="handleIssueSubmit(event)" class="space-y-4 bg-slate-900/40 border border-slate-800 rounded-2xl p-4">
                <div class="grid gap-4 md:grid-cols-2">
                  <div>
                    <label for="issueUser" class="text-xs text-slate-400">ชื่อผู้เบิก</label>
                    <input
                      id="issueUser"
                      class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100"
                      placeholder="เช่น สมชาย แผนกผลิต"
                      required
                    />
                  </div>
                  <div>
                    <label for="issueDepartment" class="text-xs text-slate-400">หน่วยงาน/แผนก</label>
                    <input
                      id="issueDepartment"
                      class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100"
                      placeholder="เช่น Production, SHE, QA"
                      required
                    />
                  </div>
                </div>

                <div id="issueItems" class="space-y-3"></div>

                <div class="flex items-center justify-between">
                  <p class="text-xs text-slate-500">เลือกอุปกรณ์จากสต็อกที่มีอยู่ ระบบจะตรวจสต็อกให้อัตโนมัติ</p>
                  <button type="submit" class="px-4 py-2 rounded-lg bg-teal-500 text-white text-sm hover:bg-teal-600">บันทึกใบเบิก</button>
                </div>
              </form>
            </div>
          </section>

          <!-- 2. ยืม - คืน -->
          <section id="loanPage" class="page hidden">
            <div class="p-4 md:p-6 space-y-6">
              <h2 class="text-lg font-semibold text-slate-100 mb-2">ยืมอุปกรณ์ / PPE</h2>

              <form id="loanForm" onsubmit="handleBorrowSubmit(event)" class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4 space-y-4">
                <div class="grid gap-4 md:grid-cols-2">
                  <div>
                    <label class="text-xs text-slate-400">อุปกรณ์ที่ยืม</label>
                    <select id="loanItem" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" required></select>
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">ผู้ยืม</label>
                    <input
                      id="borrowerName"
                      class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100"
                      placeholder="ชื่อ-สกุล / รหัสพนักงาน"
                      required
                    />
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">กำหนดคืน</label>
                    <input id="loanDueDate" type="date" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" required />
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">หมายเหตุ</label>
                    <input id="loanNotes" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" placeholder="เช่น ใช้ตรวจงาน, ใช้งานภายนอก" />
                  </div>
                </div>

                <div class="flex justify-end">
                  <button type="submit" class="px-4 py-2 rounded-lg bg-teal-500 text-white text-sm">บันทึกการยืม</button>
                </div>
              </form>

              <div class="bg-slate-900/40 border border-slate-800 rounded-2xl">
                <div class="p-4 border-b border-slate-800 flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-slate-100">รายการที่กำลังยืม</h3>
                </div>
                <div id="onLoanEmptyState" class="hidden p-4"></div>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-900/60 text-left text-slate-300">
                      <tr>
                        <th class="px-6 py-3">อุปกรณ์</th>
                        <th class="px-6 py-3">ผู้ยืม</th>
                        <th class="px-6 py-3">ยืมเมื่อ</th>
                        <th class="px-6 py-3">กำหนดคืน</th>
                        <th class="px-6 py-3 text-center">จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="onLoanTableBody" class="divide-y divide-slate-800"></tbody>
                  </table>
                </div>
              </div>

              <div class="bg-slate-900/40 border border-slate-800 rounded-2xl">
                <div class="p-4 border-b border-slate-800 flex items-center justify-between">
                  <h3 class="text-sm font-semibold text-slate-100">ประวัติยืม-คืน</h3>
                </div>
                <div id="loanHistoryEmptyState" class="hidden p-4"></div>
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-900/60 text-left text-slate-300">
                      <tr>
                        <th class="px-6 py-3">อุปกรณ์</th>
                        <th class="px-6 py-3">ผู้ยืม</th>
                        <th class="px-6 py-3">ยืมเมื่อ</th>
                        <th class="px-6 py-3">คืนเมื่อ</th>
                        <th class="px-6 py-3">สถานะ</th>
                      </tr>
                    </thead>
                    <tbody id="loanHistoryTableBody" class="divide-y divide-slate-800"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- 3. ประวัติใบเบิกทั้งหมด -->
          <section id="allHistoryPage" class="page hidden">
            <div class="p-4 md:p-6 space-y-4">
              <h2 class="text-lg font-semibold text-slate-100">ประวัติการเบิกทั้งหมด</h2>
              <div class="bg-slate-900/40 border border-slate-800 rounded-2xl">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-900/60 text-left text-slate-300">
                      <tr>
                        <th class="px-6 py-3">เลขที่ใบเบิก</th>
                        <th class="px-6 py-3">วันที่</th>
                        <th class="px-6 py-3">ผู้เบิก</th>
                        <th class="px-6 py-3">สถานะ</th>
                        <th class="px-6 py-3 text-right">ดู</th>
                      </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-slate-800"></tbody>
                  </table>
                </div>
                <div id="issueHistoryEmptyState" class="hidden p-4"></div>
              </div>
            </div>
          </section>

          <!-- 4. รายการรออนุมัติ (Admin) -->
          <section id="pendingPage" class="page hidden admin-page">
            <div class="p-4 md:p-6 space-y-4">
              <h2 class="text-lg font-semibold text-slate-100">รายการรออนุมัติ</h2>
              <div class="bg-slate-900/40 border border-slate-800 rounded-2xl">
                <div class="overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-900/60 text-left text-slate-300">
                      <tr>
                        <th class="px-6 py-3">เลขที่ใบเบิก</th>
                        <th class="px-6 py-3">วันที่</th>
                        <th class="px-6 py-3">ผู้เบิก</th>
                        <th class="px-6 py-3">หน่วยงาน</th>
                        <th class="px-6 py-3 text-center">จัดการ</th>
                      </tr>
                    </thead>
                    <tbody id="pendingTableBody" class="divide-y divide-slate-800"></tbody>
                  </table>
                </div>
                <div id="pendingEmptyState" class="hidden p-4"></div>
              </div>
            </div>
          </section>

          <!-- 5. จัดการรายการ PPE (Admin) -->
          <section id="managePage" class="page hidden admin-page">
            <div class="p-4 md:p-6 space-y-4">
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-100">จัดการอุปกรณ์ PPE</h2>
                <button
                  type="button"
                  onclick="showCategoryModal()"
                  class="px-3 py-1.5 rounded-lg bg-slate-700 text-slate-100 text-sm hover:bg-slate-600"
                >
                  จัดการหมวดหมู่
                </button>
              </div>
              <div class="grid gap-4 lg:grid-cols-2">
                <form id="manageForm" onsubmit="handleManageSubmit(event)" class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4 space-y-3">
                  <input type="hidden" id="editItemId" />
                  <div>
                    <label class="text-xs text-slate-400">รหัสอุปกรณ์</label>
                    <input id="itemCode" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" required />
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">ชื่ออุปกรณ์</label>
                    <input id="itemName" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" required />
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">หมวดหมู่</label>
                    <select id="itemCategory" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100">
                      <option value="">เลือกหมวดหมู่</option>
                    </select>
                  </div>
                  <div class="grid grid-cols-3 gap-3">
                    <div>
                      <label class="text-xs text-slate-400">หน่วย</label>
                      <input id="itemUnit" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" placeholder="คู่ / ชิ้น / ตัว" />
                    </div>
                    <div>
                      <label class="text-xs text-slate-400">จุดสั่งซื้อ</label>
                      <input id="itemReorderPoint" type="number" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" value="0" />
                    </div>
                    <div>
                      <label class="text-xs text-slate-400">คงเหลือ</label>
                      <input id="itemStock" type="number" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" value="0" />
                    </div>
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">จำนวนที่กำลังยืม (ถ้ามี)</label>
                    <input id="onLoanQuantity" type="number" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" value="0" />
                  </div>
                  <div class="flex justify-end gap-2">
                    <button type="button" onclick="resetManageForm()" class="px-3 py-2 rounded-lg bg-slate-700 text-white text-sm">ล้างฟอร์ม</button>
                    <button type="submit" class="px-3 py-2 rounded-lg bg-teal-500 text-white text-sm">บันทึก</button>
                  </div>
                </form>

                <div id="manageItemsList" class="space-y-2 bg-slate-900/40 border border-slate-800 rounded-2xl p-4"></div>
              </div>
            </div>
          </section>

          <!-- 6. รับเข้าสต็อก (Admin) -->
          <section id="receivePage" class="page hidden admin-page">
            <div class="p-4 md:p-6 space-y-4">
              <h2 class="text-lg font-semibold text-slate-100">รับอุปกรณ์เข้าสต็อก</h2>
              <form id="receiveForm" onsubmit="handleReceiveSubmit(event)" class="bg-slate-900/40 border border-slate-800 rounded-2xl p-4 space-y-4">
                <div class="grid gap-4 md:grid-cols-2">
                  <div>
                    <label class="text-xs text-slate-400">อุปกรณ์</label>
                    <select id="receiveItem" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" required></select>
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">จำนวนที่รับเข้า</label>
                    <input id="receiveQuantity" type="number" min="1" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" required />
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">ประเภทการรับ</label>
                    <select id="receiveType" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100">
                      <option value="receive">รับเข้า</option>
                      <option value="return">คืนจากยืม/ซ่อม</option>
                      <option value="adjust">ปรับปรุงยอด</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">ผู้บันทึก</label>
                    <input id="receiveUser" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" placeholder="ชื่อผู้รับเข้า" required />
                  </div>
                  <div>
                    <label class="text-xs text-slate-400">หน่วยงาน</label>
                    <input id="receiveDepartment" class="mt-1 w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100" placeholder="หน่วยงาน" />
                  </div>
                </div>
                <div class="flex justify-end">
                  <button type="submit" class="px-4 py-2 rounded-lg bg-teal-500 text-white text-sm">บันทึกการรับเข้า</button>
                </div>
              </form>
            </div>
          </section>
        </main>
      </div>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 z-[999] hidden bg-slate-950/70 backdrop flex items-center justify-center">
      <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 w-full max-w-sm">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-base font-semibold text-slate-100">เข้าสู่ระบบผู้ดูแลระบบ</h2>
          <button onclick="hideLoginModal()" class="h-8 w-8 rounded-full bg-slate-800 flex items-center justify-center">
            <i class="fa-solid fa-xmark text-slate-200"></i>
          </button>
        </div>
        <form id="loginForm" class="space-y-3">
          <div class="space-y-1">
            <label class="text-xs text-slate-400">ชื่อผู้ใช้</label>
            <input
              id="loginUsername"
              type="text"
              class="w-full bg-slate-950/30 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
            />
          </div>
          <div class="space-y-1">
            <label class="text-xs text-slate-400">รหัสผ่าน</label>
            <input
              id="loginPassword"
              type="password"
              class="w-full bg-slate-950/30 border border-slate-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500"
            />
          </div>
          <button class="w-full bg-teal-500 hover:bg-teal-400 text-white rounded-lg py-2 text-sm font-medium">
            เข้าสู่ระบบ
          </button>
        </form>
      </div>
    </div>

    <!-- โมดัลระบบ -->
    <div id="voucherModal" class="fixed inset-0 z-[999] hidden bg-slate-950/70 backdrop"></div>
    <div id="approvalModal" class="fixed inset-0 z-[999] hidden bg-slate-950/70 backdrop"></div>
    <div id="confirmationModal" class="fixed inset-0 z-[999] hidden bg-slate-950/70 backdrop">
      <div class="bg-white text-slate-900 p-6 rounded-xl w-full max-w-sm mx-auto mt-24">
        <h3 id="confirmationTitle" class="text-lg font-semibold mb-2"></h3>
        <p id="confirmationMessage" class="text-sm mb-4"></p>
        <div class="flex justify-end gap-2">
          <button id="confirmCancelBtn" class="px-4 py-2 bg-slate-200 rounded-lg">ยกเลิก</button>
          <button id="confirmProceedBtn" class="px-4 py-2 bg-teal-500 text-white rounded-lg">ตกลง</button>
        </div>
      </div>
    </div>

    <!-- Scripts (ย้าย JS ทั้งหมดมาไว้ที่ไฟล์นี้) -->
    <script src="./app.js"></script>
  </body>
</html>
