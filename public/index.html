<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPE Stock Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --font-family-main: 'Inter', 'Sarabun', sans-serif;
        }
        body {
            font-family: var(--font-family-main);
            background-color: #f8fafc; /* slate-50 */
        }
        .page {
            transition: opacity 0.3s ease-in-out;
            width: 100%;
        }
        .page-container > .page.hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
        }
        .modal-backdrop { 
            transition: opacity 0.3s ease-in-out; 
            backdrop-filter: blur(4px);
        }
        .toast {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.hide {
            opacity: 0;
            transform: translateY(-20px);
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* User Mode Styles */
        .card-calm { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
            border: 1px solid #E5E7EB;
        }

        /* Mobile Responsive Tweaks */
        @media (max-width: 640px) {
            .hide-on-mobile { display: none !important; }
            .mobile-full-width { width: 100% !important; }
            /* ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: white; }
            .responsive-table td { display: flex; justify-content: space-between; padding: 0.5rem 0; border: none; }
            .responsive-table td:before { content: attr(data-label); font-weight: 600; color: #6b7280; margin-right: 1rem; }
        }

        @media (max-width: 640px) {            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á main content ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
            main {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }
        }

        /* --- Mobile Card View for Pending Page --- */
        @media (max-width: 640px) {
            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            .pending-card-table thead { display: none; }
            
            /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î */
            .pending-card-table tr {
                display: flex;
                flex-direction: column;
                background: white;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 1rem; /* ‡∏Ç‡∏≠‡∏ö‡∏°‡∏ô */
                padding: 1rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            }

            /* ‡∏à‡∏±‡∏î layout ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î */
            .pending-card-table td {
                display: block;
                padding: 0.25rem 0;
                border: none;
                text-align: left;
            }

            /* ‡∏à‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏≤‡∏£‡πå‡∏î (ID ‡πÅ‡∏•‡∏∞ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) */
            .pending-card-table td:nth-child(1) { font-weight: bold; color: #0d9488; font-size: 1.1rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.5rem; }
            .pending-card-table td:nth-child(2) { font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; }
            .pending-card-table td:nth-child(3) { font-weight: 600; color: #374151; } /* ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å */
            
            /* ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (Action Buttons) */
            .pending-card-table td:last-child {
                margin-top: 1rem;
                padding-top: 0.75rem;
                border-top: 1px solid #f3f4f6;
                display: flex;
                gap: 0.75rem;
            }
            /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢ */
            .pending-card-table td:last-child button {
                flex: 1; /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
                padding: 0.75rem;
                justify-content: center;
                border-radius: 0.5rem;
                font-size: 0.95rem;
            }
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Animation ‡πÉ‡∏´‡πâ Modal ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á */
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Safe Area */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .mb-safe {
            margin-bottom: env(safe-area-inset-bottom);
        }

        /* --- üñ®Ô∏è CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå / Save as PDF --- */
        @media print {
            body * {
                visibility: hidden;
            }
            
            /* ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô Report */
            #reportPage, #reportPage * {
                visibility: visible;
            }

            /* ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ Report ‡πÑ‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
            #reportPage {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                background: white;
                display: block !important;
            }

            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Report ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡πÑ‡∏õ‡πÉ‡∏ô PDF */
            .no-print, button, input, select, label, .fa-search {
                display: none !important;
            }

            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© */
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 12px;
            }
            
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }

            /* üëáüëá ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° print-color-adjust ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ üëáüëá */
            th {
                background-color: #f3f4f6 !important;
                -webkit-print-color-adjust: exact; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chrome/Safari */
                print-color-adjust: exact;         /* ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà */
            }

            /* ‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF */
            #reportHeaderPrint {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
            }
            
            /* ‡∏ã‡πà‡∏≠‡∏ô Scrollbar */
            ::-webkit-scrollbar {
                display: none;
            }
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© PDF ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ */
        #reportHeaderPrint {
            display: none;
        }
    </style>
</head>
<body class="antialiased">

<div id="loadingOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[100] hidden">
    <div class="text-center">
        <i class="fas fa-spinner fa-spin text-4xl text-teal-600"></i>
        <p class="mt-3 text-lg text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
</div>

<div id="toastContainer" class="fixed top-5 right-5 z-[90] space-y-3"></div>

<div class="flex h-screen bg-gray-50">
    <aside class="hidden lg:flex lg:flex-col w-64 bg-white border-r border-gray-200">
        <div class="h-16 flex items-center px-6 border-b border-gray-200">
            <img src="/logo.png" alt="Company Logo" class="h-9 w-9 rounded-full mr-3" onerror="this.style.display='none'">
            <h1 class="text-lg font-bold text-gray-800">PPE Stock</h1>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-2">
            <a href="#" onclick="showPage('dashboard')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                <i class="fa-solid fa-chart-pie w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
            </a>
            <a href="#" onclick="showPage('stock')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                <i class="fa-solid fa-boxes-stacked w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </a>
            <a href="#" onclick="showPage('issue')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                <i class="fa-solid fa-file-export w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </a>
            <a href="#" onclick="showPage('loan')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                <i class="fa-solid fa-hand-holding-hand w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </a>
            <a href="#" onclick="showPage('allHistory')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                <i class="fa-solid fa-clock-rotate-left w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </a>
            <a href="#" onclick="showPage('matrix')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                <i class="fa-solid fa-clipboard-list w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô PPE
            </a>
            <div id="adminMenu" class="hidden pt-4 mt-4 border-t border-gray-200 space-y-2">
                 <p class="px-4 text-xs font-semibold text-gray-400 uppercase">Admin Tools</p>
                <a href="#" onclick="showPage('pending')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                    <i class="fa-solid fa-hourglass-half w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                </a>
                <a href="#" onclick="showPage('manage')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                    <i class="fa-solid fa-gear w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                </a>
                <a href="#" onclick="showPage('receive')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                    <i class="fa-solid fa-truck-ramp-box w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
                </a>
                <a href="#" onclick="showPage('report')" class="nav-item group flex items-center px-4 py-2.5 text-sm font-medium rounded-lg text-gray-700 hover:bg-teal-50 hover:text-teal-600">
                    <i class="fa-solid fa-chart-line w-6 h-6 mr-3 text-gray-400 group-hover:text-teal-600"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ
                </a>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-200">
            <div id="loginSection">
                <button onclick="showLoginModal()" class="w-full bg-teal-600 hover:bg-teal-700 text-white py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center text-sm font-medium">
                    <i class="fa-solid fa-right-to-bracket mr-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
                </button>
            </div>
            <div id="logoutSection" class="hidden">
                 <div class="text-sm text-gray-600 mb-2 text-center">Logged in as: <span class="font-bold">Admin</span></div>
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2.5 px-4 rounded-lg transition-colors flex items-center justify-center text-sm font-medium">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>
    </aside>

    <div class="flex flex-col flex-1 overflow-hidden">
        <header class="lg:hidden h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4">
             <div class="flex items-center">
                <img src="/logo.png" alt="Company Logo" class="h-9 w-9 rounded-full mr-3" onerror="this.style.display='none'">
                <h1 class="text-lg font-bold text-gray-800">PPE Stock</h1>
            </div>
            <div id="loginSectionMobile">
                <button onclick="showLoginModal()" class="text-teal-600 hover:text-teal-700">
                    <i class="fa-solid fa-right-to-bracket text-xl"></i>
                </button>
            </div>
            <div id="logoutSectionMobile" class="hidden">
                 <button onclick="logout()" class="text-red-600 hover:text-red-700">
                    <i class="fa-solid fa-right-from-bracket text-xl"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 px-2 sm:pt-4 sm:px-6 lg:px-8 pb-32 page-container relative">
                <div id="dashboardPage" class="page">
                    <div class="max-w-7xl mx-auto space-y-6">
                    
                        <div id="adminDashboardPanel" class="hidden">
                            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                                
                                <div class="mb-6 flex flex-row justify-between items-end">
                                    <div>
                                        <p class="text-gray-500 text-xs font-medium uppercase tracking-wide">Admin Console</p>
                                        <h2 class="text-2xl font-bold text-gray-800">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</h2>
                                    </div>
                                    
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] sm:text-xs text-gray-500 font-mono bg-white border border-gray-200 px-3 py-1.5 rounded-lg shadow-sm whitespace-nowrap" id="currentDateDisplay">
                                            ...
                                        </span>
                                        <button onclick="refreshDashboardData(this)" class="bg-white border border-teal-200 text-teal-600 hover:bg-teal-50 p-1.5 rounded-lg shadow-sm transition-all active:scale-90 flex items-center justify-center w-8 h-8" title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                                            <i class="fa-solid fa-rotate text-sm"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3 mb-6">
                                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-28 relative overflow-hidden group">
                                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                            <i class="fa-solid fa-boxes text-5xl text-teal-600"></i>
                                        </div>
                                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                                        <p class="text-3xl font-bold text-gray-800 mt-1" id="totalItems">0</p>
                                        <div class="h-1 w-full bg-gray-100 rounded-full mt-auto overflow-hidden">
                                            <div class="h-full bg-teal-500 w-2/3 rounded-full"></div>
                                        </div>
                                    </div>

                                    <div onclick="showPage('pending')" class="bg-orange-50 p-4 rounded-2xl shadow-sm border border-orange-100 flex flex-col justify-between h-28 cursor-pointer active:scale-95 transition-transform relative overflow-hidden">
                                        <div class="absolute right-0 top-0 p-3 opacity-20">
                                            <i class="fa-solid fa-clock text-5xl text-orange-600"></i>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <p class="text-xs text-orange-800 font-bold uppercase tracking-wider">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
                                            <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span>
                                        </div>
                                        <p class="text-3xl font-bold text-orange-700 mt-1" id="pendingVouchers">0</p>
                                        <p class="text-[10px] text-orange-600 font-medium flex items-center gap-1">
                                            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ <i class="fa-solid fa-arrow-right"></i>
                                        </p>
                                    </div>

                                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-28 relative overflow-hidden">
                                        <div class="absolute right-0 top-0 p-3 opacity-10">
                                            <i class="fa-solid fa-triangle-exclamation text-5xl text-red-500"></i>
                                        </div>
                                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á</p>
                                        <div class="flex items-baseline gap-1 mt-1">
                                            <p class="text-3xl font-bold text-gray-800" id="lowStockItems">0</p>
                                            <span class="text-xs text-gray-400">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</span>
                                        </div>
                                        <div class="mt-auto">
                                            <span class="text-[10px] px-2 py-0.5 bg-red-100 text-red-600 rounded-md font-bold">
                                                ‡∏´‡∏°‡∏î: <span id="outOfStockItems">0</span>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between h-28 relative overflow-hidden">
                                        <div class="absolute right-0 top-0 p-3 opacity-10">
                                            <i class="fa-solid fa-wallet text-5xl text-blue-500"></i>
                                        </div>
                                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                                        <p class="text-lg font-bold text-blue-600 truncate mt-1" id="totalStockValue">‡∏ø0</p>
                                        <p class="text-[10px] text-gray-400 mt-auto">‡∏ö‡∏≤‡∏ó (THB)</p>
                                    </div>
                                </div>

                                <h3 class="text-sm font-bold text-gray-800 mb-3 ml-1 flex items-center gap-2">
                                    <i class="fa-solid fa-rocket text-teal-500"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô
                                </h3>
                                <div class="grid grid-cols-2 gap-3 mb-8">
                                    <button onclick="showPage('issue')" class="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-200 shadow-sm active:bg-gray-50 active:border-teal-500 transition-all group">
                                        <div class="w-10 h-10 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center group-active:bg-teal-600 group-active:text-white transition-colors">
                                            <i class="fa-solid fa-file-export text-lg"></i>
                                        </div>
                                        <div class="text-left">
                                            <p class="text-sm font-bold text-gray-700">‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á</p>
                                            <p class="text-[10px] text-gray-400">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</p>
                                        </div>
                                    </button>

                                    <button onclick="showPage('receive')" class="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-200 shadow-sm active:bg-gray-50 active:border-blue-500 transition-all group">
                                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center group-active:bg-blue-600 group-active:text-white transition-colors">
                                            <i class="fa-solid fa-truck-ramp-box text-lg"></i>
                                        </div>
                                        <div class="text-left">
                                            <p class="text-sm font-bold text-gray-700">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</p>
                                            <p class="text-[10px] text-gray-400">‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                                        </div>
                                    </button>

                                    <button onclick="showPage('manage')" class="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-200 shadow-sm active:bg-gray-50 active:border-purple-500 transition-all group">
                                        <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center group-active:bg-purple-600 group-active:text-white transition-colors">
                                            <i class="fa-solid fa-gear text-lg"></i>
                                        </div>
                                        <div class="text-left">
                                            <p class="text-sm font-bold text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</p>
                                            <p class="text-[10px] text-gray-400">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                                        </div>
                                    </button>

                                    <button onclick="showPage('report')" class="flex items-center gap-3 p-4 bg-white rounded-xl border border-gray-200 shadow-sm active:bg-gray-50 active:border-pink-500 transition-all group">
                                        <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-600 flex items-center justify-center group-active:bg-pink-600 group-active:text-white transition-colors">
                                            <i class="fa-solid fa-chart-pie text-lg"></i>
                                        </div>
                                        <div class="text-left">
                                            <p class="text-sm font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
                                            <p class="text-[10px] text-gray-400">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</p>
                                        </div>
                                    </button>
                                </div>

                                <div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm mb-20">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-sm font-bold text-gray-800">5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
                                        <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500 font-medium">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
                                    </div>
                                    <div class="relative h-48">
                                        <canvas id="topIssuedItemsChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="hidden relative h-64 md:h-72 mt-4"><canvas id="categoryChart"></canvas></div>
                            </div> </div>

                    <div id="userDashboardPanel" class="w-full"></div>
                    
                    <div id="dashboardSkeleton" class="hidden">
                        <div class="animate-pulse space-y-4"><div class="h-32 bg-gray-200 rounded-xl"></div><div class="h-64 bg-gray-200 rounded-xl"></div></div>
                    </div>

                </div> </div>

            <div id="stockPage" class="page hidden">
                <div class="max-w-7xl mx-auto space-y-6"> <div class="sticky top-0 z-30 bg-gray-100/95 backdrop-blur-md pt-2 pb-2 -mx-4 px-4 sm:static sm:bg-transparent sm:p-0 sm:mx-0">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                            
                            <div class="text-center md:text-left w-full md:w-auto">
                                <h3 class="text-xl font-bold text-gray-800">
                                    <i class="fa-solid fa-boxes-stacked text-teal-600 mr-2"></i>‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Stock)
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                                <div class="relative flex-1 md:w-64 group">
                                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-teal-500 transition-colors"></i>
                                    <input type="text" id="stockSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™..." 
                                        class="w-full pl-10 pr-10 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-all">
                                    <button onclick="document.getElementById('stockSearch').value=''; filterStock();" 
                                            class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-200 transition-colors">
                                        <i class="fa-solid fa-circle-xmark"></i>
                                    </button>
                                </div>
                                <div class="relative md:w-48">
                                    <select id="categoryFilter" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 appearance-none cursor-pointer text-gray-700">
                                        <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-xs"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="stockGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 pb-24">
                        </div>
                    
                    <div id="stockEmptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-400 bg-white rounded-xl border-2 border-dashed border-gray-200 mt-8">
                        <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                            <i class="fa-solid fa-box-open text-3xl text-gray-300"></i>
                        </div>
                        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>
                    </div>

                </div>
            </div>

            <div id="issuePage" class="page hidden">
                <div class="max-w-4xl mx-auto p-4 lg:p-8 pb-24"> <div class="bg-white rounded-xl shadow-sm border p-6 sm:p-8">
                        <h3 class="text-xl font-semibold mb-6 text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-file-circle-plus text-teal-600"></i>
                            ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                        </h3>
                        
                        <form id="issueForm" class="space-y-6">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</label>

                                    <div class="flex items-center gap-4 mb-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-200">
                                        <label class="flex items-center gap-2 cursor-pointer hover:text-teal-600 transition-colors">
                                            <input type="radio" name="issueUserMode" value="line" checked class="text-teal-600 focus:ring-teal-500">
                                            <span class="font-medium">‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å LINE</span>
                                        </label>

                                        <label class="flex items-center gap-2 cursor-pointer hover:text-teal-600 transition-colors">
                                            <input type="radio" name="issueUserMode" value="custom" class="text-teal-600 focus:ring-teal-500">
                                            <span class="font-medium">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</span>
                                        </label>
                                    </div>

                                    <div class="relative">
                                        <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input
                                            type="text"
                                            id="issueUser"
                                            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å"
                                            disabled
                                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 disabled:bg-gray-100 disabled:text-gray-500"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-id-card absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" id="employeeId" required placeholder="‡πÄ‡∏ä‡πà‡∏ô EMP-001" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>

                                <div class="relative mb-2">
                                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input
                                        id="issueDepartmentSearch"
                                        type="text"
                                        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å..."
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm bg-gray-50"
                                    />
                                </div>

                                <div class="relative">
                                    <i class="fa-solid fa-building absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-10"></i>
                                    <select
                                        id="issueDepartment"
                                        required
                                        class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 appearance-none bg-white cursor-pointer relative"
                                    >
                                        <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
                                    </select>

                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                                        <i class="fa-solid fa-chevron-down text-xs"></i>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå <span class="text-red-500">*</span></label>
                                <div id="issueItemsContainer" class="space-y-3 mb-3">
                                    </div>
                                
                                <button type="button" onclick="openIssueCatalog()" class="w-full py-4 border-2 border-dashed border-teal-300 rounded-xl text-teal-600 hover:bg-teal-50 hover:border-teal-500 transition-all font-medium flex items-center justify-center gap-2 group">
                                    <div class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center group-hover:bg-teal-200 transition-colors">
                                        <i class="fas fa-plus text-teal-700"></i>
                                    </div>
                                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å
                                </button>
                            </div>

                            <div class="flex justify-end gap-3 pt-6 border-t border-gray-100">
                                <button type="button" onclick="resetIssueForm()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                                </button>
                                <button type="submit" class="flex-[2] px-6 py-3 bg-teal-600 text-white rounded-xl hover:bg-teal-700 transition-all shadow-md active:scale-95 font-bold flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-paper-plane"></i> ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="loanPage" class="page hidden">
                <div class="max-w-7xl mx-auto space-y-6"> <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border p-6">
                            <h3 class="text-xl font-semibold mb-6 text-gray-800 flex items-center gap-2">
                                <i class="fa-solid fa-hand-holding-hand text-teal-600"></i>
                                ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                            </h3>
                            
                            <form id="loanForm" class="space-y-4">
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</label>
                                    <input type="hidden" id="loanItemId" required> 
                                    
                                    <div id="loanItemDisplay" onclick="openLoanCatalog()" class="cursor-pointer flex items-center justify-between p-3 border border-gray-300 rounded-lg bg-white hover:border-teal-500 hover:shadow-sm transition-all group">
                                        <div class="flex items-center gap-3">
                                            <div id="loanItemImgPlaceholder" class="w-12 h-12 bg-gray-100 rounded-md flex items-center justify-center text-gray-400 border border-gray-200">
                                                <i class="fa-solid fa-box-open text-xl"></i>
                                            </div>
                                            <img id="loanItemImg" src="" class="w-12 h-12 rounded-md object-cover hidden border border-gray-200">
                                            
                                            <div class="overflow-hidden">
                                                <p id="loanItemName" class="text-gray-500 group-hover:text-teal-600 font-medium truncate">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</p>
                                                <p id="loanItemCode" class="text-xs text-gray-400 hidden"></p>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-gray-400 group-hover:text-teal-500 transition-colors"></i>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</label>

                                    <div class="flex items-center gap-4 mb-2 text-sm bg-gray-50 p-2 rounded-lg border border-gray-200">
                                        <label class="flex items-center gap-2 cursor-pointer hover:text-teal-600 transition-colors">
                                            <input type="radio" name="loanUserMode" value="line" checked class="text-teal-600 focus:ring-teal-500">
                                            <span class="font-medium">‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å LINE</span>
                                        </label>

                                        <label class="flex items-center gap-2 cursor-pointer hover:text-teal-600 transition-colors">
                                            <input type="radio" name="loanUserMode" value="custom" class="text-teal-600 focus:ring-teal-500">
                                            <span class="font-medium">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏á</span>
                                        </label>
                                    </div>

                                    <div class="relative">
                                        <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input 
                                            type="text" 
                                            id="loanUser" 
                                            required 
                                            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°"
                                            disabled
                                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 disabled:bg-gray-100 disabled:text-gray-500 disabled:cursor-not-allowed bg-white transition-colors"
                                        >
                                    </div>
                                </div>

                                <div>
                                    <label for="loanEmployeeId" class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                                    <div class="relative">
                                        <i class="fa-solid fa-id-card absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" id="loanEmployeeId" required placeholder="‡πÄ‡∏ä‡πà‡∏ô EMP-001" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å</label>

                                    <div class="relative mb-2">
                                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input
                                            id="departmentSearch"
                                            type="text"
                                            placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å..."
                                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 text-sm bg-gray-50"
                                        />
                                    </div>

                                    <div class="relative">
                                        <i class="fa-solid fa-building absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 z-10"></i>
                                        <select
                                            id="loanDepartment"
                                            required
                                            class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 appearance-none bg-white cursor-pointer relative"
                                        >
                                            <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
                                        </select>

                                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                                            <i class="fa-solid fa-chevron-down text-xs"></i>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label for="loanDueDate" class="block text-sm font-medium text-gray-700 mb-2">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</label>
                                    <input type="date" id="loanDueDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                </div>

                                <div>
                                    <label for="loanNotes" class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                                    <textarea id="loanNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                                </div>

                                <div class="flex justify-end pt-4">
                                    <button type="submit" class="w-full px-6 py-3 bg-teal-600 text-white rounded-xl hover:bg-teal-700 transition-colors shadow-md active:scale-95 transform duration-150 font-bold flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="lg:col-span-2 flex flex-col h-full">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex-1 flex flex-col overflow-hidden">
                                <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <i class="fa-solid fa-clock-rotate-left text-teal-600"></i> 
                                        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°
                                    </h3>
                                    <span class="bg-teal-100 text-teal-700 text-xs font-bold px-3 py-1 rounded-full border border-teal-200" id="onLoanCountBadge">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                </div>
                                
                                <div id="onLoanListContainer" class="p-4 overflow-y-auto max-h-[600px] bg-gray-50/30 space-y-3">
                                    </div>
                                
                                <div id="onLoanEmptyState" class="hidden flex-1 flex flex-col items-center justify-center py-12 text-gray-400">
                                    </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <div id="allHistoryPage" class="page hidden">
                <div class="max-w-5xl mx-auto space-y-6 p-4 lg:p-8 pb-24"> <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        
                        <div class="text-center md:text-left w-full md:w-auto">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fa-solid fa-clock-rotate-left text-teal-600 mr-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</p>
                        </div>
                        
                        <div class="w-full md:w-72 relative group">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-teal-500 transition-colors"></i>
                            <input type="text" id="historySearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." 
                                class="w-full pl-10 pr-10 py-2 bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition-all">
                            
                            <button onclick="document.getElementById('historySearch').value=''; updateHistoryTable(); updateLoanHistoryTable();" 
                                    class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-200 transition-colors" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
                                <i class="fa-solid fa-circle-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[500px] flex flex-col">
                        
                        <div class="border-b border-gray-200 bg-gray-50/80 px-2 sticky top-0 z-10 backdrop-blur-sm">
                            <nav class="flex -mb-px space-x-4" aria-label="Tabs">
                                <button onclick="showHistoryTab('issue')" id="tab-issue" class="history-tab flex-1 md:flex-none text-center py-4 px-6 border-b-2 font-bold text-sm transition-all border-teal-500 text-teal-700 bg-white/50">
                                    <i class="fas fa-file-invoice mr-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å
                                </button>
                                <button onclick="showHistoryTab('loan')" id="tab-loan" class="history-tab flex-1 md:flex-none text-center py-4 px-6 border-b-2 font-bold text-sm transition-all border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                    <i class="fas fa-hand-holding-hand mr-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô
                                </button>
                            </nav>
                        </div>

                        <div class="p-4 bg-gray-50/30 flex-1">
                            
                            <div id="issueHistoryTab" class="history-tab-content space-y-3">
                                </div>
                            <div id="issueHistoryEmptyState" class="hidden py-20 text-center text-gray-400 flex flex-col items-center justify-center">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                    <i class="fa-solid fa-file-circle-xmark text-2xl text-gray-300"></i>
                                </div>
                                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å</p>
                            </div>

                            <div id="loanHistoryTab" class="history-tab-content hidden space-y-3">
                                </div>
                            <div id="loanHistoryEmptyState" class="hidden py-20 text-center text-gray-400 flex flex-col items-center justify-center">
                                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                    <i class="fa-solid fa-hand-holding text-2xl text-gray-300"></i>
                                </div>
                                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</p>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div id="pendingPage" class="page hidden admin-page">
                <div class="max-w-7xl mx-auto space-y-6 p-4 lg:p-8 pb-24"> <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col min-h-[400px]">
                        
                        <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50/50">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-solid fa-clock text-yellow-500"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà</p>
                            </div>
                            <span id="pendingCountBadge" class="bg-yellow-100 text-yellow-700 text-xs font-bold px-3 py-1 rounded-full border border-yellow-200">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>

                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-sm pending-card-table">
                                <thead class="bg-gray-50 text-left">
                                    <tr>
                                        <th class="px-6 py-4 font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</th>
                                        <th class="px-6 py-4 font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="px-6 py-4 font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</th>
                                        <th class="px-6 py-4 font-semibold text-gray-600 uppercase tracking-wider whitespace-nowrap">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                        <th class="px-6 py-4 font-semibold text-gray-600 uppercase tracking-wider text-center whitespace-nowrap">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingTableBody" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                            
                            <div id="pendingEmptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
                                <div class="w-20 h-20 bg-yellow-50 rounded-full flex items-center justify-center mb-4 border border-yellow-100">
                                    <i class="fa-solid fa-clipboard-check text-4xl text-yellow-300"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-800">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h4>
                                <p class="text-gray-500 text-sm mt-1">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="managePage" class="page hidden admin-page">
                <div class="max-w-7xl mx-auto p-4 lg:p-8 pb-24"> <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                        
                        <div class="lg:col-span-4 bg-white rounded-xl shadow-sm border border-gray-200 p-6 h-fit lg:sticky lg:top-4 z-10">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-gray-800" id="manageFormTitle">
                                    <i class="fa-solid fa-plus-circle text-teal-600 mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà
                                </h3>
                                <button onclick="resetManageForm()" class="text-xs text-gray-500 hover:text-teal-600 underline">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                            </div>

                            <form id="manageForm" class="space-y-4">
                                <input type="hidden" id="editItemId">
                                
                                <div class="flex flex-col items-center mb-4">
                                    <div class="w-32 h-32 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden relative group mb-3">
                                        <img id="adminImagePreview" src="" class="w-full h-full object-contain hidden p-1">
                                        <div id="adminImagePlaceholder" class="text-center text-gray-400">
                                            <i class="fa-solid fa-image text-3xl mb-1"></i>
                                            <p class="text-[10px]">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ</p>
                                        </div>
                                    </div>
                                    <input type="url" id="itemImage" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL) ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." 
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 text-center"
                                        oninput="updateImagePreview(this.value)">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå <span class="text-red-500">*</span></label>
                                    <input type="text" id="itemName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™ (Code) <span class="text-red-500">*</span></label>
                                        <input type="text" id="itemCode" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö <span class="text-red-500">*</span></label>
                                        <input type="text" id="itemUnit" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏±‡∏ô, ‡∏Ñ‡∏π‡πà, ‡∏ä‡∏∏‡∏î" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-red-500">*</span></label>
                                    <div class="flex gap-2">
                                        <select id="itemCategory" required class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white"></select>
                                        <button type="button" onclick="showCategoryModal()" class="px-3 bg-gray-100 rounded-lg text-gray-600 hover:bg-gray-200 border border-gray-200" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">
                                            <i class="fa-solid fa-tags"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-3">
                                    <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                            <input type="number" id="itemStock" required min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 font-bold text-gray-800">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 mb-1">‡∏à‡∏∏‡∏î‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (Min)</label>
                                            <input type="number" id="itemReorderPoint" required min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-600 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                        <input type="number" id="itemPrice" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500" placeholder="0.00">
                                    </div>
                                    <input type="hidden" id="onLoanQuantity" value="0">
                                </div>

                                <div class="pt-2 flex gap-2">
                                    <button type="button" onclick="resetManageForm()" class="flex-1 py-2.5 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                    <button type="submit" class="flex-1 py-2.5 bg-teal-600 text-white rounded-lg hover:bg-teal-700 shadow-md transition-transform active:scale-95 font-bold">
                                        <i class="fa-solid fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="lg:col-span-8 space-y-4">
                            
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row gap-3 justify-between items-center sticky top-0 z-30">
                                <div class="w-full md:w-auto flex items-center gap-2">
                                    <div class="bg-teal-100 p-2 rounded-lg text-teal-700">
                                        <i class="fa-solid fa-list-check"></i>
                                    </div>
                                    <h3 class="font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                                </div>
                                
                                <div class="flex gap-2 w-full md:w-auto">
                                    <div class="relative flex-1 md:w-64">
                                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                        <input type="text" id="manageSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™..." 
                                            class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-teal-500"
                                            oninput="updateManageItemsList()">
                                    </div>
                                    <select id="manageCategoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-teal-500"
                                        onchange="updateManageItemsList()">
                                        <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                    </select>
                                </div>
                            </div>

                            <div id="manageItemsList" class="grid grid-cols-1 gap-3 pb-20">
                                </div>
                        </div>

                    </div>
                </div>
            </div>

            <div id="receivePage" class="page hidden admin-page">
                <div class="max-w-4xl mx-auto p-4 lg:p-8 pb-24"> <div class="bg-white rounded-xl shadow-sm border p-6 sm:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i class="fa-solid fa-truck-ramp-box text-teal-600"></i>
                                ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å
                            </h3>
                            </div>

                        <form id="receiveForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå <span class="text-red-500">*</span></label>
                                    <input type="hidden" id="receiveItemId" required>
                                    
                                    <div id="receiveItemDisplay" onclick="openReceiveCatalog()" class="cursor-pointer flex items-center justify-between p-3 border border-gray-300 rounded-lg bg-white hover:border-teal-500 hover:shadow-sm transition-all group">
                                        <div class="flex items-center gap-3">
                                            <div id="receiveItemImgPlaceholder" class="w-12 h-12 bg-gray-100 rounded-md flex items-center justify-center text-gray-400 border border-gray-200">
                                                <i class="fa-solid fa-box-open text-xl"></i>
                                            </div>
                                            <img id="receiveItemImg" src="" class="w-12 h-12 rounded-md object-contain hidden border border-gray-200 bg-white">
                                            
                                            <div class="overflow-hidden">
                                                <p id="receiveItemName" class="text-gray-500 group-hover:text-teal-600 font-medium truncate">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...</p>
                                                <p id="receiveItemCode" class="text-xs text-gray-400 hidden"></p>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-gray-400 group-hover:text-teal-500 transition-colors"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="number" id="receiveQuantity" required min="1" placeholder="0" class="w-full pl-4 pr-12 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 font-bold text-lg text-gray-800">
                                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm">‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="receiveTypeOption" value="purchase" class="peer sr-only" checked onchange="document.getElementById('receiveType').value='purchase'">
                                        <div class="peer-checked:bg-teal-50 peer-checked:border-teal-500 peer-checked:text-teal-700 border border-gray-200 rounded-lg p-3 text-center transition-all hover:bg-gray-50">
                                            <i class="fa-solid fa-cart-shopping mb-1 block text-lg"></i>
                                            <span class="text-xs font-medium">‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="receiveTypeOption" value="return" class="peer sr-only" onchange="document.getElementById('receiveType').value='return'">
                                        <div class="peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-700 border border-gray-200 rounded-lg p-3 text-center transition-all hover:bg-gray-50">
                                            <i class="fa-solid fa-rotate-left mb-1 block text-lg"></i>
                                            <span class="text-xs font-medium">‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</span>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="receiveTypeOption" value="adjustment" class="peer sr-only" onchange="document.getElementById('receiveType').value='adjustment'">
                                        <div class="peer-checked:bg-orange-50 peer-checked:border-orange-500 peer-checked:text-orange-700 border border-gray-200 rounded-lg p-3 text-center transition-all hover:bg-gray-50">
                                            <i class="fa-solid fa-sliders mb-1 block text-lg"></i>
                                            <span class="text-xs font-medium">‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</span>
                                        </div>
                                    </label>
                                </div>
                                <select id="receiveType" class="hidden"><option value="purchase">purchase</option><option value="return">return</option><option value="adjustment">adjustment</option></select>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" id="receiveUser" required placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÅ‡∏ú‡∏ô‡∏Å <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <i class="fa-solid fa-building absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                        <input type="text" id="receiveDepartment" required placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-3 pt-6 border-t border-gray-100">
                                <button type="button" onclick="resetReceiveForm()" class="flex-1 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
                                </button>
                                <button type="submit" class="flex-[2] py-3 bg-teal-600 text-white rounded-xl hover:bg-teal-700 transition-all shadow-md active:scale-95 font-bold flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="reportPage" class="page hidden admin-page">
                <div class="max-w-7xl mx-auto space-y-6 p-4 lg:p-8 pb-24"> 
                    
                    <div id="reportHeaderPrint" class="hidden text-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå PPE</h1>
                        <p class="text-gray-600" id="printDateRange">‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ...</p>
                        <hr class="mt-4 border-gray-300">
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 no-print">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-solid fa-chart-line text-teal-600"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ (Report)
                                </h2>
                                <p class="text-sm text-gray-500 mt-1">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="printReport()" class="flex-1 md:flex-none bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 shadow-sm flex items-center justify-center gap-2 text-sm font-medium transition-colors">
                                    <i class="fa-solid fa-file-pdf"></i> PDF / Print
                                </button>
                                <button onclick="exportReportToCSV()" class="flex-1 md:flex-none bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow-sm flex items-center justify-center gap-2 text-sm font-medium transition-colors">
                                    <i class="fa-solid fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end bg-gray-50 p-4 rounded-xl border border-gray-100">
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="reportStartDate" class="w-full border-gray-300 rounded-lg text-sm focus:ring-teal-500 focus:border-teal-500 cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="reportEndDate" class="w-full border-gray-300 rounded-lg text-sm focus:ring-teal-500 focus:border-teal-500 cursor-pointer">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-700 mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                <select id="reportDeptFilter" class="w-full border-gray-300 rounded-lg text-sm focus:ring-teal-500 focus:border-teal-500 cursor-pointer bg-white">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                                </select>
                            </div>
                            <button onclick="filterReports()" class="w-full bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 font-bold text-sm shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-magnifying-glass"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-lg relative overflow-hidden">
                            <i class="fa-solid fa-file-invoice absolute right-3 top-3 text-blue-400/30 text-6xl"></i>
                            <div class="text-blue-100 text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</div>
                            <div class="text-3xl font-bold" id="rptTotalVouchers">0</div>
                            <div class="text-right text-xs mt-2 opacity-80">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white shadow-lg relative overflow-hidden">
                            <i class="fa-solid fa-cubes absolute right-3 top-3 text-purple-400/30 text-6xl"></i>
                            <div class="text-purple-100 text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å</div>
                            <div class="text-3xl font-bold" id="rptTotalItems">0</div>
                            <div class="text-right text-xs mt-2 opacity-80">‡∏ä‡∏¥‡πâ‡∏ô</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-5 text-white shadow-lg relative overflow-hidden">
                            <i class="fa-solid fa-crown absolute right-3 top-3 text-orange-400/30 text-6xl"></i>
                            <div class="text-orange-100 text-sm font-medium mb-1">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î</div>
                            <div class="text-xl font-bold truncate pr-8" id="rptTopDept">-</div>
                            <div class="text-right text-xs mt-2 opacity-80">Top Spender</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col min-h-[400px]">
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b">
                                    <tr>
                                        <th class="px-6 py-4 font-bold w-32 whitespace-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                        <th class="px-6 py-4 font-bold w-24 whitespace-nowrap">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                        <th class="px-6 py-4 font-bold whitespace-nowrap">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å / ‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                        <th class="px-6 py-4 font-bold min-w-[200px]">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                        <th class="px-6 py-4 font-bold text-center w-24 whitespace-nowrap">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    </tr>
                                </thead>
                                <tbody id="reportTableBody" class="divide-y divide-gray-100">
                                </tbody>
                            </table>
                            
                            <div id="reportEmptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
                                <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4 border border-gray-100">
                                    <i class="fa-solid fa-magnifying-glass-minus text-3xl text-gray-300"></i>
                                </div>
                                <p class="text-gray-500 font-medium">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
                                <p class="text-xs text-gray-400 mt-1">‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏∑‡πà‡∏ô</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 border-t border-gray-200 pt-8 no-print">
                        <h3 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-comments text-teal-600"></i> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Feedback)
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-teal-50 rounded-2xl p-8 flex flex-col items-center justify-center text-center border border-teal-100 shadow-sm h-full">
                                <div class="text-6xl font-extrabold text-teal-700 mb-2" id="avgRatingScore">0.0</div>
                                <div class="flex text-yellow-400 text-2xl mb-3" id="avgRatingStars">
                                    <i class="fa-regular fa-star text-gray-300"></i>
                                    <i class="fa-regular fa-star text-gray-300"></i>
                                    <i class="fa-regular fa-star text-gray-300"></i>
                                    <i class="fa-regular fa-star text-gray-300"></i>
                                    <i class="fa-regular fa-star text-gray-300"></i>
                                </div>
                                <p class="text-sm text-gray-500">‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalReviewCount" class="font-bold text-gray-800 text-lg">0</span> ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p>
                            </div>

                            <div class="md:col-span-2 bg-white border border-gray-200 rounded-2xl p-0 h-[400px] flex flex-col shadow-sm overflow-hidden">
                                <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                                    <span class="text-sm font-bold text-gray-700">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                                    <span class="text-xs text-gray-400">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                                </div>
                                <div class="overflow-y-auto flex-1 p-4 space-y-3" id="feedbackList">
                                    <div class="text-center text-gray-400 py-20 flex flex-col items-center">
                                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
            </div>

            <div id="matrixPage" class="page hidden">
                <div class="max-w-7xl mx-auto space-y-6 p-4 lg:p-8 pb-24">
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i class="fa-solid fa-clipboard-list text-teal-600"></i> ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô PPE (PPE Matrix)
                                </h2>
                                <p class="text-sm text-gray-500 mt-1">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏≤‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
                            </div>
                            
                            <div class="flex gap-2 w-full md:w-auto">
                                <div class="relative flex-1 md:w-64">
                                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" id="matrixSearch" oninput="renderMatrixGrid()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°, Forklift)..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500">
                                </div>
                                <button id="btnAddMatrixRule" onclick="openMatrixModal()" class="hidden px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 shadow-sm whitespace-nowrap">
                                    <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏é
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex flex-wrap gap-2" id="jobTagsContainer">
                            </div>
                    </div>

                    <div id="matrixContentGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        </div>

                    <div id="matrixEmptyState" class="hidden flex flex-col items-center justify-center py-16 text-center bg-white rounded-xl border border-dashed border-gray-200">
                        <i class="fa-solid fa-helmet-safety text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</p>
                    </div>
                </div>
            </div>

            <div id="matrixRuleModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-gray-800"><i class="fa-solid fa-shield-halved text-teal-600 mr-2"></i>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                        <button onclick="document.getElementById('matrixRuleModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                    
                    <form id="matrixRuleForm" class="p-5 space-y-4 overflow-y-auto" onsubmit="saveMatrixRule(event)">
                        <input type="hidden" id="matrixId">
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô / ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà <span class="text-red-500">*</span></label>
                            <input type="text" id="matrixJob" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°, ‡∏Ç‡∏±‡∏ö Forklift, PD" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500" list="jobSuggestions">
                            <datalist id="jobSuggestions"></datalist>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label>
                            <input type="text" id="matrixDept" placeholder="‡πÄ‡∏ä‡πà‡∏ô PD, MTN, IE, ‡∏´‡∏£‡∏∑‡∏≠ All" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500">
                        </div>

                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <label class="block text-xs font-bold text-gray-700 mb-2">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) <span class="text-red-500">*</span></label>
                            
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="matrixItemInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" list="stockItemsList">
                                <datalist id="stockItemsList"></datalist> <button type="button" onclick="addMatrixItem()" class="bg-teal-600 text-white px-3 py-2 rounded-lg hover:bg-teal-700 text-sm font-bold">
                                    <i class="fa-solid fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°
                                </button>
                            </div>

                            <div id="selectedMatrixItemsContainer" class="space-y-2 max-h-32 overflow-y-auto">
                                </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ (Spec)</label>
                                <input type="text" id="matrixProps" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô, 27dBA" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-700 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
                                <input type="text" id="matrixLifespan" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 text-sm">
                            </div>
                        </div>

                        <div class="pt-2">
                            <button type="submit" class="w-full py-3 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 shadow-md transition-transform active:scale-95">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
        
        <nav id="mobileNav" class="lg:hidden bg-white border-t flex justify-around p-2 pb-safe text-xs text-gray-500 fixed bottom-0 w-full z-50 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <a onclick="showPage('dashboard')" class="nav-item-mobile flex flex-col items-center w-16 p-1 cursor-pointer transition-colors hover:text-teal-600 text-teal-600">
                <i class="fa-solid fa-chart-pie text-xl mb-1"></i> <span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
            </a>
            <a onclick="showPage('stock')" class="nav-item-mobile flex flex-col items-center w-16 p-1 cursor-pointer transition-colors hover:text-teal-600">
                <i class="fa-solid fa-boxes-stacked text-xl mb-1"></i> <span>‡∏™‡∏ï‡πá‡∏≠‡∏Å</span>
            </a>
            <a onclick="showPage('issue')" class="nav-item-mobile flex flex-col items-center w-16 p-1 cursor-pointer transition-colors hover:text-teal-600">
                <i class="fa-solid fa-file-export text-xl mb-1"></i> <span>‡πÄ‡∏ö‡∏¥‡∏Å</span>
            </a>
            <a onclick="showPage('loan')" class="nav-item-mobile flex flex-col items-center w-16 p-1 cursor-pointer transition-colors hover:text-teal-600">
                <i class="fa-solid fa-hand-holding-hand text-xl mb-1"></i> <span>‡∏¢‡∏∑‡∏°</span>
            </a>
            
            <div class="relative group">
                <a onclick="toggleMobileAdminMenu()" class="nav-item-mobile flex flex-col items-center w-16 p-1 cursor-pointer transition-colors hover:text-teal-600">
                    <i class="fa-solid fa-bars text-xl mb-1"></i> <span>‡πÄ‡∏°‡∏ô‡∏π</span>
                </a>
                
                <div id="mobileMoreMenu" class="hidden absolute bottom-16 right-2 mb-safe bg-white border border-gray-200 rounded-xl shadow-2xl w-56 p-2 space-y-1 z-50 animate-fade-in-up">
    
                    <a onclick="showPage('allHistory'); toggleMobileAdminMenu()" class="block px-4 py-3 hover:bg-gray-50 rounded-lg text-gray-700 font-medium flex items-center cursor-pointer">
                        <i class="fa-solid fa-clock-rotate-left mr-3 text-teal-500 w-5 text-center"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </a>

                    <a onclick="showPage('matrix'); toggleMobileAdminMenu()" class="block px-4 py-3 hover:bg-gray-50 rounded-lg text-gray-700 font-medium flex items-center cursor-pointer">
                        <i class="fa-solid fa-clipboard-list mr-3 text-teal-500 w-5 text-center"></i> ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô PPE
                    </a>

                    <div id="adminMobileLinks" class="hidden border-t pt-2 mt-2">
                        <p class="px-4 text-[10px] text-gray-400 font-bold uppercase mb-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ Admin</p>
                        <a onclick="showPage('pending'); toggleMobileAdminMenu()" class="block px-4 py-2.5 hover:bg-yellow-50 text-gray-700 hover:text-yellow-700 rounded-lg flex items-center cursor-pointer">
                            <i class="fa-solid fa-hourglass-half mr-3 text-yellow-500 w-5 text-center"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠
                        </a>
                        <a onclick="showPage('receive'); toggleMobileAdminMenu()" class="block px-4 py-2.5 hover:bg-teal-50 text-gray-700 hover:text-teal-700 rounded-lg flex items-center cursor-pointer">
                            <i class="fa-solid fa-truck-ramp-box mr-3 text-teal-500 w-5 text-center"></i> ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤
                        </a>
                        <a onclick="showPage('manage'); toggleMobileAdminMenu()" class="block px-4 py-2.5 hover:bg-blue-50 text-gray-700 hover:text-blue-700 rounded-lg flex items-center cursor-pointer">
                            <i class="fa-solid fa-gear mr-3 text-blue-500 w-5 text-center"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á
                        </a>
                        <a onclick="showPage('report'); toggleMobileAdminMenu()" class="block px-4 py-2.5 hover:bg-purple-50 text-gray-700 hover:text-purple-700 rounded-lg flex items-center cursor-pointer">
                            <i class="fa-solid fa-chart-line mr-3 text-purple-500 w-5 text-center"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        </a>
                        
                        </div>

                    <div class="border-t pt-2 mt-2">
                        <div id="userMobileLinks">
                            <a onclick="showLoginModal(); toggleMobileAdminMenu()" class="block px-4 py-3 hover:bg-teal-50 text-teal-600 rounded-lg font-medium flex items-center cursor-pointer">
                                <i class="fa-solid fa-user-shield mr-3 w-5 text-center"></i> Admin Login
                            </a>
                        </div>
                        
                        <a id="mobileLogoutBtn" onclick="logout(); toggleMobileAdminMenu()" class="hidden block px-4 py-3 hover:bg-red-50 text-red-600 rounded-lg font-medium flex items-center cursor-pointer">
                            <i class="fa-solid fa-right-from-bracket mr-3 w-5 text-center"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </a>
                    </div>
                </div>
            </div>
        </nav>
    </div>
</div>

<div id="loginModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm m-4 relative">
        <h3 class="text-xl font-semibold mb-6 text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h3>
        <button onclick="hideLoginModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        
        <form id="loginForm" class="space-y-4">
            <div>
                <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</label>
                <input type="text" id="loginUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
            </div>
            
            <div>
                <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
                <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required>
            </div>

            <div class="flex items-center mt-3 mb-1">
                <input id="rememberMe" type="checkbox" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded cursor-pointer">
                <label for="rememberMe" class="ml-2 block text-sm text-gray-900 cursor-pointer select-none">
                    ‡∏à‡∏≥‡∏â‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡πÜ)
                </label>
            </div>

            <button type="submit" class="w-full bg-teal-600 text-white py-2.5 rounded-lg hover:bg-teal-700 transition-colors font-medium">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </form>
    </div>
</div>

<div id="voucherModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 hidden"></div>
<div id="approvalModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 hidden"></div>

<div id="confirmationModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"></div>
    
    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-0 sm:p-4">
        
        <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-xl shadow-2xl transform transition-all p-6 animate-slide-up sm:animate-none">
            
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden"></div>

            <h3 class="text-xl font-bold mb-3 text-gray-800 flex items-center gap-2" id="confirmationTitle">
                <i class="fa-solid fa-circle-question text-teal-600"></i>
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
            </h3>
            
            <p class="text-gray-600 mb-8 text-base leading-relaxed" id="confirmationMessage">
                ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?
            </p>
            
            <div class="flex gap-3">
                <button id="confirmCancelBtn" class="flex-1 py-3.5 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 font-semibold transition-colors active:scale-95">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button id="confirmProceedBtn" class="flex-1 py-3.5 bg-teal-600 text-white rounded-xl hover:bg-teal-700 font-semibold shadow-lg shadow-teal-200 transition-all active:scale-95">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                </button>
            </div>
        </div>
    </div>
</div>

<div id="categoryManagementModal" class="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md m-4 relative">
        <button onclick="hideCategoryModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        <h3 class="text-xl font-semibold mb-6 text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
        
        <form id="categoryForm" class="mb-6 flex items-center gap-3">
            <input type="hidden" id="editCategoryId">
            <input type="text" id="categoryNameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà..." required class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            <button type="submit" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </form>

        <div id="categoryListContainer" class="space-y-2 max-h-64 overflow-y-auto pr-2 border-t pt-4">
            </div>
    </div>
</div>

<div id="itemSelectorModal" class="fixed inset-0 bg-black/60 modal-backdrop flex items-center justify-center z-[60] hidden">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl m-4 flex flex-col max-h-[90vh]">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-xl">
            <h3 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-boxes-stacked mr-2 text-teal-600"></i>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
            <button onclick="closeItemSelector()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        
        <div class="p-4 border-b border-gray-200 bg-white">
            <input type="text" id="selectorSearch" onkeyup="renderSelectorItems()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
        </div>

        <div id="selectorGrid" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50">
            </div>
    </div>
</div>

<div id="imagePreviewModal" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeImagePreview()">
    <button class="absolute top-6 right-6 text-white text-5xl hover:text-gray-300 transition-colors">&times;</button>
    <img id="previewImage" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl animate-pulse">
</div>

<div id="timelineDetailModal" class="fixed inset-0 bg-gray-900/60 hidden items-center justify-center z-[60] backdrop-blur-sm px-4">
    <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden animate-bounce-in">
        
        <div class="bg-teal-600 px-5 py-4 flex justify-between items-center">
            <h3 class="text-lg font-bold text-white"><i class="fa-solid fa-box-open mr-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å</h3>
            <button onclick="document.getElementById('timelineDetailModal').classList.add('hidden'); document.getElementById('timelineDetailModal').classList.remove('flex')" class="text-white/80 hover:text-white transition-colors">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <div id="timelineItemsList" class="p-5 space-y-3 max-h-[60vh] overflow-y-auto bg-gray-50">
            </div>

        <div class="p-4 border-t border-gray-100 bg-white">
            <button onclick="document.getElementById('timelineDetailModal').classList.add('hidden'); document.getElementById('timelineDetailModal').classList.remove('flex')" class="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            </button>
        </div>
    </div>
</div>

<!-- üîí Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
  <div class="bg-white rounded-xl p-6 flex flex-col items-center gap-4 w-72">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
    <div class="text-center">
      <p class="font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</p>
      <p class="text-sm text-gray-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‚Ä¶</p>
    </div>
  </div>
</div>

<div id="slipModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
    
    <div class="bg-gray-100 rounded-lg shadow-2xl max-w-sm w-full overflow-hidden flex flex-col max-h-[90vh]">
        
        <div class="flex justify-end p-2 bg-transparent absolute top-2 right-2 z-10">
            <button onclick="closeSlip()" class="w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70 backdrop-blur-md">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <div class="overflow-y-auto no-scrollbar">
            <div id="slipContent" class="bg-white m-4 p-6 rounded-xl shadow-sm relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-teal-500 via-emerald-500 to-teal-500"></div>
                
                <div class="text-center mb-6 pt-2">
                    <div class="w-16 h-16 bg-teal-50 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fa-solid fa-clipboard-check text-3xl text-teal-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
                    <p class="text-xs text-gray-500" id="slipDate">14 ‡∏°.‡∏Ñ. 67 ‚Ä¢ 10:30</p>
                </div>

                <div class="border-b-2 border-dashed border-gray-200 mb-6 relative">
                    <div class="absolute -left-8 -bottom-3 w-6 h-6 bg-gray-100 rounded-full"></div>
                    <div class="absolute -right-8 -bottom-3 w-6 h-6 bg-gray-100 rounded-full"></div>
                </div>

                <div class="space-y-4 mb-6">
                    <div class="flex justify-between items-start">
                        <span class="text-xs text-gray-400">‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å</span>
                        <span class="text-sm font-bold text-gray-800 text-right w-2/3" id="slipUser">-</span>
                    </div>
                    <div class="flex justify-between items-start">
                        <span class="text-xs text-gray-400">‡πÅ‡∏ú‡∏ô‡∏Å</span>
                        <span class="text-sm font-medium text-gray-600 text-right w-2/3" id="slipDept">-</span>
                    </div>
                    <div class="flex justify-between items-start">
                        <span class="text-xs text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        <span class="text-sm font-mono text-gray-600" id="slipRef">-</span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-3 mb-6">
                    <p class="text-xs text-gray-400 mb-2 uppercase font-bold tracking-wider">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p>
                    <div id="slipItemsList" class="space-y-2">
                        </div>
                </div>

                <div class="text-center pt-2">
                    <div class="text-[10px] text-gray-400 mb-2">Scan to check status</div>
                    <div class="bg-white p-1 inline-block border border-gray-100 rounded">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=PPE_System" class="w-16 h-16 opacity-80 mix-blend-multiply">
                    </div>
                    <p class="text-[10px] text-teal-600 mt-2 font-bold">PPE Stock Management System</p>
                </div>

                <div class="absolute -bottom-3 left-0 w-full flex justify-between px-2">
                    <div class="w-4 h-4 bg-gray-100 rounded-full"></div>
                    <div class="w-4 h-4 bg-gray-100 rounded-full"></div>
                    <div class="w-4 h-4 bg-gray-100 rounded-full"></div>
                    <div class="w-4 h-4 bg-gray-100 rounded-full"></div>
                    <div class="w-4 h-4 bg-gray-100 rounded-full"></div>
                    <div class="w-4 h-4 bg-gray-100 rounded-full"></div>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-gray-200">
            <button onclick="closeSlip()" class="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-all active:scale-95">
                ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            </button>
        </div>
    </div>
</div>

<div id="imagePreviewModal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fade-in">
    <div class="relative w-full max-w-[350px]">
        <button onclick="closeImagePreview()" class="absolute -top-12 right-0 text-white p-2 bg-white/20 rounded-full hover:bg-white/40 transition-colors">
            <i class="fa-solid fa-xmark text-lg w-6 h-6 flex items-center justify-center"></i>
        </button>
        
        <div class="bg-white p-3 rounded-2xl shadow-2xl text-center relative">
            <div class="mb-3">
                <h4 class="text-gray-800 font-bold"><i class="fa-solid fa-floppy-disk mr-2 text-teal-600"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏•‡∏¥‡∏õ</h4>
                <p class="text-sm text-teal-600 font-medium animate-pulse">üì≤ ‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
            </div>
            
            <div id="generatedImageContainer" class="overflow-hidden rounded-xl border-2 border-teal-100 shadow-sm">
                </div>
        </div>
    </div>
</div>

<div id="feedbackModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col transform transition-all scale-100">
        
        <div class="bg-gradient-to-r from-teal-600 to-teal-500 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold flex items-center gap-2 text-lg">
                <i class="fa-solid fa-star text-yellow-300"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
            </h3>
            <button onclick="closeFeedbackModal()" class="text-white/80 hover:text-white transition-colors bg-white/20 rounded-full w-8 h-8 flex items-center justify-center">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="p-6 flex flex-col items-center gap-5">
            <input type="hidden" id="feedbackTransactionId">
            <input type="hidden" id="feedbackItemId">
            <input type="hidden" id="feedbackType"> <div class="flex flex-col items-center">
                <div class="w-24 h-24 bg-gray-50 rounded-2xl flex items-center justify-center overflow-hidden border-2 border-gray-100 shadow-sm mb-3">
                    <img id="feedbackItemImg" src="" class="w-full h-full object-contain p-2">
                </div>
                <h4 class="font-bold text-gray-800 text-lg text-center leading-tight" id="feedbackItemName">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h4>
                <p class="text-xs text-gray-400 mt-1">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?</p>
            </div>

            <div class="flex gap-3 justify-center" id="starContainer">
                <button onclick="setRating(1)" class="star-btn text-4xl text-gray-200 hover:text-yellow-400 transition-transform hover:scale-110 active:scale-95" data-val="1"><i class="fa-solid fa-star"></i></button>
                <button onclick="setRating(2)" class="star-btn text-4xl text-gray-200 hover:text-yellow-400 transition-transform hover:scale-110 active:scale-95" data-val="2"><i class="fa-solid fa-star"></i></button>
                <button onclick="setRating(3)" class="star-btn text-4xl text-gray-200 hover:text-yellow-400 transition-transform hover:scale-110 active:scale-95" data-val="3"><i class="fa-solid fa-star"></i></button>
                <button onclick="setRating(4)" class="star-btn text-4xl text-gray-200 hover:text-yellow-400 transition-transform hover:scale-110 active:scale-95" data-val="4"><i class="fa-solid fa-star"></i></button>
                <button onclick="setRating(5)" class="star-btn text-4xl text-gray-200 hover:text-yellow-400 transition-transform hover:scale-110 active:scale-95" data-val="5"><i class="fa-solid fa-star"></i></button>
            </div>
            <input type="hidden" id="feedbackScore" value="0">

            <div class="w-full">
                <label class="text-xs font-semibold text-gray-500 ml-1 mb-1 block">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <textarea id="feedbackComment" rows="3" class="w-full border border-gray-200 bg-gray-50 rounded-xl p-3 text-sm focus:ring-2 focus:ring-teal-500 focus:bg-white outline-none resize-none transition-all" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏™‡πà‡∏™‡∏ö‡∏≤‡∏¢, ‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô, ‡∏ä‡∏≥‡∏£‡∏∏‡∏î‡∏á‡πà‡∏≤‡∏¢..."></textarea>
            </div>
        </div>

        <div class="p-4 border-t border-gray-100 bg-gray-50 flex gap-3">
            <button onclick="closeFeedbackModal()" class="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-200 rounded-xl transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="submitFeedback()" class="flex-1 py-3 bg-teal-600 text-white font-bold rounded-xl hover:bg-teal-700 shadow-lg shadow-teal-200 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none" id="btnSubmitFeedback" disabled>
                ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
            </button>
        </div>
    </div>
</div>

<div id="rateItemSelectorModal" class="fixed inset-0 z-[65] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[85vh]">
        
        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-teal-50">
            <h3 class="font-bold text-teal-800 flex items-center gap-2">
                <i class="fa-solid fa-star-half-stroke"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
            </h3>
            <button id="btnCloseRateSelector" onclick="closeRateSelector()" class="text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-3 overflow-y-auto space-y-2 flex-1 bg-gray-50/50" id="rateItemList">
            </div>

        <div class="p-4 border-t border-gray-100 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10">
            <button id="btnFinishRating" onclick="finishMandatoryRating()" class="w-full py-3 rounded-xl font-bold transition-all shadow-md flex items-center justify-center gap-2 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed bg-teal-600 text-white hover:bg-teal-700 active:scale-95" disabled>
                <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô</span>
            </button>
        </div>
    </div>
</div>

<script>
    // ===========================================
    // API Configuration
    // ===========================================
    const WEB_APP_URL = "/api/ppe";
    const ADMIN_USER_ID = 'Ucadb3c0f63ada96c0432a0aede267ff9';
    const CURRENT_ADMIN_NAME = window.currentAdminName || 'Admin';

    /**
     * Central function to call the Google Apps Script API.
     * @param {string} action - The function name to call in Code.gs.
     * @param {object} [payload=null] - The data to send.
     * @returns {Promise<any>} - A promise that resolves with the response data.
     */
    function formatThaiDateTime(date = new Date()) {
        return date.toLocaleString('th-TH', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    async function callServerFunction(action, payload = null) {
        showLoading();
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify({ action: action, payload: payload })
            });

            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.status === 'error') {
                throw new Error(result.message);
            }
            
            return result.data;

        } catch (error) {
            console.error(`API call failed for action "${action}":`, error);
            onFailure(error); // Call onFailure directly
            throw error; // Re-throw to stop promise chain if needed
        } finally {
            hideLoading();
        }
    }

    // ===========================================
    // State & Initialization
    // ===========================================
    let isAdmin = false;
    let currentData = { ppeItems: [], issueVouchers: [], receiveTransactions: [], loanTransactions: [], categories: [], dashboardMetrics: {} };
    let categoryChartInstance = null;
    let topIssuedItemsChartInstance = null;

    document.addEventListener('DOMContentLoaded', () => {
        initializeApp(true);
        setupEventListeners();
        showPage('dashboard');
        resetIssueForm();
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
    let liffProfile = null;
    const LIFF_ID = "2007053300-JTSerFbF"; // **‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì**

    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç initializeApp (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
    async function initializeApp(isFirstLoad = false) {
        if (localStorage.getItem('ppe_admin_session') === 'true') {
            isAdmin = true;
            console.log("Auto-logged in as Admin");
        }
        // üëáüëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏´‡∏°
        const params = new URLSearchParams(window.location.search);
        const isConfirmMode = params.get('mode') === 'confirmReceive';

        if (isConfirmMode) {
            showLoading(); // üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÅ‡∏™‡∏î‡∏á Loading Overlay)
        } else if (isFirstLoad) {
            showDashboardSkeleton(); // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏ä‡∏ß‡πå Skeleton
        }
        // üëÜüëÜ ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
        
        try {
            // 1. Initialize LIFF
            await liff.init({ liffId: LIFF_ID });
            
            if (liff.isLoggedIn()) {
                liffProfile = await liff.getProfile();
                console.log("Logged in as:", liffProfile.displayName);

                // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‚≠ê‚≠ê‚≠ê
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                await handleLiffConfirmReceive();

                // ‡πÇ‡∏´‡∏°‡∏î User ‡∏õ‡∏Å‡∏ï‡∏¥
                if (!isAdmin) {
                    setupUserInterface();
                }
            } else {
                liff.login(); // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Login ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô External Browser
                return; // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            }

            // 2. Load Data (Logic ‡πÄ‡∏î‡∏¥‡∏°)
            const data = await callServerFunction('getInitialData');
            onDataLoaded(data);

        } catch (err) {
            console.error('LIFF/App Error:', err);
            setupUserInterface();
        }
    }


    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    function setupUserInterface() {
        // 1. ‡∏ã‡πà‡∏≠‡∏ô Element ‡∏Ç‡∏≠‡∏á Admin/Desktop ‡πÄ‡∏î‡∏¥‡∏°
        const sidebar = document.querySelector('aside');
        if (sidebar) sidebar.classList.add('hidden');
        
        const header = document.querySelector('header');
        if (header) header.classList.add('hidden');

        // ‡∏ã‡πà‡∏≠‡∏ô Admin Menu ‡πÉ‡∏ô Mobile Bottom Nav (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        const adminMenuMobile = document.getElementById('adminMenuMobile');
        if (adminMenuMobile) adminMenuMobile.classList.add('hidden');

        // 2. ‡∏õ‡∏£‡∏±‡∏ö Dashboard ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô User Dashboard
        renderUserDashboard();
        
        // 3. ‡πÅ‡∏™‡∏î‡∏á Bottom Nav (Nav ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ï‡∏¥‡∏° \\ ‡∏´‡∏ô‡πâ‡∏≤ : ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ SyntaxError
        const mobileNav = document.querySelector('nav.lg\\:hidden'); 
        if (mobileNav) mobileNav.classList.remove('hidden');

        // 4. Auto-fill ‡∏ä‡∏∑‡πà‡∏≠
        autoFillUserIdentity();
    }
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ function onDataLoaded(data) { ... } ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏™‡πâ‡πÉ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
    function onDataLoaded(data) {
        console.log("Data loaded:", data); // ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Console (‡∏Å‡∏î F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå
        currentData = data;

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡∏Å‡∏£‡∏ì‡∏µ Backend ‡∏•‡∏∑‡∏°‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤
        if (!currentData.dashboardMetrics) currentData.dashboardMetrics = {};
        if (!currentData.ppeItems) currentData.ppeItems = [];
        if (!currentData.issueVouchers) currentData.issueVouchers = [];

        window.departments = data.departments || [];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å
        renderDepartmentSelect(); 

        // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        updateUI(); 
        
        // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ã‡πà‡∏≠‡∏ô Loading Skeleton (‡∏ï‡∏±‡∏ß‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÜ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏£‡∏¥‡∏á
        hideDashboardSkeleton();
    }

    function onFailure(error) {
        // The error is already logged in callServerFunction, so we just update the UI
        hideLoading();
        hideDashboardSkeleton();
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    }

    function updateUI() {
        if (!currentData || !currentData.ppeItems) return;
        
        // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Element ‡∏ï‡πà‡∏≤‡∏á‡πÜ
        const adminPanel = document.getElementById('adminDashboardPanel');
        const userPanel = document.getElementById('userDashboardPanel');
        const sidebar = document.querySelector('aside');
        const header = document.querySelector('header');
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        const mobileNav = document.getElementById('mobileNav');
        const adminMobileLinks = document.getElementById('adminMobileLinks');
        const userMobileLinks = document.getElementById('userMobileLinks');
        
        // --- 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏õ‡∏∏‡πà‡∏° Logout ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ---
        const mobileLogoutBtn = document.getElementById('mobileLogoutBtn'); 
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏°‡∏ô‡∏π Sidebar Admin
        const adminMenu = document.getElementById('adminMenu');

        if (isAdmin) {
            // === ‡πÇ‡∏´‡∏°‡∏î ADMIN ===
            
            // 1. ‡πÄ‡∏õ‡∏¥‡∏î Dashboard Admin
            if(adminPanel) adminPanel.classList.remove('hidden');
            if(userPanel) userPanel.classList.add('hidden');

            // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Sidebar & Header
            if(sidebar) {
                sidebar.classList.remove('hidden'); 
                sidebar.classList.add('hidden', 'lg:flex'); 
            }
            if(header) header.classList.remove('hidden'); 

            // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô Sidebar
            if(adminMenu) adminMenu.classList.remove('hidden');

            // 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            if(mobileNav) mobileNav.classList.remove('hidden');
            
            // 5. ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏™‡πâ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á Admin
            if(adminMobileLinks) adminMobileLinks.classList.remove('hidden');
            if(userMobileLinks) userMobileLinks.classList.add('hidden');

            // --- 2. ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° Logout (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin) ---
            if(mobileLogoutBtn) mobileLogoutBtn.classList.remove('hidden');

            updateDashboard();

        } else {
            // === ‡πÇ‡∏´‡∏°‡∏î USER ===
            
            // 1. ‡πÄ‡∏õ‡∏¥‡∏î Dashboard User
            if(adminPanel) adminPanel.classList.add('hidden');
            if(userPanel) userPanel.classList.remove('hidden');

            // 2. ‡∏õ‡∏¥‡∏î Sidebar & Header Admin
            if(sidebar) sidebar.classList.add('hidden'); 
            if(header) header.classList.add('hidden');

            // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            if(mobileNav) mobileNav.classList.remove('hidden');
            
            // 4. ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏™‡πâ‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á User
            if(adminMobileLinks) adminMobileLinks.classList.add('hidden');
            if(userMobileLinks) userMobileLinks.classList.remove('hidden');

            // --- 3. ‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° Logout (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User) ---
            if(mobileLogoutBtn) mobileLogoutBtn.classList.add('hidden');

            renderUserDashboard();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ
        updateAllTablesAndLists();
        populateAllDropdowns();
        if(typeof renderCategoryList === 'function') renderCategoryList();

        renderFeedbackSection();
    }

    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showPage ‡πÄ‡∏î‡∏¥‡∏°
    function showPage(pageName) { 
        document.querySelectorAll('.page-container > .page').forEach(page => {
            if (page.id !== `${pageName}Page`) page.classList.add('hidden');
        });
        const pageElement = document.getElementById(pageName + 'Page');
        if (pageElement) pageElement.classList.remove('hidden');

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Active Tab
        document.querySelectorAll('.nav-item, .nav-item-mobile').forEach(item => {
            item.classList.remove('bg-teal-50', 'text-teal-600', 'font-bold');
        });

        // ‚≠ê‚≠ê‚≠ê ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Report ‚≠ê‚≠ê‚≠ê
        if (pageName === 'report') {
            if (!isAdmin) {
                showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return showPage('dashboard');
            }
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô initReportPage ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞)
            if(typeof initReportPage === 'function') {
                initReportPage(); 
            }
        }

        // ‚≠ê‚≠ê‚≠ê ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π ‚≠ê‚≠ê‚≠ê
        if (pageName === 'matrix') {
            initMatrixPage();
        }

        // --- Dashboard ---
        if (pageName === 'dashboard') {
            if (isAdmin) {
                updateDashboard();
            } else {
                renderUserDashboard();
            }
        }

        if (pageName === 'allHistory') {
            updateHistoryTable();
            updateLoanHistoryTable();
            showHistoryTab('issue');
        }

        // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        if (pageName === 'issue') {
            bindIssueUserModeRadios();
        }

        if (pageName === 'loan') {
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ú‡∏π‡∏Å event radio button
            bindLoanUserModeRadios(); 
            
            // Auto-fill ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î LINE
            const loanLineRadio = document.querySelector('input[name="loanUserMode"][value="line"]');
            if (loanLineRadio && loanLineRadio.checked && typeof autoFillUserIdentity === 'function') {
                autoFillUserIdentity();
            }
        }
    }

    // ===========================================
    // üé® FLEX MESSAGE GENERATORS (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    // ===========================================

    // 1. Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á" (‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ + ‡∏ä‡∏∑‡πà‡∏≠ + ‡πÅ‡∏ú‡∏ô‡∏Å)
    function createIssueFlex(voucherId, user, dept, items, status = '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
        const itemContents = items.map(item => {
            const ppe = currentData.ppeItems.find(p => p.id == item.itemId);
            const itemName = ppe ? ppe.name : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            const imgUrl = (ppe && ppe.image_url) ? ppe.image_url : 'https://placehold.co/100?text=No+Img';
            
            return {
                type: "box", layout: "horizontal", spacing: "md", margin: "sm",
                contents: [
                    { type: "image", url: imgUrl, flex: 1, aspectRatio: "1:1", aspectMode: "cover" },
                    { type: "box", layout: "vertical", flex: 4, contents: [
                        { type: "text", text: itemName, size: "sm", color: "#333333", wrap: true, weight: "bold" },
                        { type: "text", text: `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity}`, size: "xs", color: "#999999" }
                    ]}
                ]
            };
        });

        return {
            type: "flex",
            altText: `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å #${voucherId} ‡πÇ‡∏î‡∏¢ ${user}`,
            contents: {
                type: "bubble",
                header: { type: "box", layout: "vertical", contents: [{ type: "text", text: "üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", weight: "bold", color: "#ffffff", size: "md" }], backgroundColor: "#F59E0B", paddingAll: "lg" },
                body: {
                    type: "box", layout: "vertical", spacing: "md",
                    contents: [
                        { type: "text", text: `#${voucherId}`, weight: "bold", size: "xl", align: "center" },
                        { type: "box", layout: "vertical", spacing: "xs", contents: [
                            { type: "text", text: `üë§ ‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: ${user}`, size: "xs", color: "#666666" },
                            { type: "text", text: `üè¢ ‡πÅ‡∏ú‡∏ô‡∏Å: ${dept}`, size: "xs", color: "#666666" }
                        ]},
                        { type: "separator", margin: "md" },
                        { type: "box", layout: "vertical", contents: itemContents }
                    ]
                },
                footer: { type: "box", layout: "vertical", contents: [{ type: "text", text: `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}`, color: "#aaaaaa", size: "xs", align: "center" }] }
            }
        };
    }

    // üé® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô index.html (‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å createIssueFlex ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Flex Message ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
    function createLoanFlex(item, user, dept, dueDate) {
        const itemImg = item.image_url || 'https://placehold.co/100?text=Tool';
        const dateText = new Date(dueDate).toLocaleDateString('th-TH', { 
            year: 'numeric', month: 'short', day: 'numeric' 
        });

        return {
            type: "flex",
            altText: `‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°: ${item.name}`,
            contents: {
                type: "bubble",
                size: "mega",
                header: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        { type: "text", text: "üõ†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", weight: "bold", color: "#ffffff", size: "md" }
                    ],
                    backgroundColor: "#0EA5E9", // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤ Sky Blue
                    paddingAll: "lg"
                },
                hero: {
                    type: "image",
                    url: itemImg,
                    size: "full",
                    aspectRatio: "20:13",
                    aspectMode: "cover"
                },
                body: {
                    type: "box",
                    layout: "vertical",
                    spacing: "md",
                    contents: [
                        {
                            type: "text",
                            text: item.name,
                            weight: "bold",
                            size: "xl",
                            wrap: true
                        },
                        {
                            type: "box",
                            layout: "vertical",
                            spacing: "sm",
                            contents: [
                                {
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        { type: "text", text: "‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°", color: "#aaaaaa", size: "sm", flex: 2 },
                                        { type: "text", text: user, wrap: true, color: "#666666", size: "sm", flex: 5 }
                                    ]
                                },
                                {
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        { type: "text", text: "‡πÅ‡∏ú‡∏ô‡∏Å", color: "#aaaaaa", size: "sm", flex: 2 },
                                        { type: "text", text: dept, wrap: true, color: "#666666", size: "sm", flex: 5 }
                                    ]
                                },
                                {
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        { type: "text", text: "‡∏Ñ‡∏∑‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô", color: "#aaaaaa", size: "sm", flex: 2 },
                                        { type: "text", text: dateText, weight: "bold", color: "#EF4444", size: "sm", flex: 5 }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                footer: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        { type: "text", text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î", size: "xs", color: "#aaaaaa", align: "center" }
                    ]
                }
            }
        };
    }


    function setupEventListeners() {
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('manageForm').addEventListener('submit', handleManageSubmit);
        document.getElementById('receiveForm').addEventListener('submit', handleReceiveSubmit);
        document.getElementById('loanForm').addEventListener('submit', handleBorrowSubmit);
        document.getElementById('categoryForm').addEventListener('submit', handleSaveCategory);
        
        // üëáüëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!) üëáüëá
        document.getElementById('issueForm').addEventListener('submit', saveIssueVoucher);
        
        const debouncedFilterStock = debounce(filterStock, 300);
        document.getElementById('stockSearch').addEventListener('input', debouncedFilterStock);
        document.getElementById('categoryFilter').addEventListener('change', filterStock);
        // ‡πÉ‡∏ô setupEventListeners()
        document.getElementById('historySearch').addEventListener('input', (e) => {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            const query = e.target.value;
            updateHistoryTable(query);
            updateLoanHistoryTable(query);
        });
    }

    // ===========================================
    // UI Control & Helpers
    // ===========================================
    function showLoading() {
        const el = document.getElementById('loadingOverlay');
        if (el) el.classList.remove('hidden');
    }

    function hideLoading() {
        const el = document.getElementById('loadingOverlay');
        if (el) el.classList.add('hidden');
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Error ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    function showDashboardSkeleton() {
        const adminPanel = document.getElementById('adminDashboardPanel');
        const userPanel = document.getElementById('userDashboardPanel');
        const skeleton = document.getElementById('dashboardSkeleton');
        
        if(adminPanel) adminPanel.classList.add('hidden');
        if(userPanel) userPanel.classList.add('hidden');
        if(skeleton) skeleton.classList.remove('hidden');
    }

    function hideDashboardSkeleton() {
        const skeleton = document.getElementById('dashboardSkeleton');
        if(skeleton) skeleton.classList.add('hidden');
    }
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        const bgColor = type === 'success' ? 'bg-teal-500' : 'bg-red-500';
        toast.className = `toast p-4 rounded-lg shadow-lg text-white ${bgColor} flex items-center space-x-3`;
        toast.innerHTML = `<i class="fas ${icon} text-xl"></i><span>${message}</span>`;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('hide');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }

    function showHistoryTab(tabName) {
        document.querySelectorAll('.history-tab-content').forEach(content => content.classList.add('hidden'));
        document.querySelectorAll('.history-tab').forEach(tab => {
            tab.classList.remove('border-teal-500', 'text-teal-600');
            tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'border-transparent');
        });
        document.getElementById(tabName + 'HistoryTab').classList.remove('hidden');
        const activeTab = document.querySelector(`.history-tab[onclick="showHistoryTab('${tabName}')"]`);
        activeTab.classList.add('border-teal-500', 'text-teal-600');
    }
    function createEmptyState(message, iconClass) {
        return `<div class="text-center py-12 px-6"><div class="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center"><i class="${iconClass} text-3xl text-gray-400"></i></div><p class="mt-4 text-gray-500">${message}</p></div>`;
    }
    function debounce(func, delay) {
        let timeout;
        return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
    }

    // ===========================================
    // Authentication
    // ===========================================
    function handleLogin(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const remember = document.getElementById('rememberMe').checked; // ‚≠ê 1. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Checkbox
        
        showLoading();
        callServerFunction('checkAdminCredentials', { username, password })
            .then(isValid => {
                hideLoading();
                if (isValid) {
                    isAdmin = true;
                    hideLoginModal();
                    
                    // ‚≠ê‚≠ê‚≠ê 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏Ñ‡πà‡∏≤ ‚≠ê‚≠ê‚≠ê
                    if (remember) {
                        localStorage.setItem('ppe_admin_session', 'true');
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ß‡∏¢‡πÜ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
                        localStorage.setItem('ppe_admin_name', username); 
                    }
                    // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚≠ê‚≠ê‚≠ê

                    updateUI(); 
                    showPage('dashboard');
                    showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                } else {
                    showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                }
            })
            .catch(err => {
                hideLoading();
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            });
    }

    function logout() {
        isAdmin = false;
        
        // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏â‡∏±‡∏ô ‚≠ê‚≠ê‚≠ê
        localStorage.removeItem('ppe_admin_session');
        localStorage.removeItem('ppe_admin_name');
        // ‚≠ê‚≠ê‚≠ê ------------------------- ‚≠ê‚≠ê‚≠ê

        updateUI();
        showPage('dashboard');
        showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    }

    function updateAdminUI() {
        const adminElements = ['adminMenu', 'adminMenuMobile'];
        const loginElements = ['loginSection', 'loginSectionMobile'];
        const logoutElements = ['logoutSection', 'logoutSectionMobile'];
        if (isAdmin) {
            adminElements.forEach(id => document.getElementById(id).classList.remove('hidden'));
            loginElements.forEach(id => document.getElementById(id).classList.add('hidden'));
            logoutElements.forEach(id => document.getElementById(id).classList.remove('hidden'));
        } else {
            adminElements.forEach(id => document.getElementById(id).classList.add('hidden'));
            loginElements.forEach(id => document.getElementById(id).classList.remove('hidden'));
            logoutElements.forEach(id => document.getElementById(id).classList.add('hidden'));
        }
    }
    function showLoginModal() { document.getElementById('loginModal').classList.remove('hidden'); }
    function hideLoginModal() { document.getElementById('loginModal').classList.add('hidden'); }

    // ===========================================
    // Data Population & Updates
    // ===========================================
    function updateAllTablesAndLists() {
        filterStock();
        updateHistoryTable();
        updatePendingTable();
        updateManageItemsList();
        updateOnLoanTable();
        updateLoanHistoryTable();
    }
    function populateAllDropdowns() {
        const categoryOptions = [...currentData.categories]
            .sort((a,b) => a.name.localeCompare(b.name))
            .map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà)
        const catFilter = document.getElementById('categoryFilter');
        if (catFilter) catFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>' + categoryOptions;
        
        const itemCat = document.getElementById('itemCategory');
        if (itemCat) itemCat.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>' + categoryOptions;

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const allItemOptions = currentData.ppeItems
            .sort((a,b) => a.name.localeCompare(b.name))
            .map(item => `<option value="${item.id}">${item.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock})</option>`).join('');
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà) ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ "‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤"
        document.querySelectorAll('.item-select').forEach(select => {
            const selectedValue = select.value;
            select.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>' + allItemOptions;
            if(selectedValue) select.value = selectedValue;
        });
        
        const receiveSelect = document.getElementById('receiveItem');
        if (receiveSelect) receiveSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>' + allItemOptions;

        // ‚ùå ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô loanItem ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Visual Selector ‡πÅ‡∏•‡πâ‡∏ß
        // const loanableItems = ... (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
    }

    // ===========================================
    // Dashboard Rendering (Safe Mode)
    function updateDashboard() {
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏≤ element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠) ---
        if (!isAdmin || !document.getElementById('totalItems')) return; 

        const { ppeItems, issueVouchers, dashboardMetrics } = currentData;
        
        // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö (‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô) ‚≠ê‚≠ê‚≠ê
        const dateEl = document.getElementById('currentDateDisplay');
        if(dateEl) {
            dateEl.textContent = new Date().toLocaleDateString('th-TH', { 
                day: 'numeric', month: 'short', year: '2-digit' 
            });
        }
        // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚≠ê‚≠ê‚≠ê

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÉ‡∏™‡πà if ‡∏î‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå)
        if(document.getElementById('totalItems')) document.getElementById('totalItems').textContent = ppeItems.length;
        if(document.getElementById('lowStockItems')) document.getElementById('lowStockItems').textContent = ppeItems.filter(item => Number(item.stock) <= Number(item.reorderPoint)).length;
        if(document.getElementById('outOfStockItems')) document.getElementById('outOfStockItems').textContent = ppeItems.filter(item => Number(item.stock) === 0).length;
        if(document.getElementById('pendingVouchers')) document.getElementById('pendingVouchers').textContent = issueVouchers.filter(v => v.status === 'pending').length;
        if(document.getElementById('totalStockValue')) document.getElementById('totalStockValue').textContent = `‡∏ø${(dashboardMetrics.totalStockValue || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏π‡∏Å (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏î‡πâ‡∏ß‡∏¢)
        updateLowStockList();
        updateOverdueLoansList();
        updateCategoryChart();
        updateTopIssuedItemsChart();
        updateRecentActivityFeed();
    }

    // ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏π‡∏Å‡∏î‡πâ‡∏ß‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ container ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
    function updateLowStockList() {
        const container = document.getElementById('lowStockList');
        if (!container) return; // <--- ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î

        const attentionItems = currentData.ppeItems
            .filter(item => Number(item.stock) <= Number(item.reorderPoint))
            .sort((a, b) => a.stock - b.stock);
        
        if (attentionItems.length === 0) {
            container.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°', 'fa-solid fa-thumbs-up');
            return;
        }
        
        container.innerHTML = attentionItems.map(item => `
            <div class="flex justify-between items-center p-2.5 border-b last:border-0">
                <div><p class="font-medium text-sm text-gray-700">${item.name}</p><p class="text-xs text-gray-500">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock}</p></div>
                <span class="text-xs font-bold ${item.stock==0?'text-red-600':'text-orange-500'}">${item.stock==0?'‡∏´‡∏°‡∏î':'‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î'}</span>
            </div>`).join('');
    }


    function updateOverdueLoansList() {
        const container = document.getElementById('overdueLoansList');
        if (!container) return; // ‡∏î‡∏±‡∏Å Error

        const overdue = currentData.loanTransactions.filter(l => l.status === 'on_loan' && new Date(l.dueDate) < new Date());
        if (overdue.length === 0) {
            container.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î', 'fa-solid fa-check-circle');
            return;
        }
        container.innerHTML = overdue.map(l => `
            <div class="flex justify-between items-center p-2 border-b last:border-0 bg-red-50">
                <span class="text-sm text-gray-700">${l.borrowerName}</span>
                <span class="text-xs text-red-600 font-bold">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>
            </div>`).join('');
    }

    function updateRecentActivityFeed() {
        const container = document.getElementById('recentActivityFeed');
        if (!container) return; // ‡∏î‡∏±‡∏Å Error ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

        const activities = currentData.dashboardMetrics.recentActivities || [];
        if (activities.length === 0) {
            container.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î', 'fa-solid fa-bell-slash');
            return;
        }
        container.innerHTML = activities.map(activity => {
            const timestamp = new Date(activity.timestamp).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
            return `
                <div class="flex items-start space-x-3 p-3 border-b border-gray-100 last:border-b-0">
                    <div class="flex-1"><p class="text-sm font-medium text-gray-700">${activity.description}</p><p class="text-xs text-gray-400">${timestamp}</p></div>
                </div>`;
        }).join('');
    }
    function updateCategoryChart() {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        const categories = {};
        currentData.ppeItems.forEach(item => {
            if (item.category) {
                categories[item.category] = (categories[item.category] || 0) + Number(item.stock);
            }
        });

        if (categoryChartInstance) categoryChartInstance.destroy();
        
        categoryChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(categories),
                datasets: [{
                    data: Object.values(categories),
                    backgroundColor: ['#14b8a6', '#0d9488', '#0f766e', '#047857', '#065f46', '#064e3b'],
                    borderColor: '#FFFFFF',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: {font: { family: "'Inter', 'Sarabun', sans-serif" }} } },
                onClick: (_, elements) => {
                    if (elements.length > 0) {
                        const categoryName = Object.keys(categories)[elements[0].index];
                        showPage('stock');
                        document.getElementById('categoryFilter').value = categoryName;
                        filterStock();
                    }
                }
            }
        });
    }
    function updateTopIssuedItemsChart() {
        const ctx = document.getElementById('topIssuedItemsChart').getContext('2d');
        const topItems = currentData.dashboardMetrics.topIssuedItems;
        if (!topItems) return;
        if (topIssuedItemsChartInstance) topIssuedItemsChartInstance.destroy();

        topIssuedItemsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: topItems.map(item => item.itemName),
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢',
                    data: topItems.map(item => item.totalQuantity),
                    backgroundColor: '#14b8a6',
                    borderRadius: 4,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, title: { display: false } },
                scales: { 
                    y: { ticks: { font: { family: "'Inter', 'Sarabun', sans-serif" } } },
                    x: { beginAtZero: true }
                }
            }
        });
    }

    // ===========================================
    // Table Rendering & Filtering
    // ===========================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Compact Grid (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠ 3.2)
    function filterStock() {
        const container = document.getElementById('stockGrid');
        const emptyState = document.getElementById('stockEmptyState');
        const search = document.getElementById('stockSearch').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;

        if (!container) return;

        let filteredItems = currentData.ppeItems;
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        if (search) filteredItems = filteredItems.filter(item => 
            (item.name && item.name.toLowerCase().includes(search)) || 
            (item.code && item.code.toLowerCase().includes(search))
        );
        if (category) filteredItems = filteredItems.filter(item => item.category === category);
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Empty State
        if (filteredItems.length === 0) {
            container.innerHTML = '';
            if(emptyState) emptyState.classList.remove('hidden');
            return;
        }
        if(emptyState) emptyState.classList.add('hidden');

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ö‡∏ö Compact (2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
        container.innerHTML = filteredItems.map(item => {
            // Logic ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let statusBadge = '';
            let statusClass = '';
            const stock = Number(item.stock);
            const reorder = Number(item.reorderPoint);

            if (stock === 0) {
                statusBadge = '‡∏´‡∏°‡∏î';
                statusClass = 'bg-red-500 text-white';
            } else if (stock <= reorder) {
                statusBadge = '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î';
                statusClass = 'bg-orange-400 text-white';
            } else {
                statusBadge = '‡∏õ‡∏Å‡∏ï‡∏¥';
                statusClass = 'bg-emerald-500 text-white'; // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≤‡∏ß ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å
            }

            const imgUrl = item.image_url || 'https://placehold.co/300x300?text=No+Img';
            
            // ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin) ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏£‡∏π‡∏õ
            const editButton = isAdmin ? `
                <button onclick="editItem(${item.id}); event.stopPropagation();" class="absolute bottom-2 right-2 w-8 h-8 bg-white/90 backdrop-blur rounded-full shadow-sm text-gray-500 hover:text-teal-600 border border-gray-200 flex items-center justify-center z-10 active:scale-90 transition-transform">
                    <i class="fas fa-pen text-xs"></i>
                </button>` : '';

            return `
            <div class="group bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 active:scale-95 cursor-pointer overflow-hidden relative flex flex-col h-full">
                
                <div class="relative h-32 sm:h-44 w-full bg-gray-50 overflow-hidden" onclick="openImagePreview('${imgUrl}', event)">
                    <img src="${imgUrl}" class="w-full h-full object-contain p-2 group-hover:scale-105 transition-transform duration-300 mix-blend-multiply" onerror="this.src='https://placehold.co/300?text=No+Img'">
                    
                    <div class="absolute top-2 right-2 z-10">
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-white/20 ${statusClass}">
                            ${statusBadge}
                        </span>
                    </div>

                    <div class="absolute bottom-0 left-0 bg-white/80 backdrop-blur px-2 py-0.5 rounded-tr-lg border-t border-r border-gray-100">
                        <span class="text-[10px] font-mono font-bold text-gray-600">
                            ${item.code}
                        </span>
                    </div>
                </div>

                <div class="p-3 flex-1 flex flex-col relative">
                    ${editButton}
                    
                    <div class="mb-1">
                        <p class="text-[10px] text-gray-400 truncate">${item.category}</p>
                        <h4 class="font-bold text-xs sm:text-sm text-gray-800 leading-snug line-clamp-2 h-8 sm:h-10" title="${item.name}">
                            ${item.name}
                        </h4>
                    </div>

                    <div class="mt-auto pt-2 border-t border-gray-100 flex items-end justify-between">
                        <div>
                            <p class="text-[10px] text-gray-400">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                            <p class="text-sm sm:text-lg font-bold ${stock === 0 ? 'text-red-500' : 'text-gray-800'}">
                                ${stock} <span class="text-[10px] font-normal text-gray-500">${item.unit}</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function getStatusInfo(status) {
        switch (String(status).trim()) {
            case 'pending': return { text: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', color: 'bg-yellow-100 text-yellow-800' };
            case 'approved': return { text: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-emerald-100 text-emerald-800' };
            case 'partially_approved': return { text: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô', color: 'bg-green-100 text-green-800' };
            case 'rejected': return { text: '‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', color: 'bg-red-100 text-red-800' };
            case 'completed': return { text: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', color: 'bg-purple-100 text-purple-800' };
            case 'on_loan': return { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°', color: 'bg-blue-100 text-blue-800' };
            case 'returned': return { text: '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-gray-200 text-gray-800' };
            default: return { text: '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', color: 'bg-gray-100 text-gray-800' };
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å + Logic ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
    function updateHistoryTable(filter = '') {
        const container = document.getElementById('issueHistoryTab');
        const emptyState = document.getElementById('issueHistoryEmptyState');
        
        if (!container) return;

        const sortedVouchers = [...currentData.issueVouchers]
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .filter(v => {
                const searchStr = `${v.id} ${v.user} ${v.department || ''}`.toLowerCase();
                return searchStr.includes(filter.toLowerCase());
            });

        if (sortedVouchers.length === 0) {
            container.innerHTML = '';
            if(emptyState) {
                emptyState.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å', 'fa-solid fa-file-invoice');
                emptyState.classList.remove('hidden');
            }
            return;
        }

        if(emptyState) emptyState.classList.add('hidden');
        
        // üîí ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ LIFF ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á)
        const currentUser = (typeof liffProfile !== 'undefined' && liffProfile) ? liffProfile.displayName : '';

        container.innerHTML = sortedVouchers.map(v => {
            const status = getStatusInfo(v.status);
            const dateStr = new Date(v.timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit' });
            
            let itemCount = 0;
            let firstItemData = {}; 
            try {
                const items = Array.isArray(v.itemsJson) ? v.itemsJson : JSON.parse(v.itemsJson || '[]');
                itemCount = items.length;
                if(items.length > 0) firstItemData = items[0];
            } catch(e) { itemCount = 0; }

            const ppeItem = currentData.ppeItems.find(p => p.id == firstItemData.itemId) || { name: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', image_url: '' };

            // üîíüîíüîí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á üîíüîíüîí
            // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const isOwner = v.user === currentUser;
            
            const reviewBtn = isOwner ? `
                <button onclick="openRatingSelector('${v.id}'); event.stopPropagation();" 
                        class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-500 flex items-center justify-center hover:bg-yellow-100 transition-colors border border-yellow-100 shadow-sm" 
                        title="‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    <i class="fa-regular fa-star"></i>
                </button>
            ` : ''; 
            // ^^^ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°)

            return `
            <div onclick="showVoucherDetails(${v.id})" class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 active:scale-95 cursor-pointer flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                
                <div class="flex items-center gap-4 min-w-[180px]">
                    <div class="w-10 h-10 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center font-bold text-sm">
                        <i class="fa-solid fa-file-lines"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-800 text-lg">#${v.id}</div>
                        <div class="text-xs text-gray-400"><i class="fa-regular fa-clock mr-1"></i>${dateStr}</div>
                    </div>
                </div>

                <div class="flex-1">
                    <div class="flex flex-col md:flex-row md:items-center gap-1 md:gap-6">
                        <div class="text-sm text-gray-700 font-medium">
                            <i class="fa-solid fa-user text-gray-400 mr-2 w-4"></i>${v.user}
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fa-solid fa-building text-gray-400 mr-2 w-4"></i>${v.department || '-'}
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fa-solid fa-box-open text-gray-400 mr-2 w-4"></i>${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between w-full md:w-auto gap-4 mt-2 md:mt-0 pt-2 md:pt-0 border-t md:border-t-0 border-gray-100">
                    <span class="px-3 py-1 text-xs font-bold rounded-full ${status.color}">
                        ${status.text}
                    </span>
                    
                    <div class="flex items-center gap-2">
                        ${reviewBtn} <button onclick="showVoucherSlip(${v.id}); event.stopPropagation();" class="w-8 h-8 rounded-full bg-teal-50 text-teal-600 flex items-center justify-center hover:bg-teal-100 transition-colors" title="‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
                            <i class="fa-solid fa-receipt"></i>
                        </button>
                        
                        <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400">
                            <i class="fa-solid fa-chevron-right"></i>
                        </div>
                    </div>
                </div>

            </div>`;
        }).join('');
    }
    
    function updatePendingTable() { 
        const tbody = document.getElementById('pendingTableBody');
        const emptyState = document.getElementById('pendingEmptyState');
        
        if (!currentData || !currentData.issueVouchers) return;

        const pendingVouchers = currentData.issueVouchers
            .filter(v => v.status === 'pending')
            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        if (pendingVouchers.length === 0) {
            if(tbody) tbody.innerHTML = '';
            if(emptyState) {
                emptyState.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'fa-solid fa-inbox');
                emptyState.classList.remove('hidden');
            }
            return;
        }

        if(emptyState) emptyState.classList.add('hidden');
        if(!tbody) return;

        tbody.innerHTML = pendingVouchers.map(voucher => {
            
            // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å itemsJson (‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô Database ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
            // ‡πÉ‡∏ä‡πâ || ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß (‡∏ñ‡πâ‡∏≤‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô items ‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
            const rawItems = voucher.itemsJson || voucher.items; 
            
            let itemCount = 0;
            if (rawItems) {
                if (Array.isArray(rawItems)) {
                    itemCount = rawItems.length;
                } else if (typeof rawItems === 'string') {
                    try {
                        const parsed = JSON.parse(rawItems);
                        itemCount = Array.isArray(parsed) ? parsed.length : 0;
                    } catch (e) {
                        itemCount = 0;
                    }
                }
            }
            // -------------------------------------------------------------------
            
            const reasonText = voucher.reason || '‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';

            return `
            <tr class="hover:bg-gray-50 transition-colors border-b">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-bold text-teal-600">#${voucher.id}</div>
                    <div class="text-xs text-gray-500">
                        <i class="fa-regular fa-calendar mr-1"></i>
                        ${new Date(voucher.timestamp).toLocaleDateString('th-TH', { dateStyle: 'medium' })}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${voucher.user}</div>
                    <div class="text-xs text-gray-500">${voucher.department || '-'}</div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500">
                    <div>${reasonText}</div>
                    <div class="text-xs text-gray-400 mt-0.5">
                        <i class="fa-solid fa-box-open mr-1"></i> ${itemCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button onclick="showApprovalModal(${voucher.id})" class="w-full sm:w-auto px-4 py-2 bg-yellow-400 text-yellow-900 rounded-lg hover:bg-yellow-500 font-bold shadow-sm transition-transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-clipboard-check"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                    </button>
                </td>
            </tr>
            `;
        }).join('');
    }

    // üõ†Ô∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 2.0: Search + Status + Delete)
    function updateManageItemsList() {
        const listContainer = document.getElementById('manageItemsList');
        const search = document.getElementById('manageSearch').value.toLowerCase();
        const category = document.getElementById('manageCategoryFilter').value;

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dropdown Filter ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ option)
        const filterSelect = document.getElementById('manageCategoryFilter');
        if (filterSelect.options.length <= 1) {
            currentData.categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.name; opt.innerText = c.name;
                filterSelect.appendChild(opt);
            });
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const filteredItems = currentData.ppeItems.filter(item => {
            const matchSearch = (item.name || '').toLowerCase().includes(search) || (item.code || '').toLowerCase().includes(search);
            const matchCat = category === '' || item.category === category;
            return matchSearch && matchCat;
        });

        // Empty State
        if (filteredItems.length === 0) {
            listContainer.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'fa-solid fa-box-open');
            return;
        }

        // Render List
        listContainer.innerHTML = filteredItems.sort((a,b) => a.name.localeCompare(b.name)).map(item => {
            const stock = Number(item.stock);
            const min = Number(item.reorderPoint);
            const img = item.image_url || 'https://placehold.co/100?text=NoImg';
            
            // Logic ‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let statusColor = 'bg-emerald-100 text-emerald-700 border-emerald-200';
            let statusText = '‡∏õ‡∏Å‡∏ï‡∏¥';
            if(stock === 0) { statusColor = 'bg-red-100 text-red-700 border-red-200'; statusText = '‡∏´‡∏°‡∏î'; }
            else if(stock <= min) { statusColor = 'bg-orange-100 text-orange-700 border-orange-200'; statusText = '‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå'; }

            return `
            <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all flex items-center gap-4 group">
                <div class="w-16 h-16 rounded-lg bg-gray-50 flex-shrink-0 border border-gray-100 overflow-hidden relative">
                    <img src="${img}" class="w-full h-full object-cover">
                    ${stock === 0 ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white text-[10px]">‡∏´‡∏°‡∏î</div>' : ''}
                </div>

                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[10px] font-bold px-1.5 py-0.5 rounded border ${statusColor}">${statusText}</span>
                        <span class="text-[10px] text-gray-400 border px-1.5 rounded bg-gray-50">${item.category}</span>
                    </div>
                    <h4 class="font-bold text-gray-800 text-sm truncate">${item.name}</h4>
                    <div class="flex items-center gap-3 text-xs text-gray-500 mt-1">
                        <span><i class="fa-solid fa-barcode mr-1"></i>${item.code}</span>
                        <span><i class="fa-solid fa-cubes mr-1"></i>‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b class="text-gray-800">${stock}</b> ${item.unit}</span>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="editItem(${item.id})" class="w-9 h-9 rounded-lg bg-gray-100 text-gray-600 hover:bg-teal-50 hover:text-teal-600 border border-transparent hover:border-teal-200 transition-all" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteItem(${item.id})" class="w-9 h-9 rounded-lg bg-gray-100 text-gray-600 hover:bg-red-50 hover:text-red-600 border border-transparent hover:border-red-200 transition-all" title="‡∏•‡∏ö">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå URL
    function updateImagePreview(url) {
        const img = document.getElementById('adminImagePreview');
        const placeholder = document.getElementById('adminImagePlaceholder');
        
        if (url && url.length > 10) { // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ ‡∏ß‡πà‡∏≤‡∏°‡∏µ URL
            img.src = url;
            img.onload = () => {
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
            };
            img.onerror = () => { // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå placeholder
                img.classList.add('hidden');
                placeholder.classList.remove('hidden');
            };
        } else {
            img.classList.add('hidden');
            placeholder.classList.remove('hidden');
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÅ‡∏ö‡∏ö Card + Touch Feedback (‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin)
    function updateOnLoanTable() {
        const container = document.getElementById('onLoanListContainer');
        const emptyState = document.getElementById('onLoanEmptyState');
        const badge = document.getElementById('onLoanCountBadge');
        
        if (!container) return;

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° Padding ‡∏Å‡∏±‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏±‡∏á
        container.className = "p-4 overflow-y-auto max-h-[600px] bg-gray-50/30 space-y-3 pb-24"; 

        const onLoanItems = currentData.loanTransactions
            .filter(l => l.status === 'on_loan')
            .sort((a, b) => new Date(a.borrowDate) - new Date(b.borrowDate));

        if(badge) badge.textContent = `${onLoanItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

        if (onLoanItems.length === 0) {
            container.innerHTML = '';
            container.classList.add('hidden');
            if(emptyState) {
                emptyState.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°', 'fa-solid fa-clipboard-check');
                emptyState.classList.remove('hidden');
            }
            return;
        }

        if(emptyState) emptyState.classList.add('hidden');
        container.classList.remove('hidden');

        container.innerHTML = onLoanItems.map(loan => {
            const item = currentData.ppeItems.find(p => p.id == loan.itemId);
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const dueDate = new Date(loan.dueDate); dueDate.setHours(0,0,0,0);
            const isOverdue = dueDate < today;
            const daysOverdue = isOverdue ? Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;

            const cardBorder = isOverdue ? 'border-red-300 ring-1 ring-red-100' : 'border-gray-200 hover:border-teal-300';
            
            const imgHtml = (item && item.image_url) 
                ? `<img src="${item.image_url}" class="w-16 h-16 rounded-lg object-cover border border-gray-100">`
                : `<div class="w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400 text-2xl"><i class="fa-solid fa-box"></i></div>`;

            // üëáüëá ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô üëáüëá
            const returnButton = isAdmin ? `
                <div class="w-full sm:w-auto mt-3 sm:mt-0 flex justify-end">
                    <button onclick="handleReturnItem(${loan.loanId}); event.stopPropagation();" 
                        class="w-full sm:w-auto px-4 py-2.5 bg-white border border-teal-600 text-teal-600 hover:bg-teal-50 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2 shadow-sm group-hover:bg-teal-600 group-hover:text-white active:scale-90">
                        <i class="fa-solid fa-arrow-rotate-left"></i>
                        ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
                    </button>
                </div>` : ''; 
            // üëÜüëÜ ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ

            return `
            <div class="group relative flex flex-col sm:flex-row items-start sm:items-center gap-4 p-4 rounded-xl border ${cardBorder} bg-white shadow-sm transition-all duration-200 hover:shadow-md active:scale-95 cursor-pointer">
                
                <div class="flex-shrink-0">
                    ${imgHtml}
                </div>

                <div class="flex-1 min-w-0 w-full">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-base font-bold text-gray-800 leading-tight mb-1">
                                ${item ? item.name : '<span class="text-red-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>'}
                            </h4>
                            <p class="text-xs text-gray-500 font-mono mb-2 bg-gray-100 inline-block px-1.5 rounded">
                                ${item ? item.code : '-'}
                            </p>
                        </div>
                        ${isOverdue 
                            ? `<span class="flex-shrink-0 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                 <i class="fa-solid fa-circle-exclamation mr-1"></i> ‡πÄ‡∏Å‡∏¥‡∏ô ${daysOverdue} ‡∏ß‡∏±‡∏ô
                               </span>`
                            : `<span class="flex-shrink-0 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700">
                                 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°
                               </span>`
                        }
                    </div>

                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm mt-1">
                        <div class="flex items-center text-gray-600">
                            <i class="fa-solid fa-user w-5 text-center text-gray-400 mr-1"></i>
                            <span class="truncate font-medium">${loan.borrowerName}</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fa-regular fa-calendar w-5 text-center text-gray-400 mr-1"></i>
                            <span>‡∏Ñ‡∏∑‡∏ô: ${new Date(loan.dueDate).toLocaleDateString('th-TH')}</span>
                        </div>
                    </div>
                </div>

                ${returnButton}

            </div>`;
        }).join('');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô + Touch Feedback
    function updateLoanHistoryTable(filter = '') {
        const container = document.getElementById('loanHistoryTab');
        const emptyState = document.getElementById('loanHistoryEmptyState');
        
        if (!container) return;

        const sortedLoans = [...currentData.loanTransactions]
            .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
            .filter(l => {
                const item = currentData.ppeItems.find(p => p.id == l.itemId);
                const itemName = item ? item.name : '';
                const searchStr = `${l.borrowerName} ${itemName} ${l.department || ''}`.toLowerCase();
                return searchStr.includes(filter.toLowerCase());
            });

        if (sortedLoans.length === 0) {
            container.innerHTML = '';
            if(emptyState) {
                emptyState.innerHTML = createEmptyState('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô', 'fa-solid fa-history');
                emptyState.classList.remove('hidden');
            }
            return;
        }

        if(emptyState) emptyState.classList.add('hidden');
        
        container.innerHTML = sortedLoans.map(loan => {
            const item = currentData.ppeItems.find(p => p.id == loan.itemId);
            const status = getStatusInfo(loan.status);
            const borrowDate = new Date(loan.borrowDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
            const returnDate = loan.returnDate ? new Date(loan.returnDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' }) : '-';
            
            const imgUrl = item?.image_url || null;
            const imgHtml = imgUrl 
                ? `<img src="${imgUrl}" class="w-10 h-10 rounded-lg object-cover border border-gray-200">`
                : `<div class="w-10 h-10 rounded-lg bg-indigo-50 text-indigo-500 flex items-center justify-center"><i class="fa-solid fa-tools"></i></div>`;

            // üëáüëá ‡πÄ‡∏û‡∏¥‡πà‡∏° active:scale-95 duration-200 cursor-pointer ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
            return `
            <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 active:scale-95 cursor-pointer">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    
                    <div class="flex-shrink-0">
                        ${imgHtml}
                    </div>

                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-gray-800 text-sm truncate">${item ? item.name : 'Unknown Item'}</h4>
                        <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                            <span><i class="fa-solid fa-user mr-1"></i>${loan.borrowerName}</span>
                            <span class="text-gray-300">|</span>
                            <span>${loan.department || '-'}</span>
                        </div>
                    </div>

                    <div class="flex flex-row sm:flex-col items-center sm:items-end justify-between sm:justify-center gap-2 sm:gap-1 text-right mt-2 sm:mt-0 pt-2 sm:pt-0 border-t sm:border-t-0 border-gray-100">
                        <div class="text-xs text-gray-500">
                            <div class="flex items-center gap-1"><span class="w-8 text-left text-gray-400">‡∏¢‡∏∑‡∏°:</span> ${borrowDate}</div>
                            <div class="flex items-center gap-1"><span class="w-8 text-left text-gray-400">‡∏Ñ‡∏∑‡∏ô:</span> ${returnDate}</div>
                        </div>
                        <span class="px-2.5 py-0.5 text-[10px] font-bold rounded-full ${status.color}">
                            ${status.text}
                        </span>
                    </div>

                </div>
            </div>`;
        }).join('');
    }

    // ==========================================
    // 1. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Catalog Logic)
    // ==========================================
    let onItemSelectedCallback = null;

    function openItemSelector(callback) {
        onItemSelectedCallback = callback;
        document.getElementById('itemSelectorModal').classList.remove('hidden');
        document.getElementById('selectorSearch').value = ''; 
        renderSelectorItems();
    }

    function closeItemSelector() {
        document.getElementById('itemSelectorModal').classList.add('hidden');
        onItemSelectedCallback = null;
    }

    function renderSelectorItems() {
        const container = document.getElementById('selectorGrid');
        const searchText = document.getElementById('selectorSearch').value.toLowerCase();
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        const items = currentData.ppeItems.filter(item => 
            (item.name.toLowerCase().includes(searchText) || item.code.toLowerCase().includes(searchText))
        );

        if (items.length === 0) {
            container.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
            return;
        }

        container.innerHTML = items.map(item => {
            const imgUrl = item.image_url || 'https://placehold.co/150x150?text=No+Image'; 
            const isOutOfStock = Number(item.stock) <= 0;
            const borderClass = isOutOfStock ? 'border-red-200 bg-red-50/50' : 'border-gray-200 bg-white hover:border-teal-400 hover:shadow-md';
            
            return `
            <div class="flex border ${borderClass} rounded-xl overflow-hidden cursor-pointer h-32 group relative" onclick="selectItemFromGrid(${item.id})">
                <div class="w-32 flex-shrink-0 bg-white border-r border-gray-100 relative">
                    <img src="${imgUrl}" class="absolute inset-0 w-full h-full object-contain p-2">
                     ${isOutOfStock ? '<div class="absolute inset-0 bg-white/80 flex items-center justify-center"><span class="bg-red-600 text-white text-[10px] px-2 py-1 rounded">‡∏´‡∏°‡∏î</span></div>' : ''}
                </div>
                <div class="flex-1 p-3 flex flex-col justify-between">
                    <div>
                        <span class="text-[10px] font-bold text-gray-400 border px-1 rounded">${item.code}</span>
                        <h4 class="font-bold text-sm mt-1 line-clamp-2">${item.name}</h4>
                    </div>
                    <div class="flex justify-between items-end text-xs text-gray-500">
                        <span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock} ${item.unit}</span>
                        <i class="fa-solid fa-circle-plus text-teal-600 text-2xl"></i>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function selectItemFromGrid(itemId) {
        const item = currentData.ppeItems.find(i => i.id == itemId);
        if (item && onItemSelectedCallback) {
            onItemSelectedCallback(item);
            closeItemSelector();
        }
    }

    // ==========================================
    // 2. ‡∏ï‡∏±‡∏ß‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏Å‡∏±‡∏ö‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å (Wrappers)
    // ==========================================
    function openIssueCatalog() {
        openItemSelector((item) => addIssueRow(item));
    }

    function openLoanCatalog() {
        openItemSelector((item) => {
            document.getElementById('loanItemId').value = item.id;
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const nameEl = document.getElementById('loanItemName');
            nameEl.textContent = item.name;
            nameEl.classList.remove('text-gray-500');
            nameEl.classList.add('text-gray-900', 'font-bold');
            
            // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ
            const img = document.getElementById('loanItemImg');
            if(item.image_url) {
                img.src = item.image_url;
                img.classList.remove('hidden');
                document.getElementById('loanItemImgPlaceholder').classList.add('hidden');
            } else {
                img.classList.add('hidden');
                document.getElementById('loanItemImgPlaceholder').classList.remove('hidden');
            }
        });
    }

    function openReceiveCatalog() {
        openItemSelector((item) => {
            document.getElementById('receiveItemId').value = item.id;
            const nameEl = document.getElementById('receiveItemName');
            nameEl.textContent = item.name;
            nameEl.classList.remove('text-gray-500');
            nameEl.classList.add('text-gray-900', 'font-bold');
            
             const img = document.getElementById('receiveItemImg');
            if(item.image_url) {
                img.src = item.image_url;
                img.classList.remove('hidden');
                document.getElementById('receiveItemImgPlaceholder').classList.add('hidden');
            } else {
                img.classList.add('hidden');
                document.getElementById('receiveItemImgPlaceholder').classList.remove('hidden');
            }
        });
    }

    // ==========================================
    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏° (Form Helpers)
    // ==========================================
    function addIssueRow(item) {
        const container = document.getElementById('issueItemsContainer');
        
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≥
        if (container.querySelector(`input[value="${item.id}"]`)) {
            return showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
        }
        
        const rowId = 'row-' + Date.now();
        const img = item.image_url || 'https://placehold.co/100?text=Box';
        
        container.insertAdjacentHTML('beforeend', `
            <div id="${rowId}" class="issue-item flex gap-3 p-3 bg-white border border-gray-200 rounded-lg shadow-sm mb-2">
                <input type="hidden" class="item-select-value" value="${item.id}">
                <img src="${img}" class="w-12 h-12 rounded object-cover border">
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-gray-800 text-sm truncate">${item.name}</h4>
                    <p class="text-xs text-gray-500">‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${item.stock} ${item.unit}</p>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <input type="number" class="item-quantity w-16 border rounded text-center py-1 font-bold text-gray-700" value="1" min="1" max="${item.stock}">
                    <button type="button" onclick="document.getElementById('${rowId}').remove()" class="text-xs text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i> ‡∏•‡∏ö</button>
                </div>
            </div>
        `);
    }

    function resetIssueForm() {
        document.getElementById('issueForm').reset();
        const container = document.getElementById('issueItemsContainer');
        if(container) container.innerHTML = '';
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô User ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
        if(typeof autoFillUserIdentity === 'function') autoFillUserIdentity();
    }

    // ==========================================
    // 5. User Interface Setup (Line LIFF)
    // ==========================================

    // üé® User Dashboard ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 3.0 (Responsive: Mobile & Desktop)
    function renderUserDashboard() {
        const dashboardDiv = document.getElementById('userDashboardPanel');
        if (!dashboardDiv) return;

        dashboardDiv.classList.remove('hidden');

        // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        const displayName = (typeof liffProfile !== 'undefined' && liffProfile) ? liffProfile.displayName : '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        const pictureUrl = (typeof liffProfile !== 'undefined' && liffProfile) ? liffProfile.pictureUrl : null;
        
        const profileImgHtml = pictureUrl 
            ? `<img src="${pictureUrl}" class="w-14 h-14 rounded-full border-4 border-white shadow-md object-cover">`
            : `<div class="w-14 h-14 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 border-4 border-white shadow-md"><i class="fa-solid fa-user text-xl"></i></div>`;

        // 2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        const myActiveLoans = currentData.loanTransactions?.filter(l => l.borrowerName === displayName && l.status === 'on_loan') || [];
        const myPendingVouchers = currentData.issueVouchers?.filter(v => v.user === displayName && v.status === 'pending') || [];
        const myTotalHistoryCount = (currentData.issueVouchers?.filter(v => v.user === displayName).length || 0) + 
                                    (currentData.loanTransactions?.filter(l => l.borrowerName === displayName).length || 0);

        // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° HTML ‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏Ç‡∏≠‡∏á (Active Gear)
        let myGearHtml = '';
        if (myActiveLoans.length > 0) {
            const gearItems = myActiveLoans.map(loan => {
                const item = currentData.ppeItems.find(p => p.id == loan.itemId);
                const img = item?.image_url || 'https://placehold.co/100?text=Item';
                const dueDate = new Date(loan.dueDate);
                const today = new Date(); today.setHours(0,0,0,0); dueDate.setHours(0,0,0,0);
                const isOverdue = dueDate < today;
                const dateText = isOverdue ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î!' : `‡∏Ñ‡∏∑‡∏ô: ${dueDate.getDate()}/${dueDate.getMonth()+1}`;
                const statusColor = isOverdue ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-600';

                return `
                <div class="flex-shrink-0 w-24 flex flex-col gap-2 snap-center group cursor-pointer" onclick="showPage('loan')">
                    <div class="w-24 h-24 rounded-2xl bg-white border border-gray-100 shadow-sm p-2 flex items-center justify-center relative overflow-hidden group-active:scale-95 transition-transform">
                        <img src="${img}" class="w-full h-full object-contain">
                        ${isOverdue ? '<div class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>' : ''}
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-bold text-gray-700 truncate w-full">${item?.name || 'Unknown'}</p>
                        <span class="text-[10px] px-2 py-0.5 rounded-full ${statusColor}">${dateText}</span>
                    </div>
                </div>`;
            }).join('');

            myGearHtml = `
            <div class="bg-white lg:bg-transparent rounded-2xl p-4 lg:p-0 shadow-sm lg:shadow-none border lg:border-0 border-gray-100 mb-6 lg:mb-0 animate-fade-in-up delay-100">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-gray-800 text-sm"><i class="fa-solid fa-toolbox mr-2 text-teal-500"></i>‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà</h3>
                    <button onclick="showPage('loan')" class="text-[10px] text-teal-600 bg-teal-50 px-2 py-1 rounded-lg">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
                <div class="flex overflow-x-auto gap-3 pb-2 snap-x scrollbar-hide lg:grid lg:grid-cols-4 lg:gap-4">
                    ${gearItems}
                </div>
            </div>`;
        }

        // 4. Timeline ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const lastVoucher = currentData.issueVouchers
            ?.filter(v => v.user === displayName)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
        
        let timelineHtml = '';
        if (lastVoucher && lastVoucher.status === 'pending') {
             timelineHtml = `
            <div class="mb-6 animate-fade-in-up cursor-pointer active:scale-95 transition-transform" onclick="showTimelineDetails(${lastVoucher.id})">
                <div class="bg-white p-4 rounded-2xl border border-orange-100 shadow-sm shadow-orange-50/50 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1.5 h-full bg-orange-400"></div>
                    <div class="flex justify-between items-start pl-2">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
                                <p class="text-xs text-orange-500 font-bold uppercase tracking-wide">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</p>
                            </div>
                            <h4 class="font-bold text-gray-800 text-base">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å #${lastVoucher.id}</h4>
                            <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Admin ‚Ä¢ ${new Date(lastVoucher.timestamp).toLocaleDateString('th-TH')}</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300 mt-2"></i>
                    </div>
                </div>
            </div>`;
        }

        // 5. ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const recentHistoryList = [
            ...(currentData.issueVouchers || []).filter(v => v.user === displayName).map(v => ({...v, type: 'issue', date: v.timestamp})),
            ...(currentData.loanTransactions || []).filter(l => l.borrowerName === displayName).map(l => ({...l, type: 'loan', date: l.borrowDate}))
        ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

        const historyHtml = recentHistoryList.length > 0 ? recentHistoryList.map(h => {
            let icon, title, subtitle, statusColor, clickAction;
            
            if (h.type === 'issue') {
                icon = 'fa-file-lines';
                title = `‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå #${h.id}`;
                subtitle = `${new Date(h.date).toLocaleDateString('th-TH')} ‚Ä¢ ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å`;
                clickAction = `showVoucherDetails(${h.id})`;
                if(h.status === 'approved') statusColor = 'text-emerald-500 bg-emerald-50';
                else if(h.status === 'pending') statusColor = 'text-orange-500 bg-orange-50';
                else if(h.status === 'rejected') statusColor = 'text-red-500 bg-red-50';
                else statusColor = 'text-gray-500 bg-gray-50';
            } else {
                const item = currentData.ppeItems.find(p => p.id == h.itemId);
                const itemName = item ? item.name : 'Unknown';
                icon = 'fa-screwdriver-wrench';
                title = `‡∏¢‡∏∑‡∏°: ${itemName}`;
                subtitle = `${new Date(h.date).toLocaleDateString('th-TH')} ‚Ä¢ ‡∏¢‡∏∑‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠`;
                clickAction = "showPage('loan')";
                
                if(h.status === 'on_loan') statusColor = 'text-blue-500 bg-blue-50';
                else statusColor = 'text-gray-400 bg-gray-100';
            }

            return `
            <div onclick="${clickAction}" class="flex items-center gap-4 p-3 bg-white border border-gray-100 rounded-xl shadow-sm active:bg-gray-50 transition-colors cursor-pointer hover:border-teal-200">
                <div class="w-10 h-10 rounded-full ${statusColor} flex items-center justify-center text-sm">
                    <i class="fa-solid ${icon}"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-bold text-gray-800 truncate">${title}</h4>
                    <p class="text-xs text-gray-400">${subtitle}</p>
                </div>
                <i class="fa-solid fa-angle-right text-gray-300 text-xs"></i>
            </div>`;
        }).join('') : `<div class="text-center py-8 text-gray-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>`;

        const quotes = ["Safety First", "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå", "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö PPE", "‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô"];
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];

        // --- Render HTML Grid Layout ---
        dashboardDiv.innerHTML = `
            <div class="pt-0 pb-24 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">
                
                <div class="relative">
                    <div class="bg-gradient-to-br from-teal-600 to-teal-800 rounded-3xl p-6 text-white shadow-lg shadow-teal-200 relative overflow-hidden lg:flex lg:items-center lg:justify-between">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="absolute -left-6 -bottom-6 w-32 h-32 bg-teal-400/20 rounded-full blur-xl"></div>
                        
                        <div class="relative z-10 flex justify-between items-start w-full lg:w-auto gap-4">
                            <div>
                                <p class="text-teal-100 text-xs mb-1">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏Ñ‡∏∏‡∏ì${displayName}</p>
                                <h2 class="text-2xl font-bold mb-2">PPE Stock</h2>
                                <div class="inline-flex items-center bg-white/20 px-3 py-1 rounded-full backdrop-blur-md">
                                    <i class="fa-solid fa-shield-halved text-xs mr-2 text-yellow-300"></i>
                                    <span class="text-[10px] font-medium">${randomQuote}</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-center gap-2 lg:hidden">
                                ${profileImgHtml}
                                <button onclick="refreshDashboardData(this)" class="text-teal-200 hover:text-white transition-colors p-1 rounded-full hover:bg-white/10">
                                    <i class="fa-solid fa-arrows-rotate text-xs"></i>
                                </button>
                            </div>
                        </div>

                        <div class="hidden lg:flex items-center gap-4 relative z-10">
                             <div class="text-right">
                                <p class="text-sm font-medium opacity-90">${displayName}</p>
                                <p class="text-xs text-teal-200">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</p>
                             </div>
                             ${profileImgHtml}
                             <button onclick="refreshDashboardData(this)" class="ml-2 bg-white/10 hover:bg-white/20 text-white p-2 rounded-lg transition-colors" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                                <i class="fa-solid fa-arrows-rotate"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 space-y-6">
                        
                        <div class="flex overflow-x-auto gap-4 pb-2 snap-x snap-mandatory scrollbar-hide lg:grid lg:grid-cols-3 lg:pb-0 lg:snap-none">
                            
                            <div onclick="showPage('allHistory'); showHistoryTab('issue');" class="min-w-[140px] flex-1 snap-center bg-white p-4 rounded-2xl border border-orange-100 shadow-sm flex flex-col justify-between h-28 hover:shadow-md transition-all cursor-pointer relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="fa-solid fa-clock text-4xl text-orange-500"></i>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-sm mb-2">
                                    <i class="fa-solid fa-hourglass-half"></i>
                                </div>
                                <div>
                                    <span class="block text-2xl font-bold text-gray-800">${myPendingVouchers.length}</span>
                                    <span class="text-[10px] text-gray-500 font-medium">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                                </div>
                            </div>

                            <div onclick="showPage('loan')" class="min-w-[140px] flex-1 snap-center bg-white p-4 rounded-2xl border border-blue-100 shadow-sm flex flex-col justify-between h-28 hover:shadow-md transition-all cursor-pointer relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="fa-solid fa-tools text-4xl text-blue-500"></i>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm mb-2">
                                    <i class="fa-solid fa-hand-holding-hand"></i>
                                </div>
                                <div>
                                    <span class="block text-2xl font-bold text-gray-800">${myActiveLoans.length}</span>
                                    <span class="text-[10px] text-gray-500 font-medium">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</span>
                                </div>
                            </div>

                            <div onclick="showPage('allHistory')" class="min-w-[140px] flex-1 snap-center bg-white p-4 rounded-2xl border border-emerald-100 shadow-sm flex flex-col justify-between h-28 hover:shadow-md transition-all cursor-pointer relative overflow-hidden group">
                                <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                                    <i class="fa-solid fa-clipboard-list text-4xl text-emerald-500"></i>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm mb-2">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                                <div>
                                    <span class="block text-2xl font-bold text-gray-800">${myTotalHistoryCount}</span>
                                    <span class="text-[10px] text-gray-500 font-medium">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°</span>
                                </div>
                            </div>

                        </div>

                        ${timelineHtml}

                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 animate-fade-in-up delay-200">
                            <div class="flex justify-between items-end mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                                <button onclick="showPage('allHistory')" class="text-xs text-teal-600 hover:text-teal-700">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                            <div class="space-y-3">
                                ${historyHtml}
                            </div>
                        </div>

                    </div>

                    <div class="lg:col-span-1 space-y-6">
                        ${myGearHtml || `
                        <div class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center text-gray-400 hidden lg:block">
                            <i class="fa-solid fa-box-open text-3xl mb-2"></i>
                            <p class="text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà</p>
                        </div>`}
                        
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 text-white shadow-md hidden lg:block">
                            <h4 class="font-bold text-sm mb-1">üí° Tips</h4>
                            <p class="text-xs opacity-90">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå PPE ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                        </div>
                    </div>

                </div>
            </div>
        `;
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderDepartmentSelect ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
    function renderDepartmentSelect(filter = '', targetId = null) {
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ID ‡∏Ç‡∏≠‡∏á Dropdown ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        // ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á targetId ‡∏°‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡πÅ‡∏Ñ‡πà‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà (issue ‡πÅ‡∏•‡∏∞ loan)
        const dropdownIds = targetId ? [targetId] : ['issueDepartment', 'loanDepartment'];

        dropdownIds.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;

            const lastDept = localStorage.getItem('last_department');
            const selectedValue = select.value;

            // Reset ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÄ‡∏Å‡πá‡∏ö option ‡πÅ‡∏£‡∏Å‡πÑ‡∏ß‡πâ)
            select.innerHTML = '<option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';

            (window.departments || [])
                .filter(dep =>
                    dep.name.toLowerCase().includes(filter.toLowerCase())
                )
                .forEach(dep => {
                    const opt = document.createElement('option');
                    opt.value = dep.name;
                    opt.textContent = dep.name;

                    // Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ
                    if (dep.name === selectedValue || (!selectedValue && dep.name === lastDept)) {
                        opt.selected = true;
                    }

                    select.appendChild(opt);
                });
        });
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô Event Listener ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å (Issue Page)
    document.getElementById('issueDepartmentSearch')
        ?.addEventListener('input', (e) => {
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏Ñ‡πà issueDepartment
            renderDepartmentSelect(e.target.value, 'issueDepartment'); 
        });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏° (Loan Page) ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
    document.getElementById('departmentSearch')
        ?.addEventListener('input', (e) => {
            renderDepartmentSelect(e.target.value, 'loanDepartment');
        });  

    function autoFillUserIdentity() {
        if(liffProfile) {
            const u = document.getElementById('issueUser'); if(u) { u.value = liffProfile.displayName; u.readOnly = true; u.classList.add('bg-gray-100'); }
            const b = document.getElementById('borrowerName'); if(b) { b.value = liffProfile.displayName; b.readOnly = true; b.classList.add('bg-gray-100'); }
        }
    }

    function showTimelineDetails(voucherId) {
        // 1. ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å
        const voucher = currentData.issueVouchers.find(v => v.id === voucherId);
        if (!voucher) {
            console.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å ID:", voucherId);
            return;
        }

        // 2. ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        let items = [];
        const rawItems = voucher.itemsJson || voucher.items;
        
        if (typeof rawItems === 'string') {
            try { items = JSON.parse(rawItems); } catch(e) { items = []; }
        } else if (Array.isArray(rawItems)) {
            items = rawItems;
        }

        const listContainer = document.getElementById('timelineItemsList');
        if (!listContainer) return;

        listContainer.innerHTML = items.map((item, index) => {
            const targetId = String(item.itemId).trim();

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Stock
            const product = currentData.ppeItems.find(p => {
                return String(p.id).trim() === targetId || String(p.code).trim() === targetId;
            }) || { name: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', unit: '‡∏´‡∏ô‡πà‡∏ß‡∏¢', image_url: null, code: targetId };
            
            const pName = product.name;
            const pCode = product.code || item.itemId;
            
            // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å image_url ---
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á image_url (‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á) ‡πÅ‡∏•‡∏∞ image (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤)
            const imgLink = product.image_url || product.image || ''; 
            const fallbackImage = 'https://cdn-icons-png.flaticon.com/512/2829/2829824.png'; // ‡∏£‡∏π‡∏õ‡∏´‡∏°‡∏ß‡∏Å Safety ‡∏™‡∏≥‡∏£‡∏≠‡∏á

            const pImgHtml = (imgLink && imgLink !== "") 
                ? `<img src="${imgLink}" class="w-full h-full object-cover" onerror="this.src='${fallbackImage}'">` 
                : `<div class="w-full h-full bg-gray-50 flex items-center justify-center p-2"><img src="${fallbackImage}" class="opacity-50 w-full h-full object-contain"></div>`;
            // ----------------------------------------

            return `
            <div class="flex items-center gap-3 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                <div class="w-12 h-12 rounded-lg bg-white flex-shrink-0 overflow-hidden border border-gray-100 relative">
                    ${pImgHtml}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-gray-800 truncate">${pName}</p>
                    <p class="text-xs text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${pCode}</p>
                </div>
                <div class="bg-teal-50 px-3 py-1 rounded-lg border border-teal-100">
                    <span class="text-sm font-bold text-teal-700">x${item.quantity}</span>
                </div>
            </div>`;
        }).join('');

        // ‡πÄ‡∏õ‡∏¥‡∏î Modal
        const modal = document.getElementById('timelineDetailModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    // ==========================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢ (Image Preview)
    // ==========================================
    function openImagePreview(url, e) {
        if(e) e.stopPropagation(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        
        const img = document.getElementById('previewImage');
        img.src = url;
        img.classList.remove('animate-pulse'); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï animation
        void img.offsetWidth; // trigger reflow
        img.classList.add('animate-pulse'); // ‡πÄ‡∏•‡πà‡∏ô animation
        
        document.getElementById('imagePreviewModal').classList.remove('hidden');
    }

    function closeImagePreview() {
        document.getElementById('imagePreviewModal').classList.add('hidden');
        document.getElementById('previewImage').src = '';
    }

    // ===========================================
    // >>>>>>>> ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (Admin & Logic) <<<<<<<<<<
    // ===========================================

    // --- Category Management ---
    function showCategoryModal() {
        if (!isAdmin) return showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
        document.getElementById('categoryManagementModal').classList.remove('hidden');
        resetCategoryForm();
        renderCategoryList();
    }
    function hideCategoryModal() {
        document.getElementById('categoryManagementModal').classList.add('hidden');
    }
    function renderCategoryList() {
        const container = document.getElementById('categoryListContainer');
        const sortedCategories = [...currentData.categories].sort((a,b) => a.name.localeCompare(b.name));
        if (sortedCategories.length === 0) {
            container.innerHTML = createEmptyState('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', 'fa-solid fa-tags');
            return;
        }
        container.innerHTML = sortedCategories.map(cat => `
            <div class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-50">
                <span class="text-gray-800">${cat.name}</span>
                <div class="space-x-2">
                    <button onclick="editCategory(${cat.id}, '${cat.name}')" class="text-gray-500 hover:text-teal-600"><i class="fas fa-edit"></i></button>
                    <button onclick="handleDeleteCategory(${cat.id})" class="text-gray-500 hover:text-red-600"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    }
    function editCategory(id, name) {
        document.getElementById('editCategoryId').value = id;
        document.getElementById('categoryNameInput').value = name;
        document.getElementById('categoryNameInput').focus();
    }
    function resetCategoryForm() {
        document.getElementById('categoryForm').reset();
        document.getElementById('editCategoryId').value = '';
    }

    // --- Voucher & Approval ---
    function showVoucherDetails(voucherId) {
        const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
        if (!voucher) return;

        let items = [];
        try {
            items = Array.isArray(voucher.itemsJson) ? voucher.itemsJson : JSON.parse(voucher.itemsJson || '[]');
        } catch (e) {
            items = [];
        }

        const itemsHtml = items.map(item => {
            const ppeItem = currentData.ppeItems.find(p => p.id == item.itemId);
            return `<li class="flex justify-between">
                        <span>${ppeItem ? ppeItem.name : 'N/A'}</span>
                        <span class="font-medium">${item.quantity} ${ppeItem ? ppeItem.unit : ''}</span>
                    </li>`;
        }).join('');

        const status = getStatusInfo(voucher.status);
        const modal = document.getElementById('voucherModal');
        modal.innerHTML = `
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-lg m-4 relative">
                <button onclick="hideVoucherModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                <h3 class="text-xl font-semibold mb-2 text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å #${voucher.id}</h3>
                <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${status.color}">${status.text}</span>
                <div class="mt-6 space-y-4 text-gray-700">
                    <div class="grid grid-cols-2 gap-4">
                        <p><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${voucher.user}</p>
                        <p><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> ${voucher.department}</p>
                        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å:</strong> ${new Date(voucher.timestamp).toLocaleDateString('th-TH', { dateStyle: 'medium' })}</p>
                    </div>
                    <div>
                        <p class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå:</p>
                        <ul class="space-y-1 bg-gray-50 p-4 rounded-lg">${itemsHtml}</ul>
                    </div>
                </div>
                <div class="mt-6 flex gap-3">
                    <button onclick="reorderVoucher(${voucher.id})" class="flex-1 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform">
                        <i class="fa-solid fa-repeat"></i> ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ã‡πâ‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
                    </button>
                    <button onclick="hideVoucherModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>`;
        modal.classList.remove('hidden');
    }
    function hideVoucherModal() { document.getElementById('voucherModal').classList.add('hidden'); }

    function showApprovalModal(voucherId) {
        if (!isAdmin) return showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'error');
        const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
        if (!voucher) return;

        let items = [];
        try {
            items = Array.isArray(voucher.itemsJson) ? voucher.itemsJson : JSON.parse(voucher.itemsJson || '[]');
        } catch (e) {
            items = [];
        }

        const itemsHtml = items.map(item => {
            const ppeItem = currentData.ppeItems.find(p => p.id == item.itemId);
            const maxApprove = Math.min(item.quantity, ppeItem ? ppeItem.stock : 0);
            return `
                <div class="flex items-center space-x-3 p-3 border-b item-approval-row" data-item-id="${item.itemId}" data-item-name="${ppeItem ? ppeItem.name : ''}">
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${ppeItem ? ppeItem.name : 'N/A'}</p>
                        <p class="text-sm text-gray-600">‡∏Ç‡∏≠: ${item.quantity} | ‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${ppeItem ? ppeItem.stock : 0}</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</label>
                        <input type="number" value="${maxApprove}" min="0" max="${maxApprove}" class="approved-quantity w-20 px-2 py-1 border rounded focus:outline-none focus:ring-1 focus:ring-teal-500">
                    </div>
                </div>`;
        }).join('');

        const modal = document.getElementById('approvalModal');
        modal.innerHTML = `
            <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-md m-4 relative">
                <button onclick="hideApprovalModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                <h3 class="text-xl font-semibold mb-6 text-gray-800">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å #${voucher.id}</h3>
                <div class="mb-6 border rounded-lg bg-gray-50 p-4 max-h-60 overflow-y-auto">${itemsHtml}</div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="rejectVoucher(${voucher.id})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button onclick="approveVoucher(${voucher.id})" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button onclick="handlePartialApprove(${voucher.id})" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</button>
                </div>
            </div>`;
        modal.classList.remove('hidden');
    }
    function hideApprovalModal() { document.getElementById('approvalModal').classList.add('hidden'); }

    // ===========================================
    // üé® FIXED FLEX MESSAGE GENERATORS
    // ===========================================

    function createStatusFlex(title, voucherId, items, colorCode) {
        if (!Array.isArray(items)) items = [];

        const itemSummary = items.map(item => {
            const ppe = currentData.ppeItems.find(p => p.id == item.itemId);
            const itemName = ppe ? ppe.name : `‡∏£‡∏´‡∏±‡∏™: ${item.itemId}`;
            return {
                type: "box",
                layout: "horizontal",
                margin: "xs",
                contents: [
                    {
                        type: "text",
                        text: `‚Ä¢ ${itemName}`,
                        size: "xs",
                        color: "#666666",
                        flex: 4,
                        wrap: true
                    },
                    {
                        type: "text",
                        text: `x${item.quantity}`,
                        size: "xs",
                        color: "#333333",
                        flex: 1,
                        align: "end",
                        weight: "bold"
                    }
                ]
            };
        });

        return {
            type: "flex",
            altText: title,
            contents: {
                type: "bubble",
                body: {
                    type: "box",
                    layout: "vertical",
                    spacing: "sm",
                    contents: [
                        {
                            type: "text",
                            text: title,
                            weight: "bold",
                            size: "lg",
                            color: colorCode
                        },
                        {
                            type: "text",
                            text: `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: #${voucherId}`,
                            size: "sm",
                            weight: "bold"
                        },
                        { type: "separator", margin: "sm" },
                        {
                            type: "box",
                            layout: "vertical",
                            contents: itemSummary.length
                                ? itemSummary
                                : [{ type: "text", text: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", size: "xs", color: "#999999" }]
                        }
                    ]
                }
            }
        };
    }

    function buildItemListForFlex(items) {
        if (!Array.isArray(items) || items.length === 0) {
            return [{
                type: "text",
                text: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå",
                size: "xs",
                color: "#9CA3AF"
            }];
        }

        return items.map(item => {
            const ppe = currentData.ppeItems.find(p => p.id == item.itemId);
            const itemName = ppe ? ppe.name : `‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå #${item.itemId}`;
            const imageUrl = ppe?.image_url || 'https://via.placeholder.com/80';

            return {
                type: "box",
                layout: "horizontal",
                spacing: "sm",
                contents: [
                    {
                        type: "image",
                        url: imageUrl,
                        size: "sm",
                        aspectRatio: "1:1",
                        aspectMode: "cover"
                    },
                    {
                        type: "box",
                        layout: "vertical",
                        flex: 1,
                        contents: [
                            {
                                type: "text",
                                text: itemName,
                                size: "sm",
                                weight: "bold",
                                wrap: true
                            },
                            {
                                type: "text",
                                text: `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity}`,
                                size: "xs",
                                color: "#6B7280"
                            }
                        ]
                    }
                ]
            };
        });
    }

// ‡∏£‡∏±‡∏ö approvalStatus ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ üëá
    function createApprovalFlex({ title, icon, color, voucher, items, approvalStatus }) {

        const liffUrl = `https://liff.line.me/2007053300-JTSerFbF?mode=confirmReceive&voucherId=${voucher.id}`;
        const approveTime = formatThaiDateTime(new Date());

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Footer (‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î) ---
        let footerContents = [];

        if (approvalStatus === 'rejected') {
            // ‚ùå ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô‡∏õ‡∏∏‡πà‡∏°
            footerContents = [
                {
                    type: "text",
                    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢",
                    size: "xs",
                    align: "center",
                    color: "#9CA3AF"
                }
            ];
        } else if (voucher.status_received === 'received') {
            // üü¢ ‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
            footerContents = [
                {
                    type: "text",
                    text: "üü¢ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
                    align: "center",
                    weight: "bold",
                    color: "#10B981"
                },
                {
                    type: "text",
                    text: `‡πÄ‡∏ß‡∏•‡∏≤: ${formatThaiDateTime(voucher.received_at)}`,
                    size: "xs",
                    align: "center",
                    color: "#6B7280"
                }
            ];
        } else {
            // üîµ ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á): ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            footerContents = [
                {
                    type: "button",
                    style: "primary",
                    color: "#2563EB",
                    action: {
                        type: "uri",
                        label: "‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á",
                        uri: liffUrl
                    }
                }
            ];
        }
        // --------------------------------

        return {
            type: "flex",
            altText: `${title} (#${voucher.id})`,
            contents: {
                type: "bubble",
                styles: {
                    header: { backgroundColor: color }
                },
                header: {
                    type: "box",
                    layout: "horizontal",
                    contents: [
                        { type: "text", text: icon, size: "lg" },
                        {
                            type: "text",
                            text: title,
                            weight: "bold",
                            color: "#FFFFFF",
                            margin: "md"
                        }
                    ]
                },
                body: {
                    type: "box",
                    layout: "vertical",
                    spacing: "sm",
                    contents: [
                        { type: "text", text: `‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà #${voucher.id}`, weight: "bold" },
                        { type: "text", text: `‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å: ${voucher.user}`, size: "sm" },
                        { type: "text", text: `‡πÅ‡∏ú‡∏ô‡∏Å: ${voucher.department}`, size: "sm" },

                        { type: "separator", margin: "sm" },

                        // üßë‚Äçüíº Admin + ‡πÄ‡∏ß‡∏•‡∏≤
                        {
                            type: "box",
                            layout: "vertical",
                            spacing: "xs",
                            contents: [
                                { type: "text", text: `‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢: ${CURRENT_ADMIN_NAME}`, size: "xs" },
                                { type: "text", text: `‡πÄ‡∏ß‡∏•‡∏≤: ${approveTime}`, size: "xs", color: "#6B7280" }
                            ]
                        },

                        { type: "separator", margin: "sm" },

                        // üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                        {
                            type: "box",
                            layout: "vertical",
                            spacing: "sm",
                            contents: buildItemListForFlex(items)
                        }
                    ]
                },

                // üîò Footer ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô Logic ‡πÅ‡∏•‡πâ‡∏ß
                footer: {
                    type: "box",
                    layout: "vertical",
                    spacing: "sm",
                    contents: footerContents
                }
            }
        };
    }

    async function sendApprovalLine(type, voucher, items) {

        let title = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å';
        let color = '#374151';
        let icon = '‚ÑπÔ∏è';

        if (type === 'approved') {
            title = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
            color = '#16A34A';
            icon = '‚úÖ';
        } else if (type === 'rejected') {
            title = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å';
            color = '#DC2626';
            icon = '‚ùå';
        } else if (type === 'partial') {
            title = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
            color = '#D97706';
            icon = '‚ö†Ô∏è';
        }

        const flex = createApprovalFlex({
            title,
            icon,
            color,
            voucher,
            items,
            approvalStatus: type // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        });

        await fetch('/api/push', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: voucher.userid,
                messages: [flex]
            })
        });
    }

    // ===========================================
    // üõ†Ô∏è ADMIN APPROVAL FUNCTIONS (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ)
    // ===========================================

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    async function approveVoucher(voucherId) {
        if (await showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {

            const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
            if (!voucher) return;

            let items = [];
            try {
                items = (typeof voucher.itemsJson === 'string')
                    ? JSON.parse(voucher.itemsJson)
                    : (voucher.itemsJson || []);
            } catch { items = []; }

            await callServerFunction('approveVoucher', { voucherId });

            // ‚úÖ ‡∏™‡πà‡∏á LINE ‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á
            await sendApprovalLine(
                'approved',
                voucher,
                items
            );

            showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            hideApprovalModal();
            initializeApp();
        }
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    async function rejectVoucher(voucherId) {
        if (await showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò', '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {

            const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
            if (!voucher) return;

            let items = [];
            try {
                items = (typeof voucher.itemsJson === 'string')
                    ? JSON.parse(voucher.itemsJson)
                    : (voucher.itemsJson || []);
            } catch { items = []; }

            await callServerFunction('rejectVoucher', { voucherId });

            // ‚úÖ ‡∏™‡πà‡∏á LINE ‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á
            await sendApprovalLine(
                'rejected',
                voucher,
                items
            );

            showToast('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
            hideApprovalModal();
            initializeApp();
        }
    }

    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    async function handlePartialApprove(voucherId) {

        const approvedItems = [];
        document.querySelectorAll('#approvalModal .item-approval-row').forEach(row => {
            approvedItems.push({
                itemId: Number(row.dataset.itemId),
                quantity: Number(row.querySelector('.approved-quantity').value)
            });
        });

        const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
        if (!voucher) return;

        await callServerFunction('approvePartialVoucher', {
            voucherId,
            items: approvedItems
        });

        // ‚úÖ ‡∏™‡πà‡∏á LINE ‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á
        await sendApprovalLine(
            'partial',
            voucher,
            approvedItems
        );

        showToast('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        hideApprovalModal();
        initializeApp();
    }

    let isConfirmingReceive = false;

    async function handleLiffConfirmReceive() {
        console.log('üî• handleLiffConfirmReceive CALLED');
        
        // 1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Session (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
        const params = new URLSearchParams(window.location.search);
        const modeFromUrl = params.get('mode');
        const voucherIdFromUrl = params.get('voucherId');

        if (modeFromUrl === 'confirmReceive' && voucherIdFromUrl) {
            sessionStorage.setItem('confirm_mode', modeFromUrl);
            sessionStorage.setItem('confirm_voucher_id', voucherIdFromUrl);
        }

        // 2. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Session ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        const mode = sessionStorage.getItem('confirm_mode');
        const voucherId = sessionStorage.getItem('confirm_voucher_id');

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
        if (mode !== 'confirmReceive' || !voucherId) return;
        if (isConfirmingReceive) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≥

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        if (!liff.isLoggedIn()) { liff.login(); return; }

        try {
            isConfirmingReceive = true;
            hideLoading(); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ

            // 3. ‡∏ñ‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?"
            const confirm = await showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            
            if (!confirm) { 
                // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" -> ‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠)
                isConfirmingReceive = false; 
                return; 
            }

            // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á
            showLoading(); // ‡∏•‡πá‡∏≠‡∏Ñ‡∏à‡∏≠‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            const profile = await liff.getProfile();

            // ‡∏¢‡∏¥‡∏á API ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (Backend)
            await callServerFunction('confirmReceive', {
                voucherId: Number(voucherId),
                userId: profile.userId,
                userName: profile.displayName
            });

            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showToast('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Session (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)
            sessionStorage.removeItem('confirm_mode');
            const confirmedId = sessionStorage.getItem('confirm_voucher_id'); // ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Review
            sessionStorage.removeItem('confirm_voucher_id');

            // --- ‚ö° ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ---
            
            // 5. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ App ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å Voucher ‡∏ô‡∏µ‡πâ)
            const updatedData = await callServerFunction('getInitialData');
            onDataLoaded(updatedData);
            hideLoading();
            
            // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Dashboard ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
            showPage('dashboard'); 
            
            // 6. ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö (‡∏™‡πà‡∏á true ‡πÑ‡∏õ‡πÉ‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà 2)
            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡∏û‡∏£‡πâ‡∏≠‡∏°
            setTimeout(() => {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å openRatingSelector(id, mandatory=true)
                openRatingSelector(confirmedId, true);
            }, 500);
            
            // ----------------------------------------------------

        } catch (err) {
            console.error(err);
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
            hideLoading();
        } finally {
            isConfirmingReceive = false;
        }
    }

    function previewImageAdmin() {
        const url = document.getElementById('itemImage').value;
        const img = document.getElementById('adminImagePreview');
        if (url) { img.src = url; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
    }

    function handleManageSubmit(e) {
        e.preventDefault();
        if (!isAdmin) return showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'error');
        const itemData = {
            id: document.getElementById('editItemId').value || null,
            code: document.getElementById('itemCode').value,
            name: document.getElementById('itemName').value,
            category: document.getElementById('itemCategory').value,
            unit: document.getElementById('itemUnit').value,
            reorderPoint: Number(document.getElementById('itemReorderPoint').value),
            stock: Number(document.getElementById('itemStock').value),
            onLoanQuantity: Number(document.getElementById('onLoanQuantity').value || 0),
            price: Number(document.getElementById('itemPrice').value || 0),
            imageUrl: document.getElementById('itemImage').value
        };
        callServerFunction('savePpeItem', itemData).then(result => {
            showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${result.item.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            resetManageForm();
            initializeApp();
        });
    }

    function editItem(itemId) {
        const item = currentData.ppeItems.find(p => p.id == itemId);
        if (item) {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î set value ‡πÄ‡∏î‡∏¥‡∏°) ...
            document.getElementById('editItemId').value = item.id;
            document.getElementById('itemCode').value = item.code;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('itemReorderPoint').value = item.reorderPoint;
            document.getElementById('itemStock').value = item.stock;
            document.getElementById('onLoanQuantity').value = item.onLoanQuantity || 0;
            document.getElementById('itemPrice').value = item.price || 0;
            document.getElementById('itemImage').value = item.image_url || '';
            
            // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ
            document.getElementById('manageFormTitle').innerHTML = '<i class="fa-solid fa-pen-to-square text-orange-500 mr-2"></i>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
            updateImagePreview(item.image_url); 
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏° (Mobile ‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
            document.getElementById('managePage').scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function deleteItem(itemId) {
        if (!isAdmin) return showToast('‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
        
        const confirm = await showConfirmationModal(
            '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 
            '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?'
        );

        if (confirm) {
            showLoading();
            // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô deletePpeItem ‡πÉ‡∏ô Google Apps Script ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞
            // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° JS ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏∞ error. 
            // ‡∏ñ‡πâ‡∏≤ Backend ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á items: [] ‡∏´‡∏£‡∏∑‡∏≠ logic ‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ó‡∏ô
            // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤ Backend ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß:
            try {
                await callServerFunction('deletePpeItem', { id: itemId });
                showToast('‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
                // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const data = await callServerFunction('getInitialData');
                onDataLoaded(data);
            } catch (e) {
                console.error(e);
                showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
    }

    function resetManageForm() {
        document.getElementById('manageForm').reset();
        document.getElementById('editItemId').value = '';
        document.getElementById('manageFormTitle').innerHTML = '<i class="fa-solid fa-plus-circle text-teal-600 mr-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà';
        updateImagePreview(''); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ
    }

    function handleReceiveSubmit(e) {
        e.preventDefault();
        if (!isAdmin) return showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'error');
        const itemId = document.getElementById('receiveItemId').value;
        if (!itemId) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', 'error');
        const transactionData = {
            itemId: Number(itemId),
            quantity: Number(document.getElementById('receiveQuantity').value),
            type: document.getElementById('receiveType').value,
            user: document.getElementById('receiveUser').value,
            department: document.getElementById('receiveDepartment').value,
        };
        callServerFunction('addReceiveTransaction', transactionData).then(() => {
            showToast('‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            resetReceiveForm();
            initializeApp();
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (Loan) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ID ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
    async function handleBorrowSubmit(e) {
        if(e) e.preventDefault();

        const itemId = document.getElementById('loanItemId').value;
        
        // ‚≠ê ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å borrowerName ‡πÄ‡∏õ‡πá‡∏ô loanUser
        const userNameInput = document.getElementById('loanUser');
        const userName = userNameInput ? userNameInput.value : '';
        
        const empId = document.getElementById('loanEmployeeId').value;

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        if(empId) localStorage.setItem('last_employee_id', empId);

        const dept = document.getElementById('loanDepartment').value;
        const dueDate = document.getElementById('loanDueDate').value;
        const notes = document.getElementById('loanNotes').value;
        const itemName = document.getElementById('loanItemName').innerText;

        if (!itemId || !userName || !dueDate) { 
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå, ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°, ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô)', 'error');
            return; 
        }

        const currentUserId = (typeof liffProfile !== 'undefined' && liffProfile) ? liffProfile.userId : '';

        if(typeof showLoading === 'function') showLoading();

        try {
            await callServerFunction('borrowItem', {
                itemId: Number(itemId), 
                borrowerName: userName, // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ userName ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß
                employeeId: empId, 
                department: dept, 
                userId: currentUserId, 
                dueDate: dueDate, 
                notes: notes
            });
            
            if(typeof hideLoading === 'function') hideLoading();

            // --- üîî ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ---
            const itemObj = { 
                name: itemName, 
                image_url: document.getElementById('loanItemImg').src 
            }; 
            const loanFlex = createLoanFlex(itemObj, userName, dept, dueDate);

            // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°
            if (currentUserId) {
                fetch('/api/push', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUserId, messages: [loanFlex] }) }).catch(console.error);
            }

            // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            if (typeof ADMIN_USER_ID !== 'undefined' && ADMIN_USER_ID) {
                fetch('/api/push', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: ADMIN_USER_ID, messages: [loanFlex] }) }).catch(console.error);
            }

            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            document.getElementById('loanForm').reset();
            
            // Reset UI
            document.getElementById('loanItemName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...';
            document.getElementById('loanItemImg').classList.add('hidden');
            document.getElementById('loanItemImgPlaceholder').classList.remove('hidden');
            document.getElementById('loanItemId').value = '';

            if(typeof autoFillUserIdentity === 'function') autoFillUserIdentity();
            const updatedData = await callServerFunction('getInitialData');
            onDataLoaded(updatedData);
            showPage('dashboard');

        } catch (error) {
            if(typeof hideLoading === 'function') hideLoading();
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        }
    }

    function handleSaveCategory(e) {
        e.preventDefault();
        if (!isAdmin) return showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'error');
        callServerFunction('saveCategory', {
            id: document.getElementById('editCategoryId').value || null,
            name: document.getElementById('categoryNameInput').value,
        }).then(() => {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            resetCategoryForm();
            initializeApp();
        });
    }

    async function handleDeleteCategory(categoryId) {
        if (!isAdmin) return showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'error');
        const confirmed = await showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ?');
        if (confirmed) {
            callServerFunction('deleteCategory', { categoryId }).then(() => {
                showToast('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                initializeApp();
            });
        }
    }

    async function handleReturnItem(loanId) {
        const confirmed = await showConfirmationModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
        
        if (confirmed) {
            const loan = currentData.loanTransactions.find(l => l.loanId == loanId);
            const targetUserId = loan ? (loan.userid || loan.userId) : '';
            const item = currentData.ppeItems.find(p => p.id == loan.itemId);
            const itemName = item ? item.name : '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';

            callServerFunction('returnItem', { loanId }).then(async () => {
                // ‚úÖ ‡∏™‡πà‡∏á Flex Message ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                if (targetUserId) {
                    const returnDate = new Date().toLocaleDateString('th-TH');
                    const flex = createStatusFlex(
                        '‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úÖ',
                        loan.loanId,
                        [
                            { itemId: loan.itemId, quantity: 1 }
                        ],
                        '#3B82F6'
                        );                  
                    fetch('/api/push', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: targetUserId, messages: [flex] }) }).catch(console.error);
                }

                showToast('‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                initializeApp();
            });
        }
    }

    function showConfirmationModal(title, message) {
        return new Promise(resolve => {
            const modal = document.getElementById('confirmationModal');
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            modal.classList.remove('hidden');
            const confirmBtn = document.getElementById('confirmProceedBtn');
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            const cleanup = () => {
                modal.classList.add('hidden');
                newConfirmBtn.removeEventListener('click', handleConfirm);
                newCancelBtn.removeEventListener('click', handleCancel);
            };
            const handleConfirm = () => { cleanup(); resolve(true); };
            const handleCancel = () => { cleanup(); resolve(false); };
            newConfirmBtn.addEventListener('click', handleConfirm);
            newCancelBtn.addEventListener('click', handleCancel);
        });
    }

    // ===========================================
    // USER DASHBOARD LOGIC (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
    // ===========================================

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô autoFillUserIdentity
    function autoFillUserIdentity() {
        if(liffProfile) {
            // ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å
            const u = document.getElementById('issueUser'); 
            if(u) { 
                const mode = document.querySelector('input[name="issueUserMode"]:checked')?.value;
                if(mode !== 'custom') {
                    u.value = liffProfile.displayName; 
                    u.readOnly = true; 
                    u.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed'); 
                }
            }

            // ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° (‡πÅ‡∏Å‡πâ ID ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å borrowerName ‡πÄ‡∏õ‡πá‡∏ô loanUser)
            const b = document.getElementById('loanUser'); 
            if(b) { 
                const mode = document.querySelector('input[name="loanUserMode"]:checked')?.value;
                if(mode !== 'custom') {
                    b.value = liffProfile.displayName; 
                    b.readOnly = true; 
                    b.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed'); 
                }
            }
        }

        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        const savedEmpId = localStorage.getItem('last_employee_id');
        if(savedEmpId) {
            const empField1 = document.getElementById('employeeId');
            if(empField1) empField1.value = savedEmpId;
            
            const empField2 = document.getElementById('loanEmployeeId');
            if(empField2) empField2.value = savedEmpId;
        }
    }

    function toggleMobileAdminMenu() {
        const menu = document.getElementById('mobileMoreMenu');
        menu.classList.toggle('hidden');
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateUI ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏î‡πâ‡∏ß‡∏¢
    // (‡πÄ‡∏û‡∏¥‡πà‡∏° logic ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateUI ‡πÄ‡∏î‡∏¥‡∏° ‡∏ï‡∏£‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÜ)
    const adminLinks = document.getElementById('adminMobileLinks');
    const userLinks = document.getElementById('userMobileLinks');
    
    if (isAdmin) {
        if(adminLinks) adminLinks.classList.remove('hidden');
        if(userLinks) userLinks.classList.add('hidden');
    } else {
        if(adminLinks) adminLinks.classList.add('hidden');
        if(userLinks) userLinks.classList.remove('hidden');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å (Issue) - ‡∏™‡πà‡∏á Flex Message
    async function saveIssueVoucher(e) { 
        if (e) e.preventDefault(); 

        try {
            // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            let cart = [];
            document.querySelectorAll('#issueItemsContainer .issue-item').forEach(row => {
                const itemId = row.querySelector('.item-select-value')?.value;
                const quantity = row.querySelector('.item-quantity')?.value;
                if (itemId && quantity > 0) {
                    cart.push({ itemId: Number(itemId), quantity: Number(quantity) });
                }
            });

            if (cart.length === 0) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
                return;
            }

            // 2. ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö LINE / ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)
            const nameMode =
                document.querySelector('input[name="issueUserMode"]:checked')?.value || 'line';

            const userName =
                nameMode === 'custom'
                    ? document.getElementById('issueUser').value.trim()
                    : (liffProfile?.displayName || '');

            const empId = document.getElementById('employeeId').value.trim();
            const dept = document.getElementById('issueDepartment').value;

            // üëáüëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) üëáüëá
            if(empId) localStorage.setItem('last_employee_id', empId); 
            // üëÜüëÜ

            // 3. Validation
            if (!empId || !dept) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å', 'error');
                return;
            }

            if (nameMode === 'custom' && !userName) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å', 'error');
                return;
            }

            const currentUserId =
                (typeof liffProfile !== 'undefined' && liffProfile)
                    ? liffProfile.userId
                    : '';

            if (typeof showLoading === 'function') showLoading();

            // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            const newVoucher = await callServerFunction('addNewVoucher', {
                user: userName,
                employeeId: empId,
                department: dept,
                userId: currentUserId,
                items: cart
            });

            // ‚≠ê‚≠ê‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡πà‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å) ‚≠ê‚≠ê‚≠ê
            // ‡∏¢‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ local ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ showVoucherSlip ‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô
            currentData.issueVouchers.unshift(newVoucher); 
            // ‚≠ê‚≠ê‚≠ê ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚≠ê‚≠ê‚≠ê

            // 5. üîî ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message
            const userFlex = createIssueFlex(
                newVoucher.id,
                userName,
                dept,
                cart,
                '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
            );

            const adminFlex = createIssueFlex(
                newVoucher.id,
                userName,
                dept,
                cart,
                '‡∏°‡∏µ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì'
            );

            // 6. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å
            if (currentUserId) {
                fetch('/api/push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUserId,
                        messages: [userFlex]
                    })
                }).catch(console.error);
            }

            // 7. ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
            if (typeof ADMIN_USER_ID !== 'undefined' && ADMIN_USER_ID) {
                fetch('/api/push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: ADMIN_USER_ID,
                        messages: [adminFlex]
                    })
                }).catch(console.error);
            }

            if (typeof hideLoading === 'function') hideLoading();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            showVoucherSlip(newVoucher.id);

            // 8. reset ‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('issueForm').reset();
            document.getElementById('issueItemsContainer').innerHTML = '';

            if (typeof autoFillUserIdentity === 'function') {
                autoFillUserIdentity();
            }

            // 9. reload ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const updatedData = await callServerFunction('getInitialData');
            onDataLoaded(updatedData);
            showPage('dashboard');

        } catch (error) {
            if (typeof hideLoading === 'function') hideLoading();
            console.error("Save Error:", error);
            showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message, 'error');
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏° (Loan) - ‡∏™‡πà‡∏á Flex Message
    async function saveLoanTransaction(e) {
        if(e) e.preventDefault();

        const itemId = document.getElementById('loanItemId').value;
        const userName = document.getElementById('loanUser').value;
        const empId = document.getElementById('loanEmployeeId').value;

        // üëáüëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á) üëáüëá
        if(empId) localStorage.setItem('last_employee_id', empId);
        // üëÜüëÜ

        const dept = document.getElementById('loanDepartment').value;
        const dueDate = document.getElementById('loanDueDate').value;
        const notes = document.getElementById('loanNotes').value;
        const itemName = document.getElementById('loanItemName').innerText;

        if (!itemId || !userName || !dueDate) { 
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå, ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°, ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô)', 'error');
            return; 
        }

        const currentUserId = (typeof liffProfile !== 'undefined' && liffProfile) ? liffProfile.userId : '';

        if(typeof showLoading === 'function') showLoading();

        try {
            await callServerFunction('borrowItem', {
                itemId: Number(itemId), borrowerName: userName, employeeId: empId, 
                department: dept, userId: currentUserId, dueDate: dueDate, notes: notes
            });
            
            if(typeof hideLoading === 'function') hideLoading();

            // --- üîî ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ---
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á object item ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ template (‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
            const itemObj = { 
                name: itemName, 
                image_url: document.getElementById('loanItemImg').src 
            }; 
            const loanFlex = createLoanFlex(itemObj, userName, dept, dueDate);

            // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° - ‡πÅ‡∏ö‡∏ö Flex
            if (currentUserId) {
                fetch('/api/push', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUserId, messages: [loanFlex] }) }).catch(console.error);
            }

            // ‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡πÅ‡∏ö‡∏ö Flex
            if (typeof ADMIN_USER_ID !== 'undefined' && ADMIN_USER_ID) {
                fetch('/api/push', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: ADMIN_USER_ID, messages: [loanFlex] }) }).catch(console.error);
            }

            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            document.getElementById('loanForm').reset();
            
            // Reset UI
            document.getElementById('loanItemName').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...';
            document.getElementById('loanItemImg').classList.add('hidden');
            document.getElementById('loanItemImgPlaceholder').classList.remove('hidden');
            document.getElementById('loanItemId').value = '';

            if(typeof autoFillUserIdentity === 'function') autoFillUserIdentity();
            const updatedData = await callServerFunction('getInitialData');
            onDataLoaded(updatedData);
            showPage('dashboard');

        } catch (error) {
            if(typeof hideLoading === 'function') hideLoading();
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        }
    }

    async function sendLineNotify(msg) {
        try {
            const safeMessage =
                typeof msg === 'string'
                    ? msg
                    : JSON.stringify(msg, null, 2);

            await fetch('/api/notify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: safeMessage })
            });

            console.log('‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        } catch (error) {
            console.error('‡∏™‡πà‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô:', error);
        }
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô bindIssueUserModeRadios ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ
    function bindIssueUserModeRadios() {
        const radios = document.querySelectorAll('input[name="issueUserMode"]');
        const input = document.getElementById('issueUser');

        if (!radios.length || !input) return;

        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'custom') {
                    // === ‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ===
                    input.readOnly = false;
                    input.disabled = false;
                    input.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà
                    
                    // ‡∏•‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡∏≠‡∏Å ‡πÉ‡∏™‡πà‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ
                    input.classList.remove('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                    input.classList.add('bg-white', 'text-gray-900');
                    
                    input.focus();
                } else {
                    // === ‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ LINE ===
                    input.readOnly = true;
                    // input.disabled = true; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á disable ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤ readOnly ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÜ
                    
                    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
                    input.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                    input.classList.remove('bg-white', 'text-gray-900');

                    // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global liffProfile ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏∑‡∏ô
                    if (typeof liffProfile !== 'undefined' && liffProfile) {
                        input.value = liffProfile.displayName;
                    } else {
                        input.value = '';
                    }
                }
            });
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Radio Button ‡∏´‡∏ô‡πâ‡∏≤ "‡∏¢‡∏∑‡∏°" (Copy Logic ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å)
    function bindLoanUserModeRadios() {
        const radios = document.querySelectorAll('input[name="loanUserMode"]');
        const input = document.getElementById('loanUser');

        if (!radios.length || !input) return;

        radios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'custom') {
                    // === ‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ===
                    input.readOnly = false;
                    input.disabled = false;
                    input.value = ''; 
                    input.classList.remove('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                    input.classList.add('bg-white', 'text-gray-900');
                    input.focus();
                } else {
                    // === ‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ LINE ===
                    input.readOnly = true;
                    // ‡πÉ‡∏™‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô disabled/readonly style
                    input.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                    input.classList.remove('bg-white', 'text-gray-900');

                    if (typeof liffProfile !== 'undefined' && liffProfile) {
                        input.value = liffProfile.displayName;
                    } else {
                        input.value = '';
                    }
                }
            });
        });
    }

    // üîÑ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (Refresh)
    async function refreshDashboardData(btn) {
        if(btn) btn.classList.add('fa-spin'); // ‡∏´‡∏°‡∏∏‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
        try {
            const data = await callServerFunction('getInitialData');
            onDataLoaded(data);
            showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
        } catch(e) {
            showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        } finally {
            if(btn) btn.classList.remove('fa-spin');
        }
    }

    // üîÅ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡∏ã‡πâ‡∏≥ (Reorder)
    function reorderVoucher(voucherId) {
        const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
        if (!voucher) return;

        // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        let items = [];
        try { items = Array.isArray(voucher.itemsJson) ? voucher.itemsJson : JSON.parse(voucher.itemsJson || '[]'); } catch (e) { items = []; }

        // 2. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏Å‡πà‡∏≤
        resetIssueForm();
        
        // 3. ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å
        showPage('issue');
        hideVoucherModal();

        // 4. ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        setTimeout(() => {
            // ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏î‡∏¥‡∏°
            const deptSelect = document.getElementById('issueDepartment');
            if(deptSelect) deptSelect.value = voucher.department || '';

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏£‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            items.forEach(item => {
                const stockItem = currentData.ppeItems.find(p => p.id == item.itemId);
                if (stockItem) {
                    addIssueRow(stockItem); // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ addIssueRow ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ default ‡πÄ‡∏õ‡πá‡∏ô 1)
                    const rows = document.querySelectorAll('#issueItemsContainer .issue-item');
                    const lastRow = rows[rows.length - 1];
                    if(lastRow) {
                        const qtyInput = lastRow.querySelector('.item-quantity');
                        if(qtyInput) qtyInput.value = item.quantity;
                    }
                }
            });
            
            showToast('‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        }, 300);
    }

    // ==========================================
    // üßæ E-SLIP SYSTEM FUNCTIONS
    // ==========================================

    function showVoucherSlip(voucherId) {
        const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
        if (!voucher) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å', 'error');

        // 1. Prepare Data
        let items = [];
        try { items = Array.isArray(voucher.itemsJson) ? voucher.itemsJson : JSON.parse(voucher.itemsJson || '[]'); } catch (e) { items = []; }

        // 2. Fill Data to HTML
        document.getElementById('slipUser').textContent = voucher.user;
        document.getElementById('slipDept').textContent = voucher.department || '-';
        document.getElementById('slipRef').textContent = `#${voucher.id}`;
        document.getElementById('slipDate').textContent = new Date(voucher.timestamp).toLocaleString('th-TH', { 
            day: 'numeric', month: 'short', year: '2-digit', hour: '2-digit', minute:'2-digit' 
        });

        // 3. Render Items
        const listContainer = document.getElementById('slipItemsList');
        listContainer.innerHTML = items.map(item => {
            const ppe = currentData.ppeItems.find(p => p.id == item.itemId);
            const itemName = ppe ? ppe.name : 'Unknown Item';
            return `
            <div class="flex justify-between text-sm">
                <span class="text-gray-700 truncate w-3/4">‚Ä¢ ${itemName}</span>
                <span class="font-bold text-gray-900">x${item.quantity}</span>
            </div>`;
        }).join('');

        // üëáüëá ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÉ‡∏´‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏û üëáüëá
        // ‡∏î‡∏∂‡∏á URL ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏û (‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ? ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏∞‡∏≠‡∏≤‡∏î)
        const appUrl = window.location.href.split('?')[0]; 
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ QR Code
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&margin=10&data=${encodeURIComponent(appUrl)}`;
        
        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ QR Code ‡πÉ‡∏ô Modal
        const qrImage = document.querySelector('#slipContent img[src*="qrserver"]');
        if (qrImage) {
            qrImage.src = qrApiUrl;
        }
        // üëÜüëÜ ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ QR Code üëÜüëÜ

        // 4. Show Modal
        document.getElementById('slipModal').classList.remove('hidden');
    }

    function closeSlip() {
        document.getElementById('slipModal').classList.add('hidden');
    }

    // ==========================================
    // üõ†Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ
    // ==========================================
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ
    function closeImagePreview() {
        document.getElementById('imagePreviewModal').classList.add('hidden');
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (window.innerWidth <= 768);
    }

    // ==========================================
    // üìä ADMIN REPORT SYSTEM
    // ==========================================
    let currentReportData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠ Export

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"
    function initReportPage() {
        // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Default: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
        const formatDate = (d) => d.toISOString().split('T')[0];
        
        if(!document.getElementById('reportStartDate').value) {
            document.getElementById('reportStartDate').value = formatDate(firstDay);
            document.getElementById('reportEndDate').value = formatDate(today);
        }

        // 2. ‡πÄ‡∏ï‡∏¥‡∏° Option ‡πÅ‡∏ú‡∏ô‡∏Å (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö)
        const deptSelect = document.getElementById('reportDeptFilter');
        deptSelect.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';
        
        const depts = new Set();
        (currentData.issueVouchers || []).forEach(v => { if(v.department) depts.add(v.department); });
        
        Array.from(depts).sort().forEach(d => {
            const opt = document.createElement('option');
            opt.value = d;
            opt.innerText = d;
            deptSelect.appendChild(opt);
        });

        // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        filterReports();
    }

    function filterReports() {
        const startStr = document.getElementById('reportStartDate').value;
        const endStr = document.getElementById('reportEndDate').value;
        const deptFilter = document.getElementById('reportDeptFilter').value;

        const startDate = startStr ? new Date(startStr) : new Date('2000-01-01');
        startDate.setHours(0,0,0,0);
        
        const endDate = endStr ? new Date(endStr) : new Date();
        endDate.setHours(23,59,59,999);

        // 1. ‡∏Å‡∏£‡∏≠‡∏á Voucher
        const filteredVouchers = (currentData.issueVouchers || []).filter(v => {
            const vDate = new Date(v.timestamp);
            const matchDate = vDate >= startDate && vDate <= endDate;
            const matchDept = deptFilter === '' || v.department === deptFilter;
            // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ rejected (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡∏´‡∏°‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà requirement)
            const isValidStatus = v.status !== 'rejected'; 
            return matchDate && matchDept && isValidStatus;
        });

        // 2. ‡πÅ‡∏ï‡∏Å Data ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏¥‡πâ‡∏ô (Flatten)
        let flatData = [];
        let totalItemsCount = 0;
        let deptCounts = {};

        filteredVouchers.forEach(v => {
            const d = v.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            deptCounts[d] = (deptCounts[d] || 0) + 1;

            let items = [];
            try { items = Array.isArray(v.itemsJson) ? v.itemsJson : JSON.parse(v.itemsJson || '[]'); } catch(e) {}

            items.forEach(item => {
                const ppe = currentData.ppeItems.find(p => p.id == item.itemId);
                flatData.push({
                    date: v.timestamp,
                    voucherId: v.id,
                    user: v.user,
                    department: v.department || '-',
                    itemName: ppe ? ppe.name : 'Unknown',
                    itemCode: ppe ? ppe.code : '-',
                    quantity: parseInt(item.quantity)
                });
                totalItemsCount += parseInt(item.quantity);
            });
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        flatData.sort((a, b) => new Date(b.date) - new Date(a.date));
        currentReportData = flatData;

        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Summary
        document.getElementById('rptTotalVouchers').innerText = filteredVouchers.length;
        document.getElementById('rptTotalItems').innerText = totalItemsCount;
        
        let topDept = '-';
        let maxCount = 0;
        for (const [d, c] of Object.entries(deptCounts)) {
            if (c > maxCount) { maxCount = c; topDept = d; }
        }
        document.getElementById('rptTopDept').innerText = topDept;

        // 4. ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const tbody = document.getElementById('reportTableBody');
        const emptyState = document.getElementById('reportEmptyState');
        tbody.innerHTML = '';

        if (flatData.length === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
            tbody.innerHTML = flatData.map(row => `
                <tr class="bg-white border-b hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap align-top">
                        <div class="font-medium text-gray-900">${new Date(row.date).toLocaleDateString('th-TH', {day:'2-digit', month:'short', year:'2-digit'})}</div>
                        <div class="text-xs text-gray-400">${new Date(row.date).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</div>
                    </td>
                    <td class="px-6 py-4 align-top font-mono text-xs text-teal-600 font-bold">#${row.voucherId}</td>
                    <td class="px-6 py-4 align-top">
                        <div class="font-medium text-gray-900 text-sm">${row.user}</div>
                        <div class="text-xs text-gray-500">${row.department}</div>
                    </td>
                    <td class="px-6 py-4 align-top text-gray-700 text-sm">
                        ${row.itemName} <span class="text-xs text-gray-400">(${row.itemCode})</span>
                    </td>
                    <td class="px-6 py-4 align-top text-center font-bold text-gray-800">
                        ${row.quantity}
                    </td>
                </tr>
            `).join('');
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export Excel (CSV)
    function exportReportToCSV() {
        if (!currentReportData || currentReportData.length === 0) return showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ Export', 'error');

        let csvContent = "Date,Time,Voucher ID,User,Department,Item Code,Item Name,Quantity\n";

        currentReportData.forEach(row => {
            const d = new Date(row.date);
            const dateStr = d.toLocaleDateString('th-TH');
            const timeStr = d.toLocaleTimeString('th-TH');
            const cleanItem = `"${row.itemName.replace(/"/g, '""')}"`; // Escape comma
            const cleanUser = `"${row.user.replace(/"/g, '""')}"`;

            csvContent += `${dateStr},${timeStr},${row.voucherId},${cleanUser},${row.department},${row.itemCode},${cleanItem},${row.quantity}\n`;
        });

        // BOM \uFEFF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Excel ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ó‡∏¢‡∏≠‡∏≠‡∏Å
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `PPE_Report_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Print / PDF
    function printReport() {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Print
        const s = document.getElementById('reportStartDate').value;
        const e = document.getElementById('reportEndDate').value;
        const d1 = s ? new Date(s).toLocaleDateString('th-TH') : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô';
        const d2 = e ? new Date(e).toLocaleDateString('th-TH') : '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
        
        document.getElementById('printDateRange').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d1} ‡∏ñ‡∏∂‡∏á ${d2}`;
        window.print();
    }

    // --- üåü Logic ‡∏£‡∏∞‡∏ö‡∏ö Feedback (Supabase Version) ---
    
    function openFeedbackModal(itemData, transactionId, type) {
        // 1. Reset ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        document.getElementById('feedbackScore').value = 0;
        document.getElementById('feedbackComment').value = '';
        document.getElementById('btnSubmitFeedback').disabled = true;
        updateStars(0);

        // 2. Set ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ DB
        document.getElementById('feedbackTransactionId').value = transactionId;
        document.getElementById('feedbackItemId').value = itemData.id;
        document.getElementById('feedbackType').value = type;
        
        // 3. Set UI
        document.getElementById('feedbackItemName').textContent = itemData.name;
        const img = document.getElementById('feedbackItemImg');
        img.src = itemData.image_url || 'https://placehold.co/150?text=No+Img';

        // 4. Show Modal
        document.getElementById('feedbackModal').classList.remove('hidden');
    }

    function closeFeedbackModal() {
        document.getElementById('feedbackModal').classList.add('hidden');
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏î‡∏≤‡∏ß
    function setRating(val) {
        document.getElementById('feedbackScore').value = val;
        updateStars(val);
        document.getElementById('btnSubmitFeedback').disabled = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á
    }

    function updateStars(val) {
        const stars = document.querySelectorAll('.star-btn');
        stars.forEach((btn, index) => {
            if (index < val) {
                btn.classList.remove('text-gray-200');
                btn.classList.add('text-yellow-400');
            } else {
                btn.classList.add('text-gray-200');
                btn.classList.remove('text-yellow-400');
            }
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
    async function submitFeedback() {
        const payload = {
            transactionId: document.getElementById('feedbackTransactionId').value,
            itemId: document.getElementById('feedbackItemId').value,
            itemName: document.getElementById('feedbackItemName').textContent,
            type: document.getElementById('feedbackType').value,
            rating: document.getElementById('feedbackScore').value,
            comment: document.getElementById('feedbackComment').value,
            user: (typeof liffProfile !== 'undefined' && liffProfile) ? liffProfile.displayName : 'Guest'
        };

        if(payload.rating == 0) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á', 'error');

        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á)
        closeFeedbackModal(); 
        showLoading();

        try {
            await callServerFunction('saveFeedback', payload);
            
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚≠ê');

            // ‚úÖ‚úÖ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Local ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ List ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å ‚úÖ‚úÖ‚úÖ
            if (!currentData.feedbackData) currentData.feedbackData = [];
            currentData.feedbackData.push({
                transaction_id: payload.transactionId,
                item_id: payload.itemId,
                rating: payload.rating,
                comment: payload.comment,
                user_name: payload.user,
                item_name: payload.itemName,
                created_at: new Date().toISOString()
            });

            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ï‡πâ Modal ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ‡πÉ‡∏´‡πâ Refresh ‡∏°‡∏±‡∏ô
            // ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å openRatingSelector ‡∏ã‡πâ‡∏≥‡∏î‡πâ‡∏ß‡∏¢ ID ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°
            const selectorModal = document.getElementById('rateItemSelectorModal');
            if (!selectorModal.classList.contains('hidden')) {
                // ‡∏´‡∏≤ Voucher ID ‡∏à‡∏≤‡∏Å input ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                // ‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á payload.transactionId ‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                openRatingSelector(payload.transactionId, isMandatoryReview);
            }
            // ‚úÖ‚úÖ‚úÖ ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ‚úÖ‚úÖ‚úÖ
            
        } catch (error) {
            // ... (Error handling ‡πÄ‡∏î‡∏¥‡∏°) ...
        } finally {
            hideLoading();
        }
    }

    // ==========================================
    // üåü MANDATORY REVIEW SYSTEM LOGIC
    // ==========================================
    
    let isMandatoryReview = false; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Logic ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
    function openRatingSelector(voucherId, mandatory = false) {
        isMandatoryReview = mandatory;
        const voucher = currentData.issueVouchers.find(v => v.id == voucherId);
        
        if (!voucher) {
            console.error("Voucher not found");
            return; 
        }

        // üîíüîíüîí Security Check: ‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô üîíüîíüîí
        const currentUser = (typeof liffProfile !== 'undefined' && liffProfile) ? liffProfile.displayName : '';
        // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö (‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏≤‡∏à‡∏≤‡∏Å ConfirmFlow) -> ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î
        if (!mandatory && voucher.user !== currentUser && !isAdmin) {
             return showToast('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ', 'error');
        }
        // üîíüîíüîí ------------------------------- üîíüîíüîí

        let items = [];
        try { items = Array.isArray(voucher.itemsJson) ? voucher.itemsJson : JSON.parse(voucher.itemsJson || '[]'); } catch (e) { items = []; }

        const listContainer = document.getElementById('rateItemList');
        listContainer.innerHTML = '';

        let allRated = true;

        items.forEach(item => {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô loop) ...
            // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏™‡πâ‡πÉ‡∏ô loop ‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
            // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ
             const ppe = currentData.ppeItems.find(p => p.id == item.itemId);
            const itemName = ppe ? ppe.name : 'Unknown Item';
            const imgUrl = ppe?.image_url || 'https://placehold.co/100?text=Item';

            const isRated = (currentData.feedbackData || []).some(f => 
                String(f.transaction_id) === String(voucherId) && 
                String(f.item_id) === String(item.itemId)
            );

            if (!isRated) allRated = false;

            const cardClass = isRated 
                ? 'bg-green-50 border-green-200 opacity-80' 
                : 'bg-white border-gray-200 hover:border-teal-400 hover:shadow-md cursor-pointer animate-pulse-slow';
            
            const iconHtml = isRated
                ? `<div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><i class="fa-solid fa-check"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center group-hover:scale-110 transition-transform"><i class="fa-regular fa-star text-lg"></i></div>`;

            const onClick = isRated ? '' : `onclick="openFeedbackModal({id: '${item.itemId}', name: '${itemName}', image_url: '${imgUrl}'}, '${voucherId}', 'issue');"`;

            const html = `
            <div ${onClick} class="flex items-center gap-3 p-3 rounded-xl border ${cardClass} transition-all group relative overflow-hidden">
                <img src="${imgUrl}" class="w-12 h-12 rounded-lg object-contain bg-white border border-gray-100">
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-gray-800 text-sm truncate">${itemName}</h4>
                    <p class="text-xs text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${item.quantity}</p>
                </div>
                <div>${iconHtml}</div>
                ${!isRated ? '<div class="absolute right-0 top-0 bottom-0 w-1 bg-orange-400"></div>' : ''}
            </div>`;
            
            listContainer.insertAdjacentHTML('beforeend', html);
        });

        // ... (‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
        const closeBtn = document.getElementById('btnCloseRateSelector');
        const finishBtn = document.getElementById('btnFinishRating');

        if (isMandatoryReview) {
            closeBtn.classList.add('hidden');
        } else {
            closeBtn.classList.remove('hidden');
        }

        if (allRated) {
            finishBtn.disabled = false;
            finishBtn.classList.remove('bg-gray-400');
            finishBtn.classList.add('bg-teal-600', 'hover:bg-teal-700', 'text-white');
            finishBtn.innerHTML = '<i class="fa-solid fa-check-circle"></i> ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
        } else {
            finishBtn.disabled = true;
            finishBtn.innerHTML = '<span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô</span>';
        }

        document.getElementById('rateItemSelectorModal').classList.remove('hidden');
    }

    // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á
    function closeRateSelector() {
        document.getElementById('rateItemSelectorModal').classList.add('hidden');
        isMandatoryReview = false; // Reset flag
    }

    // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" (Mandatory Flow)
    function finishMandatoryRating() {
        closeRateSelector();
        showToast('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡∏ö! üôè');
        
        // ‡∏õ‡∏¥‡∏î LIFF ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (liff.isInClient()) {
            setTimeout(() => { liff.closeWindow(); }, 1000);
        }
    }

    // ‡∏õ‡∏£‡∏±‡∏ö Report ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Item Summary)
    function renderFeedbackSection() {
        const feedbacks = currentData.feedbackData || [];
        const container = document.getElementById('feedbackList');
        
        if (!container) return;

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Group by Item) ---
        const itemStats = {};
        feedbacks.forEach(f => {
            const name = f.item_name || 'Unknown';
            if (!itemStats[name]) {
                itemStats[name] = { sum: 0, count: 0, image: null };
            }
            itemStats[name].sum += Number(f.rating);
            itemStats[name].count += 1;
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ item_id ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if(!itemStats[name].image) {
                const ppe = currentData.ppeItems.find(p => p.id == f.item_id);
                if(ppe) itemStats[name].image = ppe.image_url;
            }
        });

        // ‡πÅ‡∏õ‡∏•‡∏á Object ‡πÄ‡∏õ‡πá‡∏ô Array ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
        const sortedItems = Object.keys(itemStats).map(key => {
            const s = itemStats[key];
            return {
                name: key,
                avg: (s.sum / s.count).toFixed(1),
                count: s.count,
                image: s.image
            };
        }).sort((a, b) => b.avg - a.avg); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏≤‡∏Å -> ‡∏ô‡πâ‡∏≠‡∏¢

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
        
        // 2.1 ‡πÅ‡∏™‡∏î‡∏á Top Rated List (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Avg Score ‡∏Å‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ)
        // ‡∏ú‡∏°‡∏à‡∏∞‡∏Ç‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Layout ‡∏Ç‡∏≠‡∏á HTML ‡∏™‡πà‡∏ß‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ (avgRatingScore) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
        const leftPanel = document.querySelector('#reportPage .bg-teal-50');
        if(leftPanel) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
            let rankingHtml = `<h4 class="font-bold text-teal-800 mb-3 text-left w-full"><i class="fa-solid fa-ranking-star mr-2"></i>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h4>
                               <div class="w-full space-y-2 max-h-[300px] overflow-y-auto pr-1">`;
            
            if(sortedItems.length === 0) {
                rankingHtml += `<p class="text-sm text-gray-500 text-center mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
            } else {
                sortedItems.forEach(item => {
                    const img = item.image || 'https://placehold.co/50?text=Item';
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏≤‡∏ß
                    let stars = '';
                    for(let i=1; i<=5; i++) {
                        stars += i <= Math.round(item.avg) ? '<i class="fa-solid fa-star text-yellow-400 text-[10px]"></i>' : '<i class="fa-regular fa-star text-gray-300 text-[10px]"></i>';
                    }

                    rankingHtml += `
                    <div class="flex items-center gap-2 bg-white p-2 rounded-lg shadow-sm border border-teal-100">
                        <img src="${img}" class="w-8 h-8 rounded object-cover bg-gray-50">
                        <div class="flex-1 min-w-0 text-left">
                            <p class="text-xs font-bold text-gray-700 truncate">${item.name}</p>
                            <div class="flex items-center gap-1">${stars} <span class="text-[10px] text-gray-400">(${item.count})</span></div>
                        </div>
                        <div class="text-sm font-bold text-teal-600 bg-teal-50 px-1.5 rounded">${item.avg}</div>
                    </div>`;
                });
            }
            rankingHtml += `</div>`;
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ panel ‡∏ã‡πâ‡∏≤‡∏¢
            leftPanel.innerHTML = rankingHtml;
            leftPanel.classList.remove('items-center', 'justify-center', 'text-center'); // ‡∏•‡∏ö class ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°
            leftPanel.classList.add('items-start'); 
        }

        // 2.2 ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Comment ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏ß‡∏≤) - ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
        if (feedbacks.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400 py-10 flex flex-col items-center"><i class="fa-regular fa-comment-dots text-4xl mb-2"></i><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</p></div>`;
            return;
        }

        container.innerHTML = feedbacks.map(f => {
            const date = new Date(f.created_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
            let userStars = '';
            for(let i=1; i<=5; i++) {
                userStars += i <= f.rating ? '<i class="fa-solid fa-star text-yellow-400 text-xs"></i>' : '<i class="fa-regular fa-star text-gray-300 text-xs"></i>';
            }
            const commentHtml = f.comment ? `<p class="text-sm text-gray-600 mt-1 bg-gray-50 p-2 rounded-lg border border-gray-100 italic">"${f.comment}"</p>` : '';

            return `
                <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex gap-3 hover:border-teal-200 transition-colors">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold shrink-0 text-xs">
                        ${f.user_name ? f.user_name.charAt(0).toUpperCase() : '?'}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs text-gray-500 font-bold">${f.user_name || 'Guest'}</p>
                                <p class="text-xs text-teal-600 font-medium bg-teal-50 px-1.5 py-0.5 rounded inline-block mt-0.5">
                                    ${f.item_name || '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'}
                                </p>
                            </div>
                            <div class="text-right">
                                <div class="flex gap-0.5">${userStars}</div>
                                <span class="text-[10px] text-gray-300">${date}</span>
                            </div>
                        </div>
                        ${commentHtml}
                    </div>
                </div>
            `;
        }).join('');
    }

    // ==========================================
    // üõ°Ô∏è PPE MATRIX SYSTEM LOGIC (UPDATED V2 FIXED)
    // ==========================================

    let tempMatrixItems = []; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÉ‡∏ô Modal

    function initMatrixPage() {
        renderJobTags();     // <--- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ
        renderMatrixGrid();
        
        // Populate Datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Stock)
        const datalist = document.getElementById('stockItemsList');
        if (datalist) {
            datalist.innerHTML = '';
            currentData.ppeItems.forEach(item => {
                datalist.innerHTML += `<option value="${item.name}" data-id="${item.id}">`;
            });
        }

        // Toggle ‡∏õ‡∏∏‡πà‡∏° Admin
        if (isAdmin) {
            document.getElementById('btnAddMatrixRule').classList.remove('hidden');
        } else {
            document.getElementById('btnAddMatrixRule').classList.add('hidden');
        }
    }

    // ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß) ‚≠ê
    function renderJobTags() {
        const container = document.getElementById('jobTagsContainer');
        const datalist = document.getElementById('jobSuggestions');
        if (!container) return;

        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Job ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Matrix ‡∏°‡∏≤‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° Filter
        const jobs = [...new Set((currentData.ppeMatrix || []).map(m => m.job_function))].sort();
        
        container.innerHTML = `<button onclick="filterMatrix('')" class="px-3 py-1 rounded-full text-xs font-medium bg-teal-600 text-white shadow-sm transition-transform active:scale-95">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;
        
        if (datalist) datalist.innerHTML = ''; 

        jobs.forEach(job => {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Tag
            container.innerHTML += `
                <button onclick="filterMatrix('${job}')" class="px-3 py-1 rounded-full text-xs font-medium bg-white border border-gray-200 text-gray-600 hover:bg-teal-50 hover:text-teal-700 hover:border-teal-200 transition-colors shadow-sm">
                    ${job}
                </button>`;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Datalist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡∏Å‡∏£‡∏≠‡∏Å‡∏á‡πà‡∏≤‡∏¢‡πÜ
            if (datalist) datalist.innerHTML += `<option value="${job}">`;
        });
    }

    function filterMatrix(jobName) {
        document.getElementById('matrixSearch').value = jobName;
        renderMatrixGrid();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î Matrix (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏≤‡∏¢ Item + ‡πÅ‡∏ú‡∏ô‡∏Å + Spec)
    function renderMatrixGrid() {
        const container = document.getElementById('matrixContentGrid');
        const emptyState = document.getElementById('matrixEmptyState');
        const search = document.getElementById('matrixSearch').value.toLowerCase();
        
        if (!container) return;
        
        let rules = currentData.ppeMatrix || [];

        // Filter
        if (search) {
            rules = rules.filter(r => 
                r.job_function.toLowerCase().includes(search) || 
                (r.department && r.department.toLowerCase().includes(search))
            );
        }

        if (rules.length === 0) {
            container.innerHTML = '';
            if(emptyState) emptyState.classList.remove('hidden');
            return;
        }

        if(emptyState) emptyState.classList.add('hidden');
        
        container.innerHTML = rules.map(rule => {
            // Unpack items_json (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Legacy data ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô item_id ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
            let items = rule.items_json;
            if (!items && rule.item_id) {
                // Legacy support
                const oldItem = currentData.ppeItems.find(i => i.id == rule.item_id);
                items = oldItem ? [{ name: oldItem.name, id: oldItem.id }] : [];
            }
            if (!Array.isArray(items)) items = [];

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î
            const itemsHtml = items.map(i => {
                const realItem = i.id ? currentData.ppeItems.find(p => p.id == i.id) : null;
                const img = realItem?.image_url || 'https://placehold.co/50?text=PPE';
                return `
                    <div class="flex items-center gap-2 bg-gray-50 p-1.5 rounded-lg border border-gray-100">
                        <img src="${img}" class="w-8 h-8 rounded object-cover bg-white">
                        <span class="text-xs text-gray-700 font-medium truncate">${i.name}</span>
                    </div>
                `;
            }).join('');

            const adminControls = isAdmin ? `
                <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/90 backdrop-blur rounded-lg p-1 shadow-sm border border-gray-100">
                    <button onclick="editMatrixRule(${rule.id})" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteMatrixRule(${rule.id})" class="p-1.5 text-red-600 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                </div>
            ` : '';

            return `
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all group relative overflow-hidden flex flex-col h-full">
                <div class="h-1.5 bg-teal-500 w-full"></div>
                <div class="p-4 flex-1 flex flex-col">
                    <div class="mb-3">
                        <div class="flex justify-between items-start">
                             <h4 class="font-bold text-gray-800 text-lg leading-tight mb-1">${rule.job_function}</h4>
                             ${adminControls}
                        </div>
                        <p class="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-0.5 rounded-md">
                            <i class="fa-solid fa-building-user mr-1"></i> ${rule.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </p>
                    </div>
                    
                    <div class="space-y-1 mb-3 flex-1">
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ</p>
                        ${itemsHtml || '<p class="text-xs text-gray-400">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</p>'}
                    </div>

                    ${rule.properties ? `
                    <div class="mb-3 p-2 bg-yellow-50 rounded border border-yellow-100 text-xs text-yellow-800">
                        <i class="fa-solid fa-circle-info mr-1"></i> Spec: ${rule.properties}
                    </div>` : ''}

                    <div class="pt-3 border-t border-gray-100 flex justify-between items-center text-xs">
                        <span class="text-gray-500">‡∏≠‡∏≤‡∏¢‡∏∏: <b>${rule.lifespan || '-'}</b></span>
                        <button onclick="showPage('issue');" class="text-teal-600 font-bold hover:underline">‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏•‡∏¢ <i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // --- Modal & Form Logic (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢ Item) ---

    function openMatrixModal(ruleId = null) {
        const modal = document.getElementById('matrixRuleModal');
        const form = document.getElementById('matrixRuleForm');
        
        // Reset
        form.reset();
        tempMatrixItems = []; // Clear temp list
        renderTempMatrixItems();

        if (ruleId) {
            // Edit Mode
            const rule = currentData.ppeMatrix.find(r => r.id == ruleId);
            document.getElementById('matrixId').value = rule.id;
            document.getElementById('matrixJob').value = rule.job_function;
            document.getElementById('matrixDept').value = rule.department || '';
            document.getElementById('matrixProps').value = rule.properties || '';
            document.getElementById('matrixLifespan').value = rule.lifespan || '';

            // Load Items
            if (rule.items_json) {
                tempMatrixItems = rule.items_json;
            } else if (rule.item_id) {
                // Legacy: load single item
                const oldItem = currentData.ppeItems.find(i => i.id == rule.item_id);
                if (oldItem) tempMatrixItems.push({ id: oldItem.id, name: oldItem.name });
            }
            renderTempMatrixItems();
        } else {
            document.getElementById('matrixId').value = '';
        }

        modal.classList.remove('hidden');
    }

    function addMatrixItem() {
        const input = document.getElementById('matrixItemInput');
        const name = input.value.trim();
        if (!name) return;

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Stock ‡πÑ‡∏´‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö ID
        const stockItem = currentData.ppeItems.find(i => i.name === name);
        const newItem = {
            id: stockItem ? stockItem.id : null, // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Stock ‡πÉ‡∏´‡πâ id=null (Manual text)
            name: name
        };

        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
        if (!tempMatrixItems.some(i => i.name === name)) {
            tempMatrixItems.push(newItem);
            renderTempMatrixItems();
        }
        
        input.value = ''; // Clear input
        input.focus();
    }

    function removeMatrixItem(index) {
        tempMatrixItems.splice(index, 1);
        renderTempMatrixItems();
    }

    function renderTempMatrixItems() {
        const container = document.getElementById('selectedMatrixItemsContainer');
        container.innerHTML = tempMatrixItems.map((item, index) => `
            <div class="flex justify-between items-center bg-white p-2 rounded border border-gray-200 shadow-sm text-sm">
                <span class="truncate"><i class="fa-solid fa-box mr-2 text-teal-500"></i>${item.name}</span>
                <button type="button" onclick="removeMatrixItem(${index})" class="text-red-500 hover:text-red-700 ml-2">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    async function saveMatrixRule(e) {
        e.preventDefault();
        
        if (tempMatrixItems.length === 0) {
            return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'error');
        }

        showLoading();
        
        const payload = {
            id: document.getElementById('matrixId').value || null,
            jobFunction: document.getElementById('matrixJob').value,
            department: document.getElementById('matrixDept').value,
            properties: document.getElementById('matrixProps').value,
            lifespan: document.getElementById('matrixLifespan').value,
            itemsJson: tempMatrixItems // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô Array
        };

        try {
            await callServerFunction('saveMatrixRule', payload);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            document.getElementById('matrixRuleModal').classList.add('hidden');
            
            // Reload Data
            const data = await callServerFunction('getInitialData');
            onDataLoaded(data);
            initMatrixPage(); 

        } catch (err) {
            console.error(err);
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        } finally {
            hideLoading();
        }
    }
    
    function editMatrixRule(id) {
        openMatrixModal(id);
    }

    async function deleteMatrixRule(id) {
        if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏é‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
        
        showLoading();
        try {
            await callServerFunction('deleteMatrixRule', { id });
            showToast('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            
            // Update Local Data (Optional optimization instead of full reload)
            currentData.ppeMatrix = currentData.ppeMatrix.filter(m => m.id != id);
            initMatrixPage();

        } catch (err) {
            showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        } finally {
            hideLoading();
        }
    }

</script>

</body>
</html>